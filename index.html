<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f0f1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Habit Tracker">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.svg">
    <link rel="icon" type="image/svg+xml" href="icon-192.svg">
    <title>Habit Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e2e8f0;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(135deg, #f472b6 0%, #c084fc 50%, #818cf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .current-view-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .view-label {
            font-size: 0.8rem;
            color: #64748b;
        }

        .view-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #f472b6;
        }

        .view-name.user-b {
            color: #c084fc;
        }

        .view-name.all {
            background: linear-gradient(135deg, #f472b6 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Global Progress Bar */
        .global-progress {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .global-progress:hover {
            border-color: rgba(244, 114, 182, 0.3);
        }

        .global-progress.active {
            border-color: rgba(244, 114, 182, 0.5);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.2);
        }

        .global-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .global-progress h3 {
            font-size: 0.9rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .global-progress-hint {
            font-size: 0.75rem;
            color: #64748b;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .global-progress:hover .global-progress-hint {
            opacity: 1;
        }

        .global-progress.active .global-progress-hint {
            opacity: 0;
        }

        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, #ec4899 0%, #f472b6 50%, #c084fc 100%);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.5);
        }

        .progress-text {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-top: 8px;
            text-align: right;
        }

        /* Main Layout */
        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Calendar */
        .calendar-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-nav button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calendar-nav button:hover {
            background: rgba(244, 114, 182, 0.2);
            border-color: rgba(244, 114, 182, 0.3);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-weekday {
            text-align: center;
            font-size: 0.75rem;
            color: #64748b;
            padding: 8px 0;
            font-weight: 500;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            color: #cbd5e1;
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .calendar-day.empty {
            cursor: default;
        }

        .calendar-day.empty:hover {
            background: transparent;
        }

        .calendar-day.today {
            font-weight: 600;
            border: 2px solid #f472b6;
            color: #f472b6;
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }

        .calendar-day.has-activity {
            background: rgba(244, 114, 182, 0.2);
        }

        .calendar-day.has-activity.selected {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        }

        /* Habits Section */
        .habits-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .habits-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .habits-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .selected-date {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .habits-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .habit-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .habit-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(244, 114, 182, 0.2);
        }

        .habit-item:hover .habit-actions {
            opacity: 1;
        }

        .habit-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .habit-action-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 0.8rem;
        }

        .habit-action-btn:hover {
            background: rgba(244, 114, 182, 0.2);
            color: #f472b6;
        }

        .habit-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .habit-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #475569;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .habit-checkbox.checked {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            border-color: #f472b6;
            color: white;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.4);
        }

        .habit-checkbox svg {
            width: 14px;
            height: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .habit-checkbox.checked svg {
            opacity: 1;
        }

        .habit-info {
            flex: 1;
            min-width: 0;
        }

        .habit-name {
            font-weight: 500;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e2e8f0;
        }

        .habit-owner {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .habit-owner.owner-A {
            background: rgba(236, 72, 153, 0.2);
            color: #f472b6;
        }

        .habit-owner.owner-B {
            background: rgba(168, 85, 247, 0.2);
            color: #c084fc;
        }

        .habit-owner.owner-shared {
            background: rgba(129, 140, 248, 0.2);
            color: #a5b4fc;
        }

        .habit-progress {
            margin-top: 6px;
        }

        .habit-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .habit-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
            background: linear-gradient(90deg, #ec4899 0%, #f472b6 100%);
        }

        .habit-progress-text {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 4px;
        }

        /* Numeric Input */
        .numeric-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .numeric-input {
            width: 60px;
            padding: 6px 8px;
            border: 2px solid #475569;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: center;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            -moz-appearance: textfield;
        }

        .numeric-input::-webkit-outer-spin-button,
        .numeric-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .numeric-input:focus {
            outline: none;
            border-color: #f472b6;
            box-shadow: 0 0 10px rgba(244, 114, 182, 0.3);
        }

        .numeric-input.completed {
            border-color: #f472b6;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2) 0%, rgba(244, 114, 182, 0.2) 100%);
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.4);
            color: #f9a8d4;
        }

        .numeric-input.incomplete {
            border-color: #f87171;
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.15) 0%, rgba(239, 68, 68, 0.15) 100%);
            box-shadow: 0 0 10px rgba(248, 113, 113, 0.3);
            color: #fca5a5;
        }

        .numeric-goal {
            font-size: 0.8rem;
            color: #64748b;
        }

        /* Target Progress Badge */
        .target-progress {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 8px;
            background: rgba(244, 114, 182, 0.15);
            border-radius: 12px;
            font-size: 0.7rem;
            color: #f472b6;
            margin-left: 8px;
        }

        .target-progress-bar {
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .target-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ec4899 0%, #f472b6 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Habit Detail Modal */
        .habit-detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .habit-detail-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .habit-detail-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .habit-detail-overlay.active .habit-detail-modal {
            transform: scale(1);
        }

        .habit-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .habit-detail-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .habit-detail-close {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .habit-detail-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .habit-detail-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .habit-stat {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .habit-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #f472b6 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .habit-stat-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 4px;
        }

        .habit-detail-calendar {
            margin-bottom: 16px;
        }

        .habit-detail-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .habit-detail-calendar-header h4 {
            font-size: 0.9rem;
            color: #94a3b8;
            margin: 0;
        }

        .habit-detail-nav {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .habit-detail-nav:hover {
            background: rgba(244, 114, 182, 0.2);
            color: #f472b6;
        }

        .habit-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .habit-calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #64748b;
            background: rgba(255, 255, 255, 0.03);
        }

        .habit-calendar-day.completed {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(236, 72, 153, 0.3);
        }

        .habit-calendar-day.missed {
            background: rgba(255, 255, 255, 0.05);
            color: #475569;
        }

        .habit-calendar-day.future {
            opacity: 0.3;
        }

        .habit-calendar-day.today {
            border: 2px solid #f472b6;
        }

        .habit-detail-legend {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 12px;
            font-size: 0.75rem;
            color: #64748b;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        .legend-dot.completed {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        }

        .legend-dot.missed {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Add Habit Form */
        .add-habit-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed #475569;
            border-radius: 12px;
            background: transparent;
            color: #94a3b8;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-habit-btn:hover {
            border-color: #f472b6;
            color: #f472b6;
            background: rgba(244, 114, 182, 0.1);
        }

        .add-habit-form {
            display: none;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-top: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .add-habit-form.active {
            display: flex;
        }

        .form-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 120px;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 4px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #475569;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #f472b6;
            box-shadow: 0 0 10px rgba(244, 114, 182, 0.3);
        }

        .form-group select option {
            background: #1a1a2e;
            color: #e2e8f0;
        }

        .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* User Progress */
        .user-progress {
            margin-top: 24px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .user-progress {
                grid-template-columns: 1fr;
            }
        }

        .user-progress-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-progress-card:hover {
            transform: translateY(-2px);
            border-color: rgba(244, 114, 182, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .user-progress-card[data-user="B"]:hover {
            border-color: rgba(168, 85, 247, 0.3);
        }

        .user-progress-card.active {
            border-color: rgba(244, 114, 182, 0.5);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.3);
        }

        .user-progress-card[data-user="B"].active {
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.3);
        }

        .user-profile-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: rgba(244, 114, 182, 0.2);
            color: #f472b6;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .user-profile-btn:hover {
            background: rgba(244, 114, 182, 0.4);
            transform: scale(1.1);
        }

        .user-profile-btn.user-b {
            background: rgba(168, 85, 247, 0.2);
            color: #c084fc;
        }

        .user-profile-btn.user-b:hover {
            background: rgba(168, 85, 247, 0.4);
        }

        .user-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2) 0%, rgba(244, 114, 182, 0.2) 100%);
            border: 2px solid rgba(244, 114, 182, 0.3);
            flex-shrink: 0;
        }

        .user-avatar.user-b {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(192, 132, 252, 0.2) 100%);
            border-color: rgba(192, 132, 252, 0.3);
        }

        .user-card-info {
            flex: 1;
            min-width: 0;
        }

        .user-card-info h3 {
            font-size: 1rem;
            color: #f1f5f9;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-level {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
            font-weight: 600;
        }

        .user-level.user-b {
            background: linear-gradient(135deg, #a855f7 0%, #c084fc 100%);
        }

        .user-xp-text {
            font-size: 0.75rem;
            color: #64748b;
        }

        .user-progress-card h3 .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Character Profile Modal */
        .profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .profile-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .profile-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 24px;
            padding: 0;
            max-width: 480px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .profile-overlay.active .profile-modal {
            transform: scale(1);
        }

        .profile-header {
            position: relative;
            padding: 30px 24px 60px;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.3) 0%, rgba(168, 85, 247, 0.2) 100%);
            border-radius: 24px 24px 0 0;
            text-align: center;
        }

        .profile-header.user-b {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.3) 0%, rgba(129, 140, 248, 0.2) 100%);
        }

        .profile-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .profile-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 4px solid rgba(244, 114, 182, 0.5);
            margin: 0 auto 16px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .profile-avatar:hover {
            transform: scale(1.05);
            border-color: #f472b6;
        }

        .profile-avatar.user-b {
            border-color: rgba(192, 132, 252, 0.5);
        }

        .profile-avatar.user-b:hover {
            border-color: #c084fc;
        }

        .profile-avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 4px;
        }

        .profile-title {
            font-size: 0.85rem;
            color: #94a3b8;
            font-style: italic;
        }

        .profile-level-badge {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 24px;
            border-radius: 20px;
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }

        .profile-level-badge.user-b {
            background: linear-gradient(135deg, #a855f7 0%, #c084fc 100%);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
        }

        .profile-content {
            padding: 36px 24px 24px;
        }

        .profile-xp-section {
            margin-bottom: 24px;
        }

        .profile-xp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .profile-xp-label {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .profile-xp-value {
            font-size: 0.85rem;
            color: #f472b6;
            font-weight: 600;
        }

        .profile-xp-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .profile-xp-fill {
            height: 100%;
            border-radius: 6px;
            background: linear-gradient(90deg, #ec4899 0%, #f472b6 50%, #c084fc 100%);
            transition: width 0.5s ease;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.5);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .profile-stat {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .profile-stat-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .profile-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #f1f5f9;
        }

        .profile-stat-label {
            font-size: 0.7rem;
            color: #64748b;
        }

        .profile-section {
            margin-bottom: 20px;
        }

        .profile-section-title {
            font-size: 0.8rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-superpower-single {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.12) 0%, rgba(168, 85, 247, 0.12) 100%);
            border: 1px solid rgba(244, 114, 182, 0.25);
            border-radius: 12px;
            padding: 14px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
        }

        .profile-superpower-single:hover {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%);
            border-color: rgba(244, 114, 182, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(244, 114, 182, 0.2);
        }

        .superpower-text {
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #f472b6 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .profile-superpower-single::after {
            content: 'âœŽ';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            color: #94a3b8;
            font-size: 0.85rem;
            transition: opacity 0.2s ease;
        }

        .profile-superpower-single:hover::after {
            opacity: 1;
        }

        /* Traits Grid - 5 slots */
        .profile-traits-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .trait-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 70px;
            justify-content: center;
        }

        .trait-slot:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(244, 114, 182, 0.3);
            transform: translateY(-2px);
        }

        .trait-slot.filled {
            background: linear-gradient(135deg, rgba(244, 114, 182, 0.1) 0%, rgba(192, 132, 252, 0.1) 100%);
            border-color: rgba(244, 114, 182, 0.2);
        }

        .trait-slot-icon {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }

        .trait-slot-text {
            font-size: 0.65rem;
            color: #94a3b8;
            text-align: center;
            line-height: 1.2;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .trait-slot.filled .trait-slot-text {
            color: #e2e8f0;
        }

        .trait-slot.empty {
            border-style: dashed;
        }

        .trait-slot.empty .trait-slot-icon {
            color: #475569;
        }

        /* Trait Picker Modal */
        .trait-picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .trait-picker-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .trait-picker {
            background: linear-gradient(135deg, rgba(15, 15, 26, 0.98) 0%, rgba(26, 26, 46, 0.98) 100%);
            border-radius: 16px;
            padding: 20px;
            max-width: 360px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .trait-picker-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            text-align: center;
            color: #f472b6;
        }

        .trait-picker-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            max-height: 200px;
            overflow-y: auto;
        }

        .trait-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .trait-option:hover {
            background: rgba(244, 114, 182, 0.15);
            border-color: rgba(244, 114, 182, 0.3);
        }

        .trait-option-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .trait-option-text {
            font-size: 0.7rem;
            color: #94a3b8;
            text-align: center;
        }

        .trait-picker-custom {
            display: flex;
            gap: 8px;
        }

        .trait-picker-custom input {
            flex: 1;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .trait-picker-custom input::placeholder {
            color: #64748b;
        }

        .trait-picker-custom button {
            padding: 10px 16px;
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .trait-picker-custom button:hover {
            transform: scale(1.05);
        }

        @media (max-width: 480px) {
            .profile-traits-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .profile-traits {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .profile-trait {
            padding: 6px 12px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
            color: #e2e8f0;
        }

        .profile-bio {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 12px;
            font-size: 0.85rem;
            color: #94a3b8;
            line-height: 1.6;
            font-style: italic;
        }

        .profile-edit-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed #475569;
            border-radius: 12px;
            background: transparent;
            color: #94a3b8;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 16px;
        }

        .profile-edit-btn:hover {
            border-color: #f472b6;
            color: #f472b6;
        }

        /* Emoji Picker */
        .emoji-picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .emoji-picker-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .emoji-picker {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 20px;
            max-width: 320px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .emoji-picker-title {
            font-size: 1rem;
            color: #f1f5f9;
            margin-bottom: 16px;
            text-align: center;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
        }

        .emoji-option {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-option:hover {
            background: rgba(244, 114, 182, 0.2);
            transform: scale(1.1);
        }

        /* Profile Edit Form */
        .profile-edit-form {
            display: none;
        }

        .profile-edit-form.active {
            display: block;
        }

        .profile-field {
            margin-bottom: 16px;
        }

        .profile-field label {
            display: block;
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 6px;
        }

        .profile-field input,
        .profile-field textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #475569;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .profile-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .profile-field input:focus,
        .profile-field textarea:focus {
            outline: none;
            border-color: #f472b6;
        }

        .profile-edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .user-progress-card h3 .dot.user-a {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            box-shadow: 0 0 10px rgba(236, 72, 153, 0.5);
        }

        .user-progress-card h3 .dot.user-b {
            background: linear-gradient(135deg, #a855f7 0%, #c084fc 100%);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state p {
            margin-bottom: 8px;
        }

        /* Motivational text */
        .motivation {
            text-align: center;
            padding: 16px;
            font-size: 0.9rem;
            color: #64748b;
            font-style: italic;
        }

        /* Glow effects */
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.3); }
            50% { box-shadow: 0 0 30px rgba(236, 72, 153, 0.5); }
        }

        .global-progress .progress-fill {
            animation: glow 3s ease-in-out infinite;
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 1.2rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .icon-btn:hover {
            background: rgba(244, 114, 182, 0.2);
            color: #f472b6;
            border-color: rgba(244, 114, 182, 0.3);
        }

        /* Apple-style Header Buttons */
        .header-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            position: relative;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #e2e8f0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .header-btn:active {
            transform: translateY(0);
            background: rgba(255, 255, 255, 0.1);
        }

        .header-btn svg {
            width: 18px;
            height: 18px;
            stroke-width: 1.5;
        }

        .header-btn .icon-sun {
            display: none;
        }

        .header-btn .icon-moon {
            display: block;
        }

        body.light-theme .header-btn .icon-sun {
            display: block;
        }

        body.light-theme .header-btn .icon-moon {
            display: none;
        }

        body.light-theme .header-btn {
            background: rgba(0, 0, 0, 0.04);
            color: #64748b;
            border-color: rgba(0, 0, 0, 0.06);
        }

        body.light-theme .header-btn:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #1e293b;
        }

        /* Clickable View Indicator with Dropdown */
        .current-view-indicator.clickable {
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .current-view-indicator.clickable:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(244, 114, 182, 0.3);
        }

        .view-cycle-icon {
            margin-left: 6px;
            color: #64748b;
            transition: all 0.3s ease;
        }

        .current-view-indicator:hover .view-cycle-icon {
            color: #f472b6;
            transform: rotate(180deg);
        }

        .current-view-indicator.flipping {
            animation: viewFlip 0.3s ease;
        }

        @keyframes viewFlip {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .current-view-indicator.flipping .view-cycle-icon {
            animation: iconSpin 0.3s ease;
        }

        @keyframes iconSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Clickable Avatar */
        .user-avatar.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-avatar.clickable:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(244, 114, 182, 0.4);
        }

        .user-avatar.user-b.clickable:hover {
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
        }

        /* Clickable User Name */
        .user-name-clickable {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .user-name-clickable:hover {
            color: #f472b6;
        }

        .user-name-clickable::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #f472b6 0%, #c084fc 100%);
            transition: width 0.2s ease;
        }

        .user-name-clickable:hover::after {
            width: 100%;
        }

        /* Clickable Habits Title */
        .habits-header h2 {
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .habits-header h2:hover {
            color: #f472b6;
        }

        .habits-header h2::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6'/%3E%3Cpolyline points='15 3 21 3 21 9'/%3E%3Cline x1='10' y1='14' x2='21' y2='3'/%3E%3C/svg%3E");
            background-size: contain;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .habits-header h2:hover::after {
            opacity: 1;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: relative;
        }

        /* Settings Panel */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .settings-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .settings-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .settings-overlay.active .settings-modal {
            transform: scale(1);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .settings-section {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .settings-section h4 {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .settings-row label {
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .settings-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        /* Pause Mode Banner */
        .pause-banner {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 12px;
        }

        .pause-banner.active {
            display: flex;
        }

        .pause-banner-icon {
            font-size: 1.5rem;
        }

        .pause-banner-text {
            flex: 1;
        }

        .pause-banner-text h4 {
            color: #fbbf24;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .pause-banner-text p {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .pause-banner-end {
            padding: 6px 12px;
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 8px;
            color: #fbbf24;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pause-banner-end:hover {
            background: rgba(251, 191, 36, 0.3);
        }

        /* Categories */
        .category-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(129, 140, 248, 0.2);
            color: #a5b4fc;
            margin-left: 6px;
        }

        .category-filter {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .category-chip {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .category-chip:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .category-chip.active {
            background: rgba(129, 140, 248, 0.2);
            color: #a5b4fc;
            border-color: rgba(129, 140, 248, 0.3);
        }

        /* Drag and Drop */
        .habit-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
        }

        .habit-item.drag-over {
            border-color: #f472b6;
            background: rgba(244, 114, 182, 0.1);
        }

        .habit-drag-handle {
            cursor: grab;
            color: #475569;
            padding: 4px;
            margin-right: 8px;
            font-size: 1rem;
            transition: color 0.2s;
        }

        .habit-drag-handle:hover {
            color: #94a3b8;
        }

        .habit-drag-handle:active {
            cursor: grabbing;
        }

        /* Analytics Modal */
        .analytics-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .analytics-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .analytics-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 24px;
            max-width: 700px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .analytics-overlay.active .analytics-modal {
            transform: scale(1);
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .analytics-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .analytics-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .analytics-tab {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .analytics-tab:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .analytics-tab.active {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
        }

        .analytics-content {
            min-height: 300px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 16px;
        }

        /* Bar Chart */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 150px;
            gap: 8px;
            padding-top: 20px;
        }

        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .bar {
            width: 100%;
            max-width: 40px;
            background: linear-gradient(180deg, #ec4899 0%, #f472b6 100%);
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
            min-height: 4px;
        }

        .bar-label {
            font-size: 0.7rem;
            color: #64748b;
        }

        .bar-value {
            font-size: 0.75rem;
            color: #94a3b8;
            position: absolute;
            top: -20px;
        }

        /* Heatmap */
        .heatmap {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }

        .heatmap-cell.level-1 { background: rgba(236, 72, 153, 0.2); }
        .heatmap-cell.level-2 { background: rgba(236, 72, 153, 0.4); }
        .heatmap-cell.level-3 { background: rgba(236, 72, 153, 0.6); }
        .heatmap-cell.level-4 { background: rgba(236, 72, 153, 0.8); }
        .heatmap-cell.level-5 { background: #ec4899; }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
            margin-top: 12px;
            font-size: 0.7rem;
            color: #64748b;
        }

        .heatmap-legend-cell {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-card-value {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #f472b6 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 4px;
        }

        /* Light Theme */
        body.light-theme {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
            color: #1e293b;
        }

        body.light-theme h1 {
            background: linear-gradient(135deg, #db2777 0%, #9333ea 50%, #6366f1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        body.light-theme .user-tab {
            background: rgba(0, 0, 0, 0.05);
            color: #64748b;
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .user-tab:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .user-tab.active {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
        }

        body.light-theme .global-progress,
        body.light-theme .calendar-section,
        body.light-theme .habits-section,
        body.light-theme .user-progress-card {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .global-progress h3,
        body.light-theme .progress-text {
            color: #64748b;
        }

        body.light-theme .calendar-header h2,
        body.light-theme .habits-header h2 {
            color: #1e293b;
        }

        body.light-theme .calendar-nav button {
            background: rgba(0, 0, 0, 0.05);
            color: #1e293b;
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .calendar-nav button:hover {
            background: rgba(236, 72, 153, 0.1);
        }

        body.light-theme .calendar-day {
            color: #475569;
        }

        body.light-theme .calendar-day:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        body.light-theme .calendar-day.has-activity {
            background: rgba(236, 72, 153, 0.15);
        }

        body.light-theme .habit-item {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.05);
        }

        body.light-theme .habit-item:hover {
            background: rgba(0, 0, 0, 0.06);
            border-color: rgba(236, 72, 153, 0.2);
        }

        body.light-theme .habit-name {
            color: #1e293b;
        }

        body.light-theme .habit-checkbox {
            border-color: #94a3b8;
        }

        body.light-theme .numeric-input {
            background: rgba(255, 255, 255, 0.8);
            border-color: #94a3b8;
            color: #1e293b;
        }

        body.light-theme .add-habit-btn {
            border-color: #94a3b8;
            color: #64748b;
        }

        body.light-theme .add-habit-btn:hover {
            border-color: #ec4899;
            color: #ec4899;
            background: rgba(236, 72, 153, 0.1);
        }

        body.light-theme .add-habit-form {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .form-group input,
        body.light-theme .form-group select {
            background: rgba(255, 255, 255, 0.8);
            border-color: #94a3b8;
            color: #1e293b;
        }

        body.light-theme .form-group select option {
            background: white;
            color: #1e293b;
        }

        body.light-theme .motivation {
            color: #64748b;
        }

        body.light-theme .icon-btn,
        body.light-theme .header-btn {
            background: rgba(0, 0, 0, 0.05);
            color: #64748b;
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .icon-btn:hover,
        body.light-theme .header-btn:hover {
            background: rgba(236, 72, 153, 0.1);
            color: #ec4899;
        }

        body.light-theme .settings-modal,
        body.light-theme .analytics-modal,
        body.light-theme .habit-detail-modal {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        body.light-theme .settings-section,
        body.light-theme .chart-container,
        body.light-theme .stat-card,
        body.light-theme .habit-stat {
            background: rgba(0, 0, 0, 0.03);
        }

        body.light-theme .settings-title,
        body.light-theme .analytics-title,
        body.light-theme .habit-detail-title {
            color: #1e293b;
        }

        body.light-theme .settings-row label {
            color: #1e293b;
        }

        body.light-theme .toggle-switch {
            background: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .analytics-tab {
            background: rgba(0, 0, 0, 0.05);
            color: #64748b;
        }

        body.light-theme .analytics-tab:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .pause-banner {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.15) 100%);
        }

        body.light-theme .habit-calendar-day {
            background: rgba(0, 0, 0, 0.03);
            color: #64748b;
        }

        body.light-theme .habit-calendar-day.missed {
            background: rgba(0, 0, 0, 0.05);
            color: #94a3b8;
        }

        body.light-theme .profile-modal {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        body.light-theme .profile-avatar {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        body.light-theme .profile-name {
            color: #1e293b;
        }

        body.light-theme .profile-stat {
            background: rgba(0, 0, 0, 0.03);
        }

        body.light-theme .profile-stat-value {
            color: #1e293b;
        }

        body.light-theme .profile-trait {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
            color: #1e293b;
        }

        body.light-theme .profile-bio {
            background: rgba(0, 0, 0, 0.03);
            color: #64748b;
        }

        body.light-theme .emoji-picker {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        body.light-theme .emoji-picker-title {
            color: #1e293b;
        }

        body.light-theme .emoji-option {
            background: rgba(0, 0, 0, 0.05);
        }

        body.light-theme .profile-field input,
        body.light-theme .profile-field textarea {
            background: rgba(255, 255, 255, 0.8);
            color: #1e293b;
            border-color: #94a3b8;
        }

        body.light-theme .user-card-info h3 {
            color: #1e293b;
        }

        body.light-theme .current-view-indicator {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .view-label {
            color: #64748b;
        }

        body.light-theme .global-progress-hint {
            color: #64748b;
        }

        /* ============ ACHIEVEMENTS SYSTEM ============ */
        .achievements-section {
            margin-top: 20px;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .achievement-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .achievement-item.locked {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .achievement-item.unlocked {
            background: linear-gradient(135deg, rgba(244, 114, 182, 0.1) 0%, rgba(192, 132, 252, 0.1) 100%);
            border-color: rgba(244, 114, 182, 0.3);
        }

        .achievement-item.unlocked:hover {
            transform: scale(1.05);
            border-color: rgba(244, 114, 182, 0.6);
            box-shadow: 0 0 20px rgba(244, 114, 182, 0.3);
        }

        .achievement-item.new {
            animation: achievementPulse 2s ease-in-out infinite;
        }

        @keyframes achievementPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(244, 114, 182, 0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(244, 114, 182, 0.6); }
        }

        .achievement-icon {
            font-size: 2rem;
            margin-bottom: 6px;
        }

        .achievement-name {
            font-size: 0.7rem;
            text-align: center;
            color: #94a3b8;
            line-height: 1.2;
        }

        .achievement-item.unlocked .achievement-name {
            color: #e2e8f0;
        }

        .achievement-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 15, 26, 0.95);
            border: 1px solid rgba(244, 114, 182, 0.3);
            border-radius: 8px;
            padding: 10px 12px;
            min-width: 180px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 100;
            pointer-events: none;
        }

        .achievement-item:hover .achievement-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .achievement-tooltip-title {
            font-weight: 600;
            color: #f472b6;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .achievement-tooltip-desc {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .achievement-tooltip-date {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ============ STREAK FIRE BADGES ============ */
        .streak-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .streak-badge.bronze {
            background: linear-gradient(135deg, #cd7f32 0%, #8b4513 100%);
            color: white;
        }

        .streak-badge.silver {
            background: linear-gradient(135deg, #c0c0c0 0%, #808080 100%);
            color: #1a1a2e;
        }

        .streak-badge.gold {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #1a1a2e;
            animation: goldGlow 2s ease-in-out infinite;
        }

        .streak-badge.diamond {
            background: linear-gradient(135deg, #b9f2ff 0%, #00bfff 50%, #87ceeb 100%);
            color: #1a1a2e;
            animation: diamondSparkle 1.5s ease-in-out infinite;
        }

        @keyframes goldGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
        }

        @keyframes diamondSparkle {
            0%, 100% { box-shadow: 0 0 10px rgba(0, 191, 255, 0.5); }
            50% { box-shadow: 0 0 25px rgba(0, 191, 255, 0.9); }
        }

        .habit-streak-indicator {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .habit-streak-indicator.fire-bronze { color: #cd7f32; }
        .habit-streak-indicator.fire-silver { color: #c0c0c0; }
        .habit-streak-indicator.fire-gold { color: #ffd700; text-shadow: 0 0 8px rgba(255, 215, 0, 0.5); }
        .habit-streak-indicator.fire-diamond { color: #00bfff; text-shadow: 0 0 8px rgba(0, 191, 255, 0.5); }

        /* ============ CONFETTI ANIMATION ============ */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            0% {
                opacity: 1;
                transform: translateY(-100%) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(100vh) rotate(720deg);
            }
        }

        /* ============ LEVEL UP ANIMATION ============ */
        .level-up-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .level-up-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .level-up-content {
            text-align: center;
            animation: levelUpBounce 0.6s ease-out;
        }

        @keyframes levelUpBounce {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .level-up-icon {
            font-size: 5rem;
            animation: levelUpSpin 1s ease-out;
        }

        @keyframes levelUpSpin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        .level-up-text {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #f472b6 0%, #c084fc 50%, #818cf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 16px 0;
        }

        .level-up-level {
            font-size: 4rem;
            font-weight: 800;
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }

        /* ============ ACHIEVEMENT UNLOCK POPUP ============ */
        .achievement-popup {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, rgba(15, 15, 26, 0.95) 0%, rgba(26, 26, 46, 0.95) 100%);
            border: 2px solid rgba(244, 114, 182, 0.5);
            border-radius: 16px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 10px 40px rgba(244, 114, 182, 0.3);
            z-index: 9998;
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .achievement-popup.show {
            transform: translateX(0);
        }

        .achievement-popup-icon {
            font-size: 2.5rem;
            animation: achievementBounce 0.6s ease-out;
        }

        @keyframes achievementBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .achievement-popup-content {
            display: flex;
            flex-direction: column;
        }

        .achievement-popup-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .achievement-popup-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f472b6;
        }

        /* ============ INLINE EDITING ============ */
        .inline-editable {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            position: relative;
        }

        .inline-editable:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .inline-editable::after {
            content: 'âœŽ';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            color: #64748b;
        }

        .inline-editable:hover::after {
            opacity: 1;
        }

        .inline-editable.editing {
            background: rgba(255, 255, 255, 0.15);
            padding: 0;
        }

        .inline-editable.editing::after {
            display: none;
        }

        .inline-edit-input {
            background: transparent;
            border: none;
            color: inherit;
            font: inherit;
            width: 100%;
            padding: 4px 8px;
            outline: none;
            border-radius: 6px;
        }

        .inline-edit-input:focus {
            box-shadow: 0 0 0 2px rgba(244, 114, 182, 0.5);
        }

        .inline-edit-textarea {
            background: transparent;
            border: none;
            color: inherit;
            font: inherit;
            width: 100%;
            padding: 8px;
            outline: none;
            border-radius: 6px;
            resize: vertical;
            min-height: 60px;
        }

        .inline-edit-textarea:focus {
            box-shadow: 0 0 0 2px rgba(244, 114, 182, 0.5);
        }

        .profile-name.inline-editable::after,
        .profile-title.inline-editable::after {
            right: -25px;
        }

        /* Traits inline editing */
        .profile-traits.editable {
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .profile-traits.editable:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .traits-edit-hint {
            display: none;
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 6px;
        }

        .profile-traits.editable:hover .traits-edit-hint {
            display: block;
        }

        /* ============ SOUND TOGGLE ============ */
        .sound-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .sound-toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.2s ease;
        }

        .sound-toggle:hover .sound-toggle-icon {
            transform: scale(1.1);
        }

        /* ============ JOINT CHALLENGES ============ */
        .challenges-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .challenges-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .challenges-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .challenge-item {
            background: linear-gradient(135deg, rgba(244, 114, 182, 0.1) 0%, rgba(192, 132, 252, 0.1) 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(244, 114, 182, 0.2);
        }

        .challenge-item:last-child {
            margin-bottom: 0;
        }

        .challenge-name {
            font-weight: 600;
            color: #f472b6;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .challenge-progress-container {
            margin: 12px 0;
        }

        .challenge-progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
        }

        .challenge-progress-a {
            height: 100%;
            background: linear-gradient(90deg, #ec4899 0%, #f472b6 100%);
            transition: width 0.5s ease;
        }

        .challenge-progress-b {
            height: 100%;
            background: linear-gradient(90deg, #a855f7 0%, #c084fc 100%);
            transition: width 0.5s ease;
        }

        .challenge-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 6px;
        }

        .challenge-deadline {
            font-size: 0.75rem;
            color: #64748b;
        }

        .add-challenge-btn {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .add-challenge-btn:hover {
            border-color: rgba(244, 114, 182, 0.5);
            background: rgba(244, 114, 182, 0.1);
            color: #f472b6;
        }

        /* Challenge Form */
        .challenge-form {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }

        .challenge-form.active {
            display: block;
        }

        .challenge-form .form-group {
            margin-bottom: 12px;
        }

        .challenge-form label {
            display: block;
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 6px;
        }

        .challenge-form input,
        .challenge-form select {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .challenge-form-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        /* Light theme adjustments */
        body.light-theme .achievement-item {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .achievement-item.unlocked {
            background: linear-gradient(135deg, rgba(244, 114, 182, 0.15) 0%, rgba(192, 132, 252, 0.15) 100%);
        }

        body.light-theme .achievement-tooltip {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(244, 114, 182, 0.3);
        }

        body.light-theme .achievement-tooltip-desc {
            color: #64748b;
        }

        body.light-theme .inline-editable:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        body.light-theme .challenge-item {
            background: linear-gradient(135deg, rgba(244, 114, 182, 0.08) 0%, rgba(192, 132, 252, 0.08) 100%);
        }

        body.light-theme .challenges-section {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.1);
        }

        /* ============ FULL HABITS DASHBOARD ============ */
        .dashboard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
        }

        .dashboard-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .dashboard-modal {
            background: linear-gradient(135deg, rgba(15, 15, 26, 0.98) 0%, rgba(26, 26, 46, 0.98) 100%);
            border-radius: 20px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
        }

        .dashboard-title {
            font-size: 1.4rem;
            font-weight: 600;
            background: linear-gradient(135deg, #f472b6 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dashboard-header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .dashboard-month-nav {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            color: #94a3b8;
        }

        .dashboard-nav-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.08);
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .dashboard-nav-btn:hover {
            background: rgba(244, 114, 182, 0.2);
            color: #f472b6;
        }

        .dashboard-close {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.2s ease;
        }

        .dashboard-close:hover {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .dashboard-content {
            flex: 1;
            overflow: auto;
            padding: 20px 24px;
        }

        .dashboard-table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .dashboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .dashboard-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .dashboard-table th {
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #94a3b8;
            font-weight: 500;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            white-space: nowrap;
        }

        .dashboard-table th:first-child {
            text-align: left;
            padding-left: 16px;
            min-width: 200px;
            position: sticky;
            left: 0;
            background: rgba(26, 26, 46, 0.98);
            z-index: 11;
        }

        .dashboard-table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            transition: background 0.2s ease;
        }

        .dashboard-table td:first-child {
            text-align: left;
            padding-left: 16px;
            position: sticky;
            left: 0;
            background: rgba(26, 26, 46, 0.98);
            z-index: 5;
        }

        .dashboard-table tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }

        .dashboard-table tr:hover td:first-child {
            background: rgba(26, 26, 46, 0.98);
        }

        .dashboard-habit-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-habit-name .habit-owner-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .dashboard-habit-name .habit-owner-dot.owner-A {
            background: #f472b6;
        }

        .dashboard-habit-name .habit-owner-dot.owner-B {
            background: #a855f7;
        }

        .dashboard-habit-name .habit-owner-dot.owner-shared {
            background: linear-gradient(135deg, #f472b6 50%, #a855f7 50%);
        }

        .dashboard-cell {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dashboard-cell.completed {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .dashboard-cell.partial {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
        }

        .dashboard-cell.missed {
            background: rgba(255, 255, 255, 0.05);
            color: #475569;
        }

        .dashboard-cell.future {
            background: transparent;
            color: #334155;
        }

        .dashboard-cell.today {
            box-shadow: 0 0 0 2px #f472b6;
        }

        .dashboard-cell:hover:not(.future) {
            transform: scale(1.15);
        }

        .dashboard-legend {
            display: flex;
            justify-content: center;
            gap: 24px;
            padding: 16px 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.02);
        }

        .dashboard-legend .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .dashboard-legend .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }

        .dashboard-legend .legend-dot.completed {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }

        .dashboard-legend .legend-dot.partial {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }

        .dashboard-legend .legend-dot.missed {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Light theme dashboard */
        body.light-theme .dashboard-modal {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }

        body.light-theme .dashboard-header {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.08);
        }

        body.light-theme .dashboard-table th {
            background: rgba(0, 0, 0, 0.03);
            color: #64748b;
        }

        body.light-theme .dashboard-table th:first-child,
        body.light-theme .dashboard-table td:first-child {
            background: #f8fafc;
        }

        body.light-theme .dashboard-table td {
            border-color: rgba(0, 0, 0, 0.05);
        }

        body.light-theme .dashboard-cell.missed {
            background: rgba(0, 0, 0, 0.05);
        }

        /* Responsive dashboard */
        @media (max-width: 768px) {
            .dashboard-modal {
                max-height: 95vh;
                border-radius: 16px;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 12px;
                padding: 16px;
            }

            .dashboard-content {
                padding: 12px;
            }

            .dashboard-table th:first-child,
            .dashboard-table td:first-child {
                min-width: 140px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Habit Tracker</h1>
            <div class="current-view-indicator clickable" id="currentViewIndicator" onclick="cycleView()">
                <span class="view-label">ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€:</span>
                <span class="view-name" id="currentViewName">Ð’ÑÐµ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ¸</span>
                <svg class="view-cycle-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="analyticsBtn" title="ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ°">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 20V10"></path>
                        <path d="M12 20V4"></path>
                        <path d="M6 20v-6"></path>
                    </svg>
                </button>
                <button class="header-btn" id="themeToggle" title="Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ñ‚ÐµÐ¼Ñƒ">
                    <svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <button class="header-btn" id="settingsBtn" title="ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Pause Mode Banner -->
        <div class="pause-banner" id="pauseBanner">
            <div class="pause-banner-icon">ðŸ–ï¸</div>
            <div class="pause-banner-text">
                <h4>Ð ÐµÐ¶Ð¸Ð¼ Ð¾Ñ‚Ð¿ÑƒÑÐºÐ°</h4>
                <p>ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐµÐº Ð¿Ñ€Ð¸Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾. ÐžÑ‚Ð´Ñ‹Ñ…Ð°Ð¹!</p>
            </div>
            <button class="pause-banner-end" id="endPauseBtn">Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ</button>
        </div>

        <div class="global-progress" id="globalProgressCard" onclick="switchUserView('all')" style="cursor: pointer;">
            <div class="global-progress-header">
                <h3>ðŸ’• ÐžÐ±Ñ‰Ð¸Ð¹ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ</h3>
                <span class="global-progress-hint" id="globalProgressHint">ÐÐ°Ð¶Ð¼Ð¸ Ð´Ð»Ñ Ð¾Ð±Ñ‰ÐµÐ³Ð¾ Ð²Ð¸Ð´Ð°</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="globalProgressFill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="globalProgressText">0%</div>
        </div>

        <div class="main-content">
            <div class="calendar-section">
                <div class="calendar-header">
                    <h2 id="calendarTitle">Ð¯Ð½Ð²Ð°Ñ€ÑŒ 2026</h2>
                    <div class="calendar-nav">
                        <button id="prevMonth">â†</button>
                        <button id="nextMonth">â†’</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>

            <div class="habits-section">
                <div class="habits-header">
                    <h2 onclick="openHabitsDashboard()" title="ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´">ÐŸÑ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ¸</h2>
                    <span class="selected-date" id="selectedDateText">Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ</span>
                </div>
                
                <div class="category-filter" id="categoryFilter"></div>
                
                <div class="habits-list" id="habitsList"></div>
                
                <button class="add-habit-btn" id="addHabitBtn">+ Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÑƒ</button>
                
                <div class="add-habit-form" id="addHabitForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ</label>
                            <input type="text" id="habitName" placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: ÐœÐµÐ´Ð¸Ñ‚Ð°Ñ†Ð¸Ñ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ð¢Ð¸Ð¿</label>
                            <select id="habitType">
                                <option value="binary">Ð”Ð°/ÐÐµÑ‚</option>
                                <option value="numeric">ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾</option>
                            </select>
                        </div>
                        <div class="form-group" id="goalGroup" style="display: none;">
                            <label>Ð¦ÐµÐ»ÑŒ</label>
                            <input type="number" id="habitGoal" placeholder="10" min="1">
                        </div>
                        <div class="form-group" id="goalTypeGroup" style="display: none;">
                            <label>ÐŸÐµÑ€Ð¸Ð¾Ð´ Ñ†ÐµÐ»Ð¸</label>
                            <select id="habitGoalType">
                                <option value="daily">Ð’ Ð´ÐµÐ½ÑŒ</option>
                                <option value="week">Ð’ Ð½ÐµÐ´ÐµÐ»ÑŽ</option>
                                <option value="month">Ð’ Ð¼ÐµÑÑÑ†</option>
                                <option value="quarter">Ð’ ÐºÐ²Ð°Ñ€Ñ‚Ð°Ð»</option>
                                <option value="year">Ð’ Ð³Ð¾Ð´</option>
                                <option value="custom">Ð¡Ð²Ð¾Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´</option>
                            </select>
                        </div>
                        <div class="form-group" id="customPeriodGroup" style="display: none;">
                            <label>Ð”Ð½ÐµÐ¹ Ð² Ð¿ÐµÑ€Ð¸Ð¾Ð´Ðµ</label>
                            <input type="number" id="habitCustomPeriod" placeholder="50" min="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ÐŸÐµÑ€Ð¸Ð¾Ð´</label>
                            <select id="habitPeriod">
                                <option value="week">ÐÐµÐ´ÐµÐ»Ñ</option>
                                <option value="month">ÐœÐµÑÑÑ†</option>
                                <option value="all">Ð’ÑÑ‘ Ð²Ñ€ÐµÐ¼Ñ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ð’Ð»Ð°Ð´ÐµÐ»ÐµÑ†</label>
                            <select id="habitOwner">
                                <option value="shared">ÐžÐ±Ñ‰Ð°Ñ</option>
                                <option value="A">Ð”Ð¸Ð¼Ð¾Ñ‡ÐºÐ° ðŸ¦Š</option>
                                <option value="B">Ð”Ð°ÑˆÐµÐ½ÑŒÐºÐ° ðŸ¦‹</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ÐžÐ±Ñ‰Ð°Ñ Ñ†ÐµÐ»ÑŒ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)</label>
                            <input type="number" id="habitTarget" placeholder="100 Ð¼ÐµÐ´Ð¸Ñ‚Ð°Ñ†Ð¸Ð¹ Ð·Ð° Ð³Ð¾Ð´" min="1">
                        </div>
                        <div class="form-group">
                            <label>ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)</label>
                            <input type="text" id="habitCategory" placeholder="Ð—Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ, Ð¡Ð¿Ð¾Ñ€Ñ‚..." list="categoryList">
                            <datalist id="categoryList"></datalist>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" id="cancelHabit">ÐžÑ‚Ð¼ÐµÐ½Ð°</button>
                        <button class="btn btn-primary" id="saveHabit">Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Joint Challenges Section -->
        <div class="challenges-section" id="challengesSection">
            <div class="challenges-header">
                <div class="challenges-title">ðŸ¤ Ð¡Ð¾Ð²Ð¼ÐµÑÑ‚Ð½Ñ‹Ðµ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶Ð¸</div>
            </div>
            <div id="challengesList"></div>
            <button class="add-challenge-btn" id="addChallengeBtn">+ Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶</button>
            <div class="challenge-form" id="challengeForm">
                <div class="form-group">
                    <label>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶Ð°</label>
                    <input type="text" id="challengeName" placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 100ÐºÐ¼ Ð²Ð¼ÐµÑÑ‚Ðµ">
                </div>
                <div class="form-group">
                    <label>Ð¦ÐµÐ»ÑŒ (Ñ‡Ð¸ÑÐ»Ð¾)</label>
                    <input type="number" id="challengeGoal" placeholder="100" min="1">
                </div>
                <div class="form-group">
                    <label>Ð•Ð´Ð¸Ð½Ð¸Ñ†Ð° Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ</label>
                    <input type="text" id="challengeUnit" placeholder="ÐºÐ¼, Ñ€Ð°Ð·, Ð¼Ð¸Ð½ÑƒÑ‚...">
                </div>
                <div class="form-group">
                    <label>Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ (Ð´Ð½ÐµÐ¹)</label>
                    <input type="number" id="challengeDuration" placeholder="30" min="1">
                </div>
                <div class="challenge-form-actions">
                    <button class="btn btn-secondary" id="cancelChallenge">ÐžÑ‚Ð¼ÐµÐ½Ð°</button>
                    <button class="btn btn-primary" id="saveChallenge">Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ</button>
                </div>
            </div>
        </div>

        <div class="user-progress">
            <div class="user-progress-card" data-user="A" id="userCardA" onclick="switchUserView('A')">
                <div class="user-card-header">
                    <div class="user-avatar clickable" id="userAAvatar" onclick="event.stopPropagation(); showProfile('A')" title="ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ">ðŸ¦Š</div>
                    <div class="user-card-info">
                        <h3>
                            <span id="userAName" class="user-name-clickable" onclick="event.stopPropagation(); showProfile('A')" title="ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ">Ð”Ð¸Ð¼Ð¾Ñ‡ÐºÐ°</span>
                            <span class="user-level" id="userALevel">Ð£Ñ€. 1</span>
                        </h3>
                        <div class="user-xp-text" id="userAXpText">0 / 100 XP</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="userAProgress" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="userAProgressText">0%</div>
            </div>
            <div class="user-progress-card" data-user="B" id="userCardB" onclick="switchUserView('B')">
                <div class="user-card-header">
                    <div class="user-avatar user-b clickable" id="userBAvatar" onclick="event.stopPropagation(); showProfile('B')" title="ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ">ðŸ¦‹</div>
                    <div class="user-card-info">
                        <h3>
                            <span id="userBName" class="user-name-clickable" onclick="event.stopPropagation(); showProfile('B')" title="ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ">Ð”Ð°ÑˆÐµÐ½ÑŒÐºÐ°</span>
                            <span class="user-level user-b" id="userBLevel">Ð£Ñ€. 1</span>
                        </h3>
                        <div class="user-xp-text" id="userBXpText">0 / 100 XP</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="userBProgress" style="width: 0%; background: linear-gradient(90deg, #a855f7 0%, #c084fc 100%);"></div>
                </div>
                <div class="progress-text" id="userBProgressText">0%</div>
            </div>
        </div>

        <div class="motivation" id="motivation">
            Ð›ÑƒÑ‡ÑˆÐµ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾, Ñ‡ÐµÐ¼ Ð¸Ð´ÐµÐ°Ð»ÑŒÐ½Ð¾. ÐšÐ°Ð¶Ð´Ñ‹Ð¹ ÑˆÐ°Ð³ â€” ÑÑ‚Ð¾ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ.
        </div>
    </div>

    <!-- Habit Detail Modal -->
    <div class="habit-detail-overlay" id="habitDetailOverlay">
        <div class="habit-detail-modal">
            <div class="habit-detail-header">
                <div class="habit-detail-title" id="habitDetailTitle">ÐŸÑ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ°</div>
                <button class="habit-detail-close" id="habitDetailClose">Ã—</button>
            </div>
            <div class="habit-detail-stats" id="habitDetailStats"></div>
            <div class="habit-detail-calendar">
                <div class="habit-detail-calendar-header">
                    <button class="habit-detail-nav" id="habitDetailPrevMonth">â†</button>
                    <h4 id="habitDetailCalendarTitle">Ð¯Ð½Ð²Ð°Ñ€ÑŒ 2026</h4>
                    <button class="habit-detail-nav" id="habitDetailNextMonth">â†’</button>
                </div>
                <div class="habit-calendar-grid" id="habitDetailCalendarGrid"></div>
                <div class="habit-detail-legend">
                    <div class="legend-item"><div class="legend-dot completed"></div> Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾</div>
                    <div class="legend-item"><div class="legend-dot missed"></div> ÐŸÑ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð¾</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-modal">
            <div class="settings-header">
                <div class="settings-title">âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸</div>
                <button class="habit-detail-close" id="settingsClose">Ã—</button>
            </div>
            
            <div class="settings-section">
                <h4>ðŸ–ï¸ Ð ÐµÐ¶Ð¸Ð¼ Ð¿Ð°ÑƒÐ·Ñ‹</h4>
                <div class="settings-row">
                    <label>Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ñ€ÐµÐ¶Ð¸Ð¼ Ð¾Ñ‚Ð¿ÑƒÑÐºÐ°</label>
                    <div class="toggle-switch" id="pauseToggle"></div>
                </div>
                <p style="font-size: 0.8rem; color: #64748b; margin-top: 8px;">
                    ÐŸÑ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð½Ð¸ Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ð¿Ð°ÑƒÐ·Ñ‹ Ð½Ðµ ÑÑ‡Ð¸Ñ‚Ð°ÑŽÑ‚ÑÑ Ð¿Ñ€Ð¾Ð²Ð°Ð»Ð¾Ð¼
                </p>
            </div>
            
            <div class="settings-section">
                <h4>ðŸ’¾ Ð”Ð°Ð½Ð½Ñ‹Ðµ</h4>
                <div class="settings-buttons">
                    <button class="btn btn-secondary" id="exportDataBtn">ðŸ“¤ Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚</button>
                    <button class="btn btn-secondary" id="importDataBtn">ðŸ“¥ Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚</button>
                    <input type="file" id="importFileInput" accept=".json" style="display: none;">
                </div>
                <p style="font-size: 0.8rem; color: #64748b; margin-top: 8px;">
                    Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐ¹ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¸Ð»Ð¸ Ð¿ÐµÑ€ÐµÐ½Ð¾ÑÐ° Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾
                </p>
            </div>
            
            <div class="settings-section">
                <h4>ðŸŽ¨ Ð’Ð½ÐµÑˆÐ½Ð¸Ð¹ Ð²Ð¸Ð´</h4>
                <div class="settings-row">
                    <label>Ð¡Ð²ÐµÑ‚Ð»Ð°Ñ Ñ‚ÐµÐ¼Ð°</label>
                    <div class="toggle-switch" id="themeToggleSettings"></div>
                </div>
            </div>
            
            <div class="settings-section">
                <h4>ðŸ”Š Ð—Ð²ÑƒÐºÐ¸</h4>
                <div class="settings-row">
                    <label>Ð—Ð²ÑƒÐºÐ¾Ð²Ñ‹Ðµ ÑÑ„Ñ„ÐµÐºÑ‚Ñ‹</label>
                    <div class="sound-toggle" onclick="toggleSound()">
                        <span class="sound-toggle-icon" id="soundToggle">ðŸ”Š</span>
                    </div>
                </div>
                <p style="font-size: 0.8rem; color: #64748b; margin-top: 8px;">
                    Ð—Ð²ÑƒÐºÐ¸ Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐµÐº, Ð¿Ð¾Ð²Ñ‹ÑˆÐµÐ½Ð¸Ð¸ ÑƒÑ€Ð¾Ð²Ð½Ñ Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ð¹
                </p>
            </div>
            
            <div class="settings-section">
                <h4>ðŸ—‘ï¸ ÐžÐ¿Ð°ÑÐ½Ð°Ñ Ð·Ð¾Ð½Ð°</h4>
                <div class="settings-buttons">
                    <button class="btn btn-secondary" id="resetProgressBtn" style="color: #f87171;">Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ</button>
                    <button class="btn btn-secondary" id="deleteAllBtn" style="color: #f87171;">Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²ÑÑ‘</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div class="analytics-overlay" id="analyticsOverlay">
        <div class="analytics-modal">
            <div class="analytics-header">
                <div class="analytics-title">ðŸ“Š ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ°</div>
                <button class="habit-detail-close" id="analyticsClose">Ã—</button>
            </div>
            
            <div class="stats-grid" id="analyticsStats"></div>
            
            <div class="analytics-tabs">
                <button class="analytics-tab active" data-tab="weekly">ÐÐµÐ´ÐµÐ»Ñ</button>
                <button class="analytics-tab" data-tab="monthly">ÐœÐµÑÑÑ†</button>
                <button class="analytics-tab" data-tab="heatmap">Ð¢ÐµÐ¿Ð»Ð¾Ð²Ð°Ñ ÐºÐ°Ñ€Ñ‚Ð°</button>
            </div>
            
            <div class="analytics-content" id="analyticsContent"></div>
        </div>
    </div>

    <!-- Character Profile Modal -->
    <div class="profile-overlay" id="profileOverlay">
        <div class="profile-modal">
            <div class="profile-header" id="profileHeader">
                <button class="profile-close" id="profileClose">Ã—</button>
                <div class="profile-avatar" id="profileAvatar" onclick="openEmojiPicker()">
                    ðŸ¦Š
                    <div class="profile-avatar-edit">âœŽ</div>
                </div>
                <div class="profile-name inline-editable" id="profileName" onclick="startInlineEdit(this, 'name')" title="ÐÐ°Ð¶Ð¼Ð¸ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ">Ð”Ð¸Ð¼Ð¾Ñ‡ÐºÐ°</div>
                <div class="profile-title inline-editable" id="profileTitle" onclick="startInlineEdit(this, 'title')" title="ÐÐ°Ð¶Ð¼Ð¸ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ">ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽÑ‰Ð¸Ð¹ Ð³ÐµÑ€Ð¾Ð¹</div>
                <div class="profile-level-badge" id="profileLevelBadge">Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ 1</div>
            </div>
            
            <div class="profile-content">
                <!-- XP Progress -->
                <div class="profile-xp-section">
                    <div class="profile-xp-header">
                        <span class="profile-xp-label">ÐžÐ¿Ñ‹Ñ‚</span>
                        <span class="profile-xp-value" id="profileXpValue">0 / 100 XP</span>
                    </div>
                    <div class="profile-xp-bar">
                        <div class="profile-xp-fill" id="profileXpFill" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="profile-stats" id="profileStats">
                    <div class="profile-stat">
                        <div class="profile-stat-icon">ðŸ”¥</div>
                        <div class="profile-stat-value" id="profileStreak">0</div>
                        <div class="profile-stat-label">Ð¡ÐµÑ€Ð¸Ñ Ð´Ð½ÐµÐ¹</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-icon">âœ…</div>
                        <div class="profile-stat-value" id="profileCompleted">0</div>
                        <div class="profile-stat-label">Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-icon">ðŸ“…</div>
                        <div class="profile-stat-value" id="profileDays">0</div>
                        <div class="profile-stat-label">ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð´Ð½ÐµÐ¹</div>
                    </div>
                </div>
                
                <!-- Inline Editable Profile -->
                <div id="profileViewMode">
                    <!-- Superpower (single line) -->
                    <div class="profile-section">
                        <div class="profile-section-title">âš¡ Ð¡ÑƒÐ¿ÐµÑ€ÑÐ¸Ð»Ð°</div>
                        <div class="profile-superpower-single" id="profileSuperpower" onclick="editSuperpower()" title="ÐÐ°Ð¶Ð¼Ð¸ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ">
                            <span class="superpower-text" id="superpowerText">ÐÐµÑÐ¾ÐºÑ€ÑƒÑˆÐ¸Ð¼Ð°Ñ Ð²Ð¾Ð»Ñ</span>
                        </div>
                    </div>
                    
                    <!-- Traits (5 badges) -->
                    <div class="profile-section">
                        <div class="profile-section-title">ðŸ·ï¸ Ð§ÐµÑ€Ñ‚Ñ‹ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð°</div>
                        <div class="profile-traits-grid" id="profileTraits">
                            <!-- 5 trait slots will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Bio -->
                    <div class="profile-section">
                        <div class="profile-section-title">ðŸ“ Ðž ÑÐµÐ±Ðµ</div>
                        <div class="profile-bio inline-editable" id="profileBio" onclick="startInlineEdit(this, 'bio', true)" title="ÐÐ°Ð¶Ð¼Ð¸ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ">
                            Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¾ ÑÐµÐ±Ðµ...
                        </div>
                    </div>
                    
                    <!-- Achievements Section (NOT editable) -->
                    <div class="profile-section achievements-section">
                        <div class="profile-section-title">ðŸ† Ð”Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ</div>
                        <div class="achievements-grid" id="achievementsGrid">
                            <!-- Achievements will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emoji Picker -->
    <div class="emoji-picker-overlay" id="emojiPickerOverlay">
        <div class="emoji-picker">
            <div class="emoji-picker-title">Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð°Ð²Ð°Ñ‚Ð°Ñ€</div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
    </div>

    <!-- Trait Picker -->
    <div class="trait-picker-overlay" id="traitPickerOverlay">
        <div class="trait-picker">
            <div class="trait-picker-title">Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ñ‡ÐµÑ€Ñ‚Ñƒ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð°</div>
            <div class="trait-picker-options" id="traitPickerOptions"></div>
            <div class="trait-picker-custom">
                <input type="text" id="customTraitInput" placeholder="Ð˜Ð»Ð¸ Ð½Ð°Ð¿Ð¸ÑˆÐ¸ ÑÐ²Ð¾ÑŽ...">
                <button onclick="saveCustomTrait()">OK</button>
            </div>
        </div>
    </div>

    <!-- Full Habits Dashboard Modal -->
    <div class="dashboard-overlay" id="dashboardOverlay">
        <div class="dashboard-modal">
            <div class="dashboard-header">
                <div class="dashboard-title">ðŸ“‹ Ð’ÑÐµ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ¸</div>
                <div class="dashboard-header-actions">
                    <div class="dashboard-month-nav">
                        <button class="dashboard-nav-btn" id="dashboardPrevMonth">â†</button>
                        <span id="dashboardMonthTitle">Ð¯Ð½Ð²Ð°Ñ€ÑŒ 2026</span>
                        <button class="dashboard-nav-btn" id="dashboardNextMonth">â†’</button>
                    </div>
                    <button class="dashboard-close" id="dashboardClose">Ã—</button>
                </div>
            </div>
            <div class="dashboard-content">
                <div class="dashboard-table-wrapper">
                    <table class="dashboard-table" id="dashboardTable">
                        <thead id="dashboardTableHead"></thead>
                        <tbody id="dashboardTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="dashboard-legend">
                <div class="legend-item"><div class="legend-dot completed"></div> Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾</div>
                <div class="legend-item"><div class="legend-dot partial"></div> Ð§Ð°ÑÑ‚Ð¸Ñ‡Ð½Ð¾</div>
                <div class="legend-item"><div class="legend-dot missed"></div> ÐŸÑ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð¾</div>
            </div>
        </div>
    </div>

    <!-- Level Up Overlay -->
    <div class="level-up-overlay" id="levelUpOverlay" onclick="closeLevelUp()">
        <div class="level-up-content">
            <div class="level-up-icon">ðŸŽ‰</div>
            <div class="level-up-text">ÐÐ¾Ð²Ñ‹Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ!</div>
            <div class="level-up-level" id="levelUpLevel">2</div>
        </div>
    </div>

    <!-- Achievement Popup -->
    <div class="achievement-popup" id="achievementPopup">
        <div class="achievement-popup-icon" id="achievementPopupIcon">ðŸ†</div>
        <div class="achievement-popup-content">
            <div class="achievement-popup-label">Ð”Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¾!</div>
            <div class="achievement-popup-title" id="achievementPopupTitle">ÐŸÐµÑ€Ð²Ñ‹Ðµ ÑˆÐ°Ð³Ð¸</div>
        </div>
    </div>

    <!-- Confetti Container -->
    <div class="confetti-container" id="confettiContainer"></div>

    <script>
        // ============ DATA LAYER ============
        const STORAGE_KEY = 'habit_tracker_data';
        const SETTINGS_KEY = 'habit_tracker_settings';
        const PROFILES_KEY = 'habit_tracker_profiles';
        
        const defaultData = {
            habits: [],
            entries: {},
            globalXP: 0,
            pausedDays: [] // Array of date strings when pause mode was active
        };

        const defaultSettings = {
            theme: 'dark',
            pauseMode: false,
            pauseStartDate: null
        };

        const defaultProfiles = {
            A: {
                name: 'Ð”Ð¸Ð¼Ð¾Ñ‡ÐºÐ°',
                avatar: 'ðŸ¦Š',
                title: 'ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽÑ‰Ð¸Ð¹ Ð³ÐµÑ€Ð¾Ð¹',
                superpower: 'ÐÐµÑÐ¾ÐºÑ€ÑƒÑˆÐ¸Ð¼Ð°Ñ Ð²Ð¾Ð»Ñ',
                traits: [
                    { icon: 'ðŸ’ª', text: 'Ð¡Ð¸Ð»Ð° Ð²Ð¾Ð»Ð¸' },
                    { icon: 'ðŸŽ¯', text: 'Ð¤Ð¾ÐºÑƒÑ' },
                    null, null, null
                ],
                bio: 'Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¾ ÑÐµÐ±Ðµ...',
                xp: 0,
                level: 1
            },
            B: {
                name: 'Ð”Ð°ÑˆÐµÐ½ÑŒÐºÐ°',
                avatar: 'ðŸ¦‹',
                title: 'ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽÑ‰Ð¸Ð¹ Ð³ÐµÑ€Ð¾Ð¹',
                superpower: 'Ð‘ÐµÑÐºÐ¾Ð½ÐµÑ‡Ð½Ð°Ñ ÑÐ½ÐµÑ€Ð³Ð¸Ñ',
                traits: [
                    { icon: 'âœ¨', text: 'ÐŸÐ¾Ð·Ð¸Ñ‚Ð¸Ð²' },
                    { icon: 'ðŸ’•', text: 'Ð—Ð°Ð±Ð¾Ñ‚Ð°' },
                    null, null, null
                ],
                bio: 'Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¾ ÑÐµÐ±Ðµ...',
                xp: 0,
                level: 1
            }
        };

        // Predefined trait options
        const TRAIT_OPTIONS = [
            { icon: 'ðŸ’ª', text: 'Ð¡Ð¸Ð»Ð° Ð²Ð¾Ð»Ð¸' },
            { icon: 'ðŸŽ¯', text: 'Ð¤Ð¾ÐºÑƒÑ' },
            { icon: 'âœ¨', text: 'ÐŸÐ¾Ð·Ð¸Ñ‚Ð¸Ð²' },
            { icon: 'ðŸ’•', text: 'Ð—Ð°Ð±Ð¾Ñ‚Ð°' },
            { icon: 'ðŸ”¥', text: 'Ð¡Ñ‚Ñ€Ð°ÑÑ‚ÑŒ' },
            { icon: 'ðŸ§˜', text: 'Ð¡Ð¿Ð¾ÐºÐ¾Ð¹ÑÑ‚Ð²Ð¸Ðµ' },
            { icon: 'ðŸŽ¨', text: 'ÐšÑ€ÐµÐ°Ñ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ' },
            { icon: 'ðŸ“š', text: 'Ð›ÑŽÐ±Ð¾Ð·Ð½Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ' },
            { icon: 'ðŸ¤', text: 'Ð”Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð¸Ðµ' },
            { icon: 'âš¡', text: 'Ð­Ð½ÐµÑ€Ð³Ð¸Ñ‡Ð½Ð¾ÑÑ‚ÑŒ' },
            { icon: 'ðŸ›¡ï¸', text: 'ÐÐ°Ð´Ñ‘Ð¶Ð½Ð¾ÑÑ‚ÑŒ' },
            { icon: 'ðŸŒŸ', text: 'ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¼' },
            { icon: 'ðŸŽ­', text: 'Ð®Ð¼Ð¾Ñ€' },
            { icon: 'ðŸ’Ž', text: 'Ð§ÐµÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ' },
            { icon: 'ðŸŒˆ', text: 'Ð“Ð¸Ð±ÐºÐ¾ÑÑ‚ÑŒ' },
            { icon: 'ðŸƒ', text: 'ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ' },
            { icon: 'ðŸ§ ', text: 'Ð£Ð¼' },
            { icon: 'â¤ï¸', text: 'Ð”Ð¾Ð±Ñ€Ð¾Ñ‚Ð°' },
        ];

        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    return { ...defaultData, ...parsed };
                } catch (e) {
                    console.error('Error parsing data:', e);
                }
            }
            return { ...defaultData };
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadSettings() {
            const stored = localStorage.getItem(SETTINGS_KEY);
            if (stored) {
                try {
                    return { ...defaultSettings, ...JSON.parse(stored) };
                } catch (e) {
                    console.error('Error parsing settings:', e);
                }
            }
            return { ...defaultSettings };
        }

        function saveSettings(settings) {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        }

        function loadProfiles() {
            const stored = localStorage.getItem(PROFILES_KEY);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    return {
                        A: { ...defaultProfiles.A, ...parsed.A },
                        B: { ...defaultProfiles.B, ...parsed.B }
                    };
                } catch (e) {
                    console.error('Error parsing profiles:', e);
                }
            }
            return JSON.parse(JSON.stringify(defaultProfiles));
        }

        function saveProfiles(profiles) {
            localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
        }

        // Achievements & Challenges Storage
        const ACHIEVEMENTS_KEY = 'habit_tracker_achievements';
        const CHALLENGES_KEY = 'habit_tracker_challenges';

        const defaultAchievements = {
            A: {},  // { achievementId: { unlockedAt: 'date', seen: false } }
            B: {}
        };

        const defaultChallenges = [];

        function loadAchievements() {
            const stored = localStorage.getItem(ACHIEVEMENTS_KEY);
            if (stored) {
                try {
                    return { ...defaultAchievements, ...JSON.parse(stored) };
                } catch (e) {
                    console.error('Error parsing achievements:', e);
                }
            }
            return JSON.parse(JSON.stringify(defaultAchievements));
        }

        function saveAchievements(achievements) {
            localStorage.setItem(ACHIEVEMENTS_KEY, JSON.stringify(achievements));
        }

        function loadChallenges() {
            const stored = localStorage.getItem(CHALLENGES_KEY);
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('Error parsing challenges:', e);
                }
            }
            return [...defaultChallenges];
        }

        function saveChallenges(challenges) {
            localStorage.setItem(CHALLENGES_KEY, JSON.stringify(challenges));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // ============ ACHIEVEMENTS DEFINITIONS ============
        const ACHIEVEMENTS = [
            { id: 'first_habit', icon: 'ðŸŒ±', name: 'ÐŸÐµÑ€Ð²Ñ‹Ðµ ÑˆÐ°Ð³Ð¸', desc: 'Ð¡Ð¾Ð·Ð´Ð°Ð¹ Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÑƒ', check: (userId) => data.habits.filter(h => h.owner === userId || h.owner === 'shared').length >= 1 },
            { id: 'five_habits', icon: 'ðŸŒ¿', name: 'ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¾Ð½ÐµÑ€', desc: 'Ð¡Ð¾Ð·Ð´Ð°Ð¹ 5 Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐµÐº', check: (userId) => data.habits.filter(h => h.owner === userId || h.owner === 'shared').length >= 5 },
            { id: 'ten_habits', icon: 'ðŸŒ³', name: 'Ð¡Ð°Ð´Ð¾Ð²Ð½Ð¸Ðº', desc: 'Ð¡Ð¾Ð·Ð´Ð°Ð¹ 10 Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐµÐº', check: (userId) => data.habits.filter(h => h.owner === userId || h.owner === 'shared').length >= 10 },
            { id: 'first_complete', icon: 'âœ…', name: 'ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¾', desc: 'Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÑƒ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ñ€Ð°Ð·', check: (userId) => calculateUserStats(userId).completions >= 1 },
            { id: 'ten_completions', icon: 'ðŸŽ¯', name: 'ÐÐ° Ð²ÐµÑ€Ð½Ð¾Ð¼ Ð¿ÑƒÑ‚Ð¸', desc: 'Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸ 10 Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐµÐº', check: (userId) => calculateUserStats(userId).completions >= 10 },
            { id: 'fifty_completions', icon: 'ðŸ’ª', name: 'ÐÐ°ÑÑ‚Ð¾Ð¹Ñ‡Ð¸Ð²Ð¾ÑÑ‚ÑŒ', desc: 'Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸ 50 Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐµÐº', check: (userId) => calculateUserStats(userId).completions >= 50 },
            { id: 'hundred_completions', icon: 'ðŸ†', name: 'Ð§ÐµÐ¼Ð¿Ð¸Ð¾Ð½', desc: 'Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸ 100 Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐµÐº', check: (userId) => calculateUserStats(userId).completions >= 100 },
            { id: 'streak_3', icon: 'ðŸ”¥', name: 'Ð Ð°Ð·Ð¾Ð³Ñ€ÐµÐ²', desc: 'Ð¡ÐµÑ€Ð¸Ñ 3 Ð´Ð½Ñ Ð¿Ð¾Ð´Ñ€ÑÐ´', check: (userId) => calculateUserStats(userId).streak >= 3 },
            { id: 'streak_7', icon: 'ðŸ”¥', name: 'ÐžÐ³Ð½ÐµÐ½Ð½Ð°Ñ Ð½ÐµÐ´ÐµÐ»Ñ', desc: 'Ð¡ÐµÑ€Ð¸Ñ 7 Ð´Ð½ÐµÐ¹ Ð¿Ð¾Ð´Ñ€ÑÐ´', check: (userId) => calculateUserStats(userId).streak >= 7 },
            { id: 'streak_14', icon: 'ðŸ”¥', name: 'Ð”Ð²Ðµ Ð½ÐµÐ´ÐµÐ»Ð¸ ÑÐ¸Ð»Ñ‹', desc: 'Ð¡ÐµÑ€Ð¸Ñ 14 Ð´Ð½ÐµÐ¹ Ð¿Ð¾Ð´Ñ€ÑÐ´', check: (userId) => calculateUserStats(userId).streak >= 14 },
            { id: 'streak_30', icon: 'ðŸ’Ž', name: 'ÐœÐ°Ñ€Ð°Ñ„Ð¾Ð½ÐµÑ†', desc: 'Ð¡ÐµÑ€Ð¸Ñ 30 Ð´Ð½ÐµÐ¹ Ð¿Ð¾Ð´Ñ€ÑÐ´', check: (userId) => calculateUserStats(userId).streak >= 30 },
            { id: 'streak_100', icon: 'ðŸ‘‘', name: 'Ð›ÐµÐ³ÐµÐ½Ð´Ð°', desc: 'Ð¡ÐµÑ€Ð¸Ñ 100 Ð´Ð½ÐµÐ¹ Ð¿Ð¾Ð´Ñ€ÑÐ´', check: (userId) => calculateUserStats(userId).streak >= 100 },
            { id: 'level_5', icon: 'â­', name: 'Ð£Ñ‡ÐµÐ½Ð¸Ðº', desc: 'Ð”Ð¾ÑÑ‚Ð¸Ð³Ð½Ð¸ 5 ÑƒÑ€Ð¾Ð²Ð½Ñ', check: (userId) => calculateLevel(calculateUserXP(userId)).level >= 5 },
            { id: 'level_10', icon: 'ðŸŒŸ', name: 'ÐœÐ°ÑÑ‚ÐµÑ€', desc: 'Ð”Ð¾ÑÑ‚Ð¸Ð³Ð½Ð¸ 10 ÑƒÑ€Ð¾Ð²Ð½Ñ', check: (userId) => calculateLevel(calculateUserXP(userId)).level >= 10 },
            { id: 'level_25', icon: 'ðŸ’«', name: 'Ð“Ñ€Ð°Ð½Ð´Ð¼Ð°ÑÑ‚ÐµÑ€', desc: 'Ð”Ð¾ÑÑ‚Ð¸Ð³Ð½Ð¸ 25 ÑƒÑ€Ð¾Ð²Ð½Ñ', check: (userId) => calculateLevel(calculateUserXP(userId)).level >= 25 },
            { id: 'active_7', icon: 'ðŸ“…', name: 'ÐÐºÑ‚Ð¸Ð²Ð½Ð°Ñ Ð½ÐµÐ´ÐµÐ»Ñ', desc: '7 Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð´Ð½ÐµÐ¹', check: (userId) => calculateUserStats(userId).activeDays >= 7 },
            { id: 'active_30', icon: 'ðŸ“†', name: 'ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¼ÐµÑÑÑ†', desc: '30 Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð´Ð½ÐµÐ¹', check: (userId) => calculateUserStats(userId).activeDays >= 30 },
            { id: 'shared_habit', icon: 'ðŸ’•', name: 'ÐšÐ¾Ð¼Ð°Ð½Ð´Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°', desc: 'Ð¡Ð¾Ð·Ð´Ð°Ð¹ Ð¾Ð±Ñ‰ÑƒÑŽ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÑƒ', check: (userId) => data.habits.some(h => h.owner === 'shared') },
            { id: 'profile_complete', icon: 'ðŸŽ­', name: 'Ð˜Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ', desc: 'Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ', check: (userId) => {
                const p = profiles[userId];
                return (p.name !== 'Ð”Ð¸Ð¼Ð¾Ñ‡ÐºÐ°' && p.name !== 'Ð”Ð°ÑˆÐµÐ½ÑŒÐºÐ°') || (p.superpower && p.superpower !== 'ÐÐ°Ð¶Ð¼Ð¸ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ' && p.bio !== 'Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¾ ÑÐµÐ±Ðµ...');
            }},
            { id: 'early_bird', icon: 'ðŸŒ…', name: 'Ð Ð°Ð½Ð½ÑÑ Ð¿Ñ‚Ð°ÑˆÐºÐ°', desc: 'Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÑƒ Ð´Ð¾ 7:00', check: () => false }, // Special - tracked separately
            { id: 'night_owl', icon: 'ðŸ¦‰', name: 'ÐŸÐ¾Ð»ÑƒÐ½Ð¾Ñ‡Ð½Ð¸Ðº', desc: 'Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÑƒ Ð¿Ð¾ÑÐ»Ðµ 23:00', check: () => false }, // Special - tracked separately
        ];

        // ============ SOUND SYSTEM ============
        let soundEnabled = localStorage.getItem('habit_tracker_sound') !== 'false';
        
        const sounds = {
            complete: null,
            levelUp: null,
            achievement: null
        };

        // Create audio context for sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (type === 'complete') {
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'levelUp') {
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.15);
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.3);
                oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime + 0.45);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.7);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.7);
            } else if (type === 'achievement') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(987.77, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(1174.66, audioContext.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.25, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('habit_tracker_sound', soundEnabled);
            updateSoundToggleUI();
        }

        function updateSoundToggleUI() {
            const toggle = document.getElementById('soundToggle');
            if (toggle) {
                toggle.innerHTML = soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
            }
        }

        // ============ STATE ============
        let data = loadData();
        let settings = loadSettings();
        let profiles = loadProfiles();
        let achievements = loadAchievements();
        let challenges = loadChallenges();
        let selectedDate = new Date();
        let currentMonth = new Date();
        let userFilter = 'all';
        let categoryFilter = 'all';
        let currentAnalyticsTab = 'weekly';
        let currentProfileUser = 'A';
        let previousLevels = { A: calculateLevel(calculateUserXP('A')).level, B: calculateLevel(calculateUserXP('B')).level };

        // ============ CONFETTI ANIMATION ============
        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#f472b6', '#c084fc', '#818cf8', '#fbbf24', '#34d399', '#60a5fa'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                
                if (Math.random() > 0.5) {
                    confetti.style.borderRadius = '50%';
                }
                
                container.appendChild(confetti);
            }
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // ============ LEVEL UP SYSTEM ============
        function checkLevelUp(userId) {
            const currentLevel = calculateLevel(calculateUserXP(userId)).level;
            const previousLevel = previousLevels[userId];
            
            if (currentLevel > previousLevel) {
                previousLevels[userId] = currentLevel;
                showLevelUp(currentLevel);
                return true;
            }
            return false;
        }

        function showLevelUp(level) {
            playSound('levelUp');
            createConfetti();
            
            document.getElementById('levelUpLevel').textContent = level;
            document.getElementById('levelUpOverlay').classList.add('active');
            
            setTimeout(() => {
                closeLevelUp();
            }, 3000);
        }

        function closeLevelUp() {
            document.getElementById('levelUpOverlay').classList.remove('active');
        }

        // ============ ACHIEVEMENTS SYSTEM ============
        function checkAchievements(userId) {
            const userAchievements = achievements[userId] || {};
            const newUnlocks = [];
            
            ACHIEVEMENTS.forEach(ach => {
                if (!userAchievements[ach.id] && ach.check(userId)) {
                    userAchievements[ach.id] = {
                        unlockedAt: new Date().toISOString(),
                        seen: false
                    };
                    newUnlocks.push(ach);
                }
            });
            
            if (newUnlocks.length > 0) {
                achievements[userId] = userAchievements;
                saveAchievements(achievements);
                
                // Show popup for first new achievement
                showAchievementPopup(newUnlocks[0]);
            }
        }

        function showAchievementPopup(achievement) {
            playSound('achievement');
            
            document.getElementById('achievementPopupIcon').textContent = achievement.icon;
            document.getElementById('achievementPopupTitle').textContent = achievement.name;
            
            const popup = document.getElementById('achievementPopup');
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 4000);
        }

        function renderAchievements(userId) {
            const grid = document.getElementById('achievementsGrid');
            if (!grid) return;
            
            const userAchievements = achievements[userId] || {};
            
            grid.innerHTML = ACHIEVEMENTS.map(ach => {
                const unlocked = userAchievements[ach.id];
                const isNew = unlocked && !unlocked.seen;
                const unlockedDate = unlocked ? new Date(unlocked.unlockedAt).toLocaleDateString('ru-RU') : null;
                
                // Mark as seen
                if (isNew) {
                    achievements[userId][ach.id].seen = true;
                    saveAchievements(achievements);
                }
                
                return `
                    <div class="achievement-item ${unlocked ? 'unlocked' : 'locked'} ${isNew ? 'new' : ''}">
                        <div class="achievement-icon">${ach.icon}</div>
                        <div class="achievement-name">${ach.name}</div>
                        <div class="achievement-tooltip">
                            <div class="achievement-tooltip-title">${ach.name}</div>
                            <div class="achievement-tooltip-desc">${ach.desc}</div>
                            ${unlockedDate ? `<div class="achievement-tooltip-date">ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾: ${unlockedDate}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============ STREAK BADGES ============
        function getStreakBadge(streak) {
            if (streak >= 100) return { class: 'diamond', icon: 'ðŸ’Ž', text: streak };
            if (streak >= 30) return { class: 'gold', icon: 'ðŸ”¥', text: streak };
            if (streak >= 7) return { class: 'silver', icon: 'ðŸ”¥', text: streak };
            if (streak >= 3) return { class: 'bronze', icon: 'ðŸ”¥', text: streak };
            return null;
        }

        function getHabitStreak(habitId) {
            const now = new Date();
            let streak = 0;
            
            for (let i = 0; i <= 365; i++) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = formatDate(date);
                const entry = data.entries[dateStr]?.[habitId];
                
                if (entry === true || (typeof entry === 'number' && entry > 0)) {
                    streak++;
                } else if (i > 0) {
                    break;
                }
            }
            
            return streak;
        }

        function getStreakFireClass(streak) {
            if (streak >= 100) return 'fire-diamond';
            if (streak >= 30) return 'fire-gold';
            if (streak >= 7) return 'fire-silver';
            if (streak >= 3) return 'fire-bronze';
            return '';
        }

        // ============ INLINE EDITING ============
        function startInlineEdit(element, field, isTextarea = false) {
            if (element.classList.contains('editing')) return;
            
            const currentValue = element.textContent.trim();
            element.classList.add('editing');
            
            if (isTextarea) {
                element.innerHTML = `<textarea class="inline-edit-textarea" onblur="finishInlineEdit(this, '${field}')" onkeydown="handleInlineKeydown(event, this, '${field}')">${currentValue}</textarea>`;
            } else {
                element.innerHTML = `<input type="text" class="inline-edit-input" value="${currentValue}" onblur="finishInlineEdit(this, '${field}')" onkeydown="handleInlineKeydown(event, this, '${field}')">`;
            }
            
            const input = element.querySelector('input, textarea');
            input.focus();
            input.select();
        }

        function handleInlineKeydown(event, input, field) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                input.blur();
            }
            if (event.key === 'Escape') {
                // Cancel edit
                showProfile(currentProfileUser);
            }
        }

        function finishInlineEdit(input, field) {
            const newValue = input.value.trim();
            const profile = profiles[currentProfileUser];
            
            switch (field) {
                case 'name':
                    profile.name = newValue || profile.name;
                    break;
                case 'title':
                    profile.title = newValue || 'ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽÑ‰Ð¸Ð¹ Ð³ÐµÑ€Ð¾Ð¹';
                    break;
                case 'bio':
                    profile.bio = newValue || 'Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¾ ÑÐµÐ±Ðµ...';
                    break;
            }
            
            saveProfiles(profiles);
            updateUserCards();
            showProfile(currentProfileUser);
            
            // Check profile achievement
            checkAchievements(currentProfileUser);
        }

        // ============ SUPERPOWER EDITING ============
        function editSuperpower() {
            const profile = profiles[currentProfileUser];
            const currentValue = profile.superpower || 'ÐœÐ¾Ñ ÑÑƒÐ¿ÐµÑ€ÑÐ¸Ð»Ð°';
            const newValue = prompt('Ð¢Ð²Ð¾Ñ ÑÑƒÐ¿ÐµÑ€ÑÐ¸Ð»Ð°:', currentValue);
            
            if (newValue !== null && newValue.trim()) {
                profile.superpower = newValue.trim();
                saveProfiles(profiles);
                showProfile(currentProfileUser);
                checkAchievements(currentProfileUser);
            }
        }

        // ============ TRAITS EDITING ============
        let currentTraitSlot = 0;

        function openTraitPicker(slotIndex) {
            currentTraitSlot = slotIndex;
            
            const optionsContainer = document.getElementById('traitPickerOptions');
            optionsContainer.innerHTML = TRAIT_OPTIONS.map(trait => `
                <div class="trait-option" onclick="selectTrait('${trait.icon}', '${trait.text}')">
                    <div class="trait-option-icon">${trait.icon}</div>
                    <div class="trait-option-text">${trait.text}</div>
                </div>
            `).join('');
            
            document.getElementById('customTraitInput').value = '';
            document.getElementById('traitPickerOverlay').classList.add('active');
        }

        function selectTrait(icon, text) {
            const profile = profiles[currentProfileUser];
            
            // Ensure traits is an array of 5 elements
            if (!Array.isArray(profile.traits) || profile.traits.length !== 5) {
                profile.traits = [null, null, null, null, null];
            }
            
            profile.traits[currentTraitSlot] = { icon, text };
            saveProfiles(profiles);
            
            document.getElementById('traitPickerOverlay').classList.remove('active');
            showProfile(currentProfileUser);
            checkAchievements(currentProfileUser);
        }

        function saveCustomTrait() {
            const input = document.getElementById('customTraitInput');
            const text = input.value.trim();
            
            if (text) {
                selectTrait('âœ¨', text);
            }
        }

        function removeTrait(slotIndex) {
            const profile = profiles[currentProfileUser];
            if (Array.isArray(profile.traits) && profile.traits[slotIndex]) {
                profile.traits[slotIndex] = null;
                saveProfiles(profiles);
                showProfile(currentProfileUser);
            }
        }

        function renderTraits(userId) {
            const container = document.getElementById('profileTraits');
            if (!container) return;
            
            const profile = profiles[userId];
            
            // Ensure traits is an array of 5 elements
            let traits = profile.traits;
            if (!Array.isArray(traits)) {
                traits = [null, null, null, null, null];
            }
            while (traits.length < 5) traits.push(null);
            if (traits.length > 5) traits = traits.slice(0, 5);
            
            // Convert old format to new format if needed
            traits = traits.map(t => {
                if (t && typeof t === 'string') {
                    return { icon: 'âœ¨', text: t };
                }
                return t;
            });
            
            profile.traits = traits;
            
            container.innerHTML = traits.map((trait, index) => {
                if (trait) {
                    return `
                        <div class="trait-slot filled" onclick="openTraitPicker(${index})" title="ÐÐ°Ð¶Ð¼Ð¸ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ">
                            <div class="trait-slot-icon">${trait.icon}</div>
                            <div class="trait-slot-text">${trait.text}</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="trait-slot empty" onclick="openTraitPicker(${index})" title="Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‡ÐµÑ€Ñ‚Ñƒ">
                            <div class="trait-slot-icon">+</div>
                            <div class="trait-slot-text">Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ</div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Close trait picker on overlay click
        document.getElementById('traitPickerOverlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'traitPickerOverlay') {
                document.getElementById('traitPickerOverlay').classList.remove('active');
            }
        });

        // ============ CHALLENGES SYSTEM ============
        function renderChallenges() {
            const list = document.getElementById('challengesList');
            if (!list) return;
            
            if (challenges.length === 0) {
                list.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px 0;">Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð½Ñ‹Ð¹ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶!</p>';
                return;
            }
            
            const now = new Date();
            
            list.innerHTML = challenges.map(challenge => {
                const startDate = new Date(challenge.startDate);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + challenge.duration);
                
                const isActive = now <= endDate;
                const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                
                // Calculate progress for each user
                const progressA = challenge.progressA || 0;
                const progressB = challenge.progressB || 0;
                const totalProgress = progressA + progressB;
                const percentA = challenge.goal > 0 ? (progressA / challenge.goal) * 100 : 0;
                const percentB = challenge.goal > 0 ? (progressB / challenge.goal) * 100 : 0;
                const totalPercent = Math.min(((progressA + progressB) / challenge.goal) * 100, 100);
                
                return `
                    <div class="challenge-item" data-challenge-id="${challenge.id}">
                        <div class="challenge-name">
                            ðŸŽ¯ ${challenge.name}
                            ${!isActive ? '<span style="color: #64748b;">(Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½)</span>' : ''}
                        </div>
                        <div class="challenge-progress-container">
                            <div class="challenge-progress-bar">
                                <div class="challenge-progress-a" style="width: ${Math.min(percentA, 50)}%"></div>
                                <div class="challenge-progress-b" style="width: ${Math.min(percentB, 50)}%"></div>
                            </div>
                            <div class="challenge-progress-text">
                                <span>${profiles.A.name}: ${progressA} ${challenge.unit}</span>
                                <span>${totalProgress}/${challenge.goal} ${challenge.unit} (${Math.round(totalPercent)}%)</span>
                                <span>${profiles.B.name}: ${progressB} ${challenge.unit}</span>
                            </div>
                        </div>
                        ${isActive ? `
                            <div class="challenge-deadline">â° ÐžÑÑ‚Ð°Ð»Ð¾ÑÑŒ ${daysLeft} Ð´Ð½ÐµÐ¹</div>
                            <div style="display: flex; gap: 8px; margin-top: 10px;">
                                <button class="btn btn-secondary" style="flex: 1; padding: 8px;" onclick="addChallengeProgress('${challenge.id}', 'A')">+1 ${profiles.A.avatar}</button>
                                <button class="btn btn-secondary" style="flex: 1; padding: 8px;" onclick="addChallengeProgress('${challenge.id}', 'B')">+1 ${profiles.B.avatar}</button>
                                <button class="btn btn-secondary" style="padding: 8px; color: #f87171;" onclick="deleteChallenge('${challenge.id}')">ðŸ—‘ï¸</button>
                            </div>
                        ` : `
                            <div style="text-align: center; margin-top: 10px;">
                                ${totalProgress >= challenge.goal ? 'ðŸŽ‰ Ð§ÐµÐ»Ð»ÐµÐ½Ð´Ð¶ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½!' : 'ðŸ˜” ÐÐµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾'}
                                <button class="btn btn-secondary" style="margin-left: 10px; padding: 6px 12px; color: #f87171;" onclick="deleteChallenge('${challenge.id}')">Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ</button>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        function addChallengeProgress(challengeId, userId) {
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            const key = userId === 'A' ? 'progressA' : 'progressB';
            challenge[key] = (challenge[key] || 0) + 1;
            
            saveChallenges(challenges);
            renderChallenges();
            
            playSound('complete');
        }

        function createChallenge() {
            const name = document.getElementById('challengeName').value.trim();
            const goal = parseInt(document.getElementById('challengeGoal').value) || 0;
            const unit = document.getElementById('challengeUnit').value.trim() || 'Ñ€Ð°Ð·';
            const duration = parseInt(document.getElementById('challengeDuration').value) || 30;
            
            if (!name || goal <= 0) {
                alert('Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¸ Ñ†ÐµÐ»ÑŒ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶Ð°');
                return;
            }
            
            const challenge = {
                id: generateId(),
                name,
                goal,
                unit,
                duration,
                startDate: new Date().toISOString(),
                progressA: 0,
                progressB: 0
            };
            
            challenges.push(challenge);
            saveChallenges(challenges);
            
            // Reset form
            document.getElementById('challengeName').value = '';
            document.getElementById('challengeGoal').value = '';
            document.getElementById('challengeUnit').value = '';
            document.getElementById('challengeDuration').value = '';
            document.getElementById('challengeForm').classList.remove('active');
            
            renderChallenges();
        }

        function deleteChallenge(challengeId) {
            if (!confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ Ñ‡ÐµÐ»Ð»ÐµÐ½Ð´Ð¶?')) return;
            
            challenges = challenges.filter(c => c.id !== challengeId);
            saveChallenges(challenges);
            renderChallenges();
        }

        // Challenge form handlers
        document.getElementById('addChallengeBtn')?.addEventListener('click', () => {
            document.getElementById('challengeForm').classList.toggle('active');
        });

        document.getElementById('cancelChallenge')?.addEventListener('click', () => {
            document.getElementById('challengeForm').classList.remove('active');
        });

        document.getElementById('saveChallenge')?.addEventListener('click', createChallenge);

        // ============ TIME-BASED ACHIEVEMENTS ============
        function checkTimeBasedAchievements(userId) {
            const hour = new Date().getHours();
            
            if (hour < 7) {
                // Early bird
                if (!achievements[userId]?.early_bird) {
                    achievements[userId] = achievements[userId] || {};
                    achievements[userId].early_bird = {
                        unlockedAt: new Date().toISOString(),
                        seen: false
                    };
                    saveAchievements(achievements);
                    showAchievementPopup(ACHIEVEMENTS.find(a => a.id === 'early_bird'));
                }
            }
            
            if (hour >= 23) {
                // Night owl
                if (!achievements[userId]?.night_owl) {
                    achievements[userId] = achievements[userId] || {};
                    achievements[userId].night_owl = {
                        unlockedAt: new Date().toISOString(),
                        seen: false
                    };
                    saveAchievements(achievements);
                    showAchievementPopup(ACHIEVEMENTS.find(a => a.id === 'night_owl'));
                }
            }
        }

        // ============ VIEW DROPDOWN ============
        // ============ VIEW CYCLING ============
        function cycleView() {
            // Cycle through: all â†’ A â†’ B â†’ all
            const views = ['all', 'A', 'B'];
            const currentIndex = views.indexOf(userFilter);
            const nextIndex = (currentIndex + 1) % views.length;
            const nextView = views[nextIndex];
            
            switchUserView(nextView);
            
            // Add flip animation
            const indicator = document.getElementById('currentViewIndicator');
            indicator.classList.add('flipping');
            setTimeout(() => indicator.classList.remove('flipping'), 300);
        }

        // ============ HABITS DASHBOARD ============
        let dashboardMonth = new Date();

        function openHabitsDashboard() {
            dashboardMonth = new Date();
            renderDashboard();
            document.getElementById('dashboardOverlay').classList.add('active');
        }

        function closeDashboard() {
            document.getElementById('dashboardOverlay').classList.remove('active');
        }

        function renderDashboard() {
            const thead = document.getElementById('dashboardTableHead');
            const tbody = document.getElementById('dashboardTableBody');
            const monthTitle = document.getElementById('dashboardMonthTitle');
            
            const year = dashboardMonth.getFullYear();
            const month = dashboardMonth.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            monthTitle.textContent = `${monthNames[month]} ${year}`;
            
            // Build header row with days
            let headerHtml = '<tr><th>ÐŸÑ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ°</th>';
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = date.toDateString() === today.toDateString();
                const dayOfWeek = ['Ð’Ñ', 'ÐŸÐ½', 'Ð’Ñ‚', 'Ð¡Ñ€', 'Ð§Ñ‚', 'ÐŸÑ‚', 'Ð¡Ð±'][date.getDay()];
                headerHtml += `<th class="${isToday ? 'today-header' : ''}">${day}<br><small>${dayOfWeek}</small></th>`;
            }
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;
            
            // Build body rows with habits
            let bodyHtml = '';
            
            // Filter habits based on current user view
            let habitsToShow = data.habits;
            if (userFilter !== 'all') {
                habitsToShow = habitsToShow.filter(h => h.owner === userFilter || h.owner === 'shared');
            }
            
            habitsToShow.forEach(habit => {
                bodyHtml += `<tr>`;
                bodyHtml += `<td>
                    <div class="dashboard-habit-name">
                        <div class="habit-owner-dot owner-${habit.owner}"></div>
                        <span>${habit.name}</span>
                    </div>
                </td>`;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateStr = formatDate(date);
                    const isToday = date.toDateString() === today.toDateString();
                    const isFuture = date > today;
                    
                    const entry = data.entries[dateStr]?.[habit.id];
                    let cellClass = 'dashboard-cell';
                    let cellContent = '';
                    
                    if (isFuture) {
                        cellClass += ' future';
                    } else if (habit.type === 'binary') {
                        if (entry === true) {
                            cellClass += ' completed';
                            cellContent = 'âœ“';
                        } else {
                            cellClass += ' missed';
                        }
                    } else {
                        // Numeric
                        if (typeof entry === 'number' && entry > 0) {
                            const goal = habit.goal || 1;
                            if (entry >= goal) {
                                cellClass += ' completed';
                            } else {
                                cellClass += ' partial';
                            }
                            cellContent = entry;
                        } else {
                            cellClass += ' missed';
                        }
                    }
                    
                    if (isToday) cellClass += ' today';
                    
                    bodyHtml += `<td><div class="${cellClass}" onclick="toggleDashboardCell('${habit.id}', '${dateStr}', '${habit.type}')">${cellContent}</div></td>`;
                }
                
                bodyHtml += '</tr>';
            });
            
            if (habitsToShow.length === 0) {
                bodyHtml = `<tr><td colspan="${daysInMonth + 1}" style="text-align: center; padding: 40px; color: #64748b;">ÐÐµÑ‚ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐµÐº Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ</td></tr>`;
            }
            
            tbody.innerHTML = bodyHtml;
        }

        function toggleDashboardCell(habitId, dateStr, type) {
            if (!data.entries[dateStr]) {
                data.entries[dateStr] = {};
            }
            
            const habit = data.habits.find(h => h.id === habitId);
            if (!habit) return;
            
            if (type === 'binary') {
                const current = data.entries[dateStr][habitId];
                data.entries[dateStr][habitId] = !current;
                
                if (!current) {
                    playSound('complete');
                    const owners = habit.owner === 'shared' ? ['A', 'B'] : [habit.owner];
                    owners.forEach(userId => {
                        checkAchievements(userId);
                        checkLevelUp(userId);
                    });
                }
            } else {
                // For numeric, increment by 1
                const current = data.entries[dateStr][habitId] || 0;
                data.entries[dateStr][habitId] = current + 1;
                playSound('complete');
                
                const owners = habit.owner === 'shared' ? ['A', 'B'] : [habit.owner];
                owners.forEach(userId => {
                    checkAchievements(userId);
                    checkLevelUp(userId);
                });
            }
            
            saveData(data);
            renderDashboard();
            renderHabits();
            renderCalendar();
            updateProgressBars();
            updateUserCards();
        }

        // Dashboard event listeners
        document.getElementById('dashboardClose')?.addEventListener('click', closeDashboard);
        document.getElementById('dashboardOverlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'dashboardOverlay') closeDashboard();
        });

        document.getElementById('dashboardPrevMonth')?.addEventListener('click', () => {
            dashboardMonth.setMonth(dashboardMonth.getMonth() - 1);
            renderDashboard();
        });

        document.getElementById('dashboardNextMonth')?.addEventListener('click', () => {
            dashboardMonth.setMonth(dashboardMonth.getMonth() + 1);
            renderDashboard();
        });

        // ============ UTILS ============
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDisplayDate(date) {
            const options = { day: 'numeric', month: 'long' };
            return date.toLocaleDateString('ru-RU', options);
        }

        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        function isSameDay(d1, d2) {
            return d1.getDate() === d2.getDate() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getFullYear() === d2.getFullYear();
        }

        const monthNames = [
            'Ð¯Ð½Ð²Ð°Ñ€ÑŒ', 'Ð¤ÐµÐ²Ñ€Ð°Ð»ÑŒ', 'ÐœÐ°Ñ€Ñ‚', 'ÐÐ¿Ñ€ÐµÐ»ÑŒ', 'ÐœÐ°Ð¹', 'Ð˜ÑŽÐ½ÑŒ',
            'Ð˜ÑŽÐ»ÑŒ', 'ÐÐ²Ð³ÑƒÑÑ‚', 'Ð¡ÐµÐ½Ñ‚ÑÐ±Ñ€ÑŒ', 'ÐžÐºÑ‚ÑÐ±Ñ€ÑŒ', 'ÐÐ¾ÑÐ±Ñ€ÑŒ', 'Ð”ÐµÐºÐ°Ð±Ñ€ÑŒ'
        ];

        const weekDays = ['ÐŸÐ½', 'Ð’Ñ‚', 'Ð¡Ñ€', 'Ð§Ñ‚', 'ÐŸÑ‚', 'Ð¡Ð±', 'Ð’Ñ'];

        // ============ CALENDAR ============
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarTitle');
            
            title.textContent = `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
            
            let html = weekDays.map(day => `<div class="calendar-weekday">${day}</div>`).join('');
            
            const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            
            // Adjust for Monday start (0 = Monday, 6 = Sunday)
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;
            
            // Empty cells before first day
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            // Days of the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
                const dateStr = formatDate(date);
                const hasActivity = data.entries[dateStr] && Object.keys(data.entries[dateStr]).length > 0;
                
                let classes = ['calendar-day'];
                if (isToday(date)) classes.push('today');
                if (isSameDay(date, selectedDate)) classes.push('selected');
                if (hasActivity) classes.push('has-activity');
                
                html += `<div class="${classes.join(' ')}" data-date="${dateStr}">${day}</div>`;
            }
            
            grid.innerHTML = html;
            
            // Add click listeners
            grid.querySelectorAll('.calendar-day:not(.empty)').forEach(el => {
                el.addEventListener('click', () => {
                    const dateStr = el.dataset.date;
                    const [year, month, day] = dateStr.split('-').map(Number);
                    selectedDate = new Date(year, month - 1, day);
                    renderCalendar();
                    renderHabits();
                    updateSelectedDateText();
                });
            });
        }

        function updateSelectedDateText() {
            const el = document.getElementById('selectedDateText');
            if (isToday(selectedDate)) {
                el.textContent = 'Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ';
            } else {
                el.textContent = formatDisplayDate(selectedDate);
            }
        }

        // ============ CATEGORIES ============
        function getCategories() {
            const cats = new Set();
            data.habits.forEach(h => {
                if (h.category) cats.add(h.category);
            });
            return Array.from(cats).sort();
        }

        function renderCategoryFilter() {
            const container = document.getElementById('categoryFilter');
            const categories = getCategories();
            
            if (categories.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = `<div class="category-chip ${categoryFilter === 'all' ? 'active' : ''}" data-category="all">Ð’ÑÐµ</div>`;
            categories.forEach(cat => {
                html += `<div class="category-chip ${categoryFilter === cat ? 'active' : ''}" data-category="${cat}">${cat}</div>`;
            });
            
            container.innerHTML = html;
            
            container.querySelectorAll('.category-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    categoryFilter = chip.dataset.category;
                    renderCategoryFilter();
                    renderHabits();
                });
            });
        }

        function updateCategoryDatalist() {
            const datalist = document.getElementById('categoryList');
            const categories = getCategories();
            datalist.innerHTML = categories.map(c => `<option value="${c}">`).join('');
        }

        // ============ HABITS ============
        function renderHabits() {
            const list = document.getElementById('habitsList');
            const dateStr = formatDate(selectedDate);
            const dayEntries = data.entries[dateStr] || {};
            
            // Filter habits by user
            let habits = data.habits;
            if (userFilter !== 'all') {
                habits = habits.filter(h => h.owner === userFilter || h.owner === 'shared');
            }
            
            // Filter by category
            if (categoryFilter !== 'all') {
                habits = habits.filter(h => h.category === categoryFilter);
            }
            
            if (habits.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <p>ÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐµÐº</p>
                        <p>Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÑƒ!</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = habits.map(habit => {
                const value = dayEntries[habit.id];
                const progress = calculateHabitProgress(habit);
                const ownerClass = `owner-${habit.owner}`;
                const ownerNames = { A: 'Ð”Ð¸Ð¼Ð¾Ñ‡ÐºÐ° ðŸ¦Š', B: 'Ð”Ð°ÑˆÐµÐ½ÑŒÐºÐ° ðŸ¦‹', shared: 'ÐžÐ±Ñ‰Ð°Ñ ðŸ’•' };
                const ownerLabel = ownerNames[habit.owner] || habit.owner;
                const categoryHtml = habit.category ? `<span class="category-badge">${habit.category}</span>` : '';
                
                // Streak badge
                const habitStreak = getHabitStreak(habit.id);
                const streakClass = getStreakFireClass(habitStreak);
                const streakHtml = habitStreak >= 3 ? `<span class="habit-streak-indicator ${streakClass}">ðŸ”¥${habitStreak}</span>` : '';
                
                const actionsHtml = `
                    <div class="habit-actions">
                        <button class="habit-action-btn" onclick="editHabit('${habit.id}')" title="Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ">âœŽ</button>
                        <button class="habit-action-btn delete" onclick="deleteHabit('${habit.id}')" title="Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ">Ã—</button>
                    </div>
                `;

                if (habit.type === 'binary') {
                    const checked = value === true;
                    const totalCount = countTotalCompletions(habit);
                    const targetHtml = habit.target ? `
                        <div class="target-progress">
                            <span>${totalCount}/${habit.target}</span>
                            <div class="target-progress-bar">
                                <div class="target-progress-fill" style="width: ${Math.min((totalCount / habit.target) * 100, 100)}%"></div>
                            </div>
                        </div>
                    ` : '';
                    return `
                        <div class="habit-item" data-habit-id="${habit.id}" draggable="true">
                            <div class="habit-drag-handle" title="ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ð´Ð»Ñ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸">â‹®â‹®</div>
                            <div class="habit-checkbox ${checked ? 'checked' : ''}" onclick="toggleBinaryHabit('${habit.id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                            <div class="habit-info" onclick="showHabitDetail('${habit.id}')" style="cursor: pointer;">
                                <div class="habit-name">
                                    ${habit.name}
                                    ${streakHtml}
                                    <span class="habit-owner ${ownerClass}">${ownerLabel}</span>
                                    ${categoryHtml}
                                    ${targetHtml}
                                </div>
                                <div class="habit-progress">
                                    <div class="habit-progress-bar">
                                        <div class="habit-progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="habit-progress-text">${Math.round(progress)}% Ð·Ð° ${getPeriodLabel(habit.period)}</div>
                                </div>
                            </div>
                            ${actionsHtml}
                        </div>
                    `;
                } else {
                    const numValue = typeof value === 'number' ? value : 0;
                    const goalStatus = checkNumericGoalCompleted(habit, numValue);
                    const inputClass = goalStatus.completed ? 'completed' : (goalStatus.incomplete ? 'incomplete' : '');
                    const goalPeriodLabel = getGoalPeriodLabel(habit.goalType, habit.customPeriod);
                    const goalLabel = habit.goal ? `/ ${habit.goal} ${goalPeriodLabel}` : '';
                    return `
                        <div class="habit-item" data-habit-id="${habit.id}" draggable="true">
                            <div class="habit-drag-handle" title="ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ð´Ð»Ñ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸">â‹®â‹®</div>
                            <input type="number" class="numeric-input ${inputClass}" value="${numValue}" min="0" 
                                   onchange="updateNumericHabit('${habit.id}', this.value)">
                            <div class="habit-info" onclick="showHabitDetail('${habit.id}')" style="cursor: pointer;">
                                <div class="habit-name">
                                    ${habit.name}
                                    ${streakHtml}
                                    ${goalLabel ? `<span class="numeric-goal">${goalLabel}</span>` : ''}
                                    <span class="habit-owner ${ownerClass}">${ownerLabel}</span>
                                    ${categoryHtml}
                                </div>
                                <div class="habit-progress">
                                    <div class="habit-progress-bar">
                                        <div class="habit-progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="habit-progress-text">${Math.round(progress)}% Ð·Ð° ${getPeriodLabel(habit.period)}</div>
                                </div>
                            </div>
                            ${actionsHtml}
                        </div>
                    `;
                }
            }).join('');
            
            // Setup drag and drop
            setupDragAndDrop();
        }
        
        // ============ DRAG AND DROP ============
        let draggedHabit = null;
        
        function setupDragAndDrop() {
            const items = document.querySelectorAll('.habit-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedHabit = item;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    document.querySelectorAll('.habit-item').forEach(i => i.classList.remove('drag-over'));
                    draggedHabit = null;
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedHabit && draggedHabit !== item) {
                        item.classList.add('drag-over');
                    }
                });
                
                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over');
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    
                    if (draggedHabit && draggedHabit !== item) {
                        const draggedId = draggedHabit.dataset.habitId;
                        const targetId = item.dataset.habitId;
                        
                        const draggedIndex = data.habits.findIndex(h => h.id === draggedId);
                        const targetIndex = data.habits.findIndex(h => h.id === targetId);
                        
                        if (draggedIndex !== -1 && targetIndex !== -1) {
                            const [removed] = data.habits.splice(draggedIndex, 1);
                            data.habits.splice(targetIndex, 0, removed);
                            saveData(data);
                            renderHabits();
                        }
                    }
                });
            });
        }

        function getPeriodLabel(period) {
            switch (period) {
                case 'week': return 'Ð½ÐµÐ´ÐµÐ»ÑŽ';
                case 'month': return 'Ð¼ÐµÑÑÑ†';
                case 'all': return 'Ð²ÑÑ‘ Ð²Ñ€ÐµÐ¼Ñ';
                default: return period;
            }
        }

        function getGoalPeriodLabel(goalType, customPeriod) {
            switch (goalType) {
                case 'daily': return 'Ð² Ð´ÐµÐ½ÑŒ';
                case 'week': return 'Ð² Ð½ÐµÐ´ÐµÐ»ÑŽ';
                case 'month': return 'Ð² Ð¼ÐµÑÑÑ†';
                case 'quarter': return 'Ð² ÐºÐ²Ð°Ñ€Ñ‚Ð°Ð»';
                case 'year': return 'Ð² Ð³Ð¾Ð´';
                case 'custom': return customPeriod ? `Ð·Ð° ${customPeriod} Ð´Ð½.` : '';
                default: return '';
            }
        }

        function getGoalPeriodDays(goalType, customPeriod) {
            switch (goalType) {
                case 'daily': return 1;
                case 'week': return 7;
                case 'month': return 30;
                case 'quarter': return 90;
                case 'year': return 365;
                case 'custom': return customPeriod || 1;
                default: return 1;
            }
        }

        function checkNumericGoalCompleted(habit, numValue) {
            const goalType = habit.goalType || 'daily';
            const goal = habit.goal || 0;
            if (!goal) return { completed: false, incomplete: false };
            
            const periodDays = getGoalPeriodDays(goalType, habit.customPeriod);
            
            if (periodDays === 1) {
                // Daily goal - check today's value
                return {
                    completed: numValue >= goal,
                    incomplete: numValue > 0 && numValue < goal
                };
            } else {
                // Period goal - check sum over the period
                const now = new Date();
                let sum = 0;
                for (let i = 0; i < periodDays; i++) {
                    const date = new Date(now);
                    date.setDate(now.getDate() - i);
                    const dateStr = formatDate(date);
                    const entry = data.entries[dateStr]?.[habit.id];
                    if (typeof entry === 'number') sum += entry;
                }
                return {
                    completed: sum >= goal,
                    incomplete: sum > 0 && sum < goal
                };
            }
        }

        function countTotalCompletions(habit) {
            let count = 0;
            Object.keys(data.entries).forEach(dateStr => {
                const entry = data.entries[dateStr][habit.id];
                if (habit.type === 'binary') {
                    if (entry === true) count++;
                } else {
                    if (typeof entry === 'number') count += entry;
                }
            });
            return count;
        }

        function toggleBinaryHabit(habitId) {
            const dateStr = formatDate(selectedDate);
            if (!data.entries[dateStr]) {
                data.entries[dateStr] = {};
            }
            
            const current = data.entries[dateStr][habitId];
            const newValue = !current;
            data.entries[dateStr][habitId] = newValue;
            
            saveData(data);
            renderHabits();
            renderCalendar();
            updateProgressBars();
            updateUserCards();
            
            // New features integration
            if (newValue) {
                playSound('complete');
                
                // Get habit owner and check achievements
                const habit = data.habits.find(h => h.id === habitId);
                if (habit) {
                    const owners = habit.owner === 'shared' ? ['A', 'B'] : [habit.owner];
                    owners.forEach(userId => {
                        checkTimeBasedAchievements(userId);
                        checkAchievements(userId);
                        checkLevelUp(userId);
                    });
                }
            }
        }

        function updateNumericHabit(habitId, value) {
            const dateStr = formatDate(selectedDate);
            if (!data.entries[dateStr]) {
                data.entries[dateStr] = {};
            }
            
            const prevValue = data.entries[dateStr][habitId] || 0;
            const numValue = parseInt(value) || 0;
            
            if (numValue > 0) {
                data.entries[dateStr][habitId] = numValue;
            } else {
                delete data.entries[dateStr][habitId];
            }
            
            saveData(data);
            renderCalendar();
            renderHabits();
            updateUserCards();
            
            // New features integration
            if (numValue > prevValue) {
                playSound('complete');
                
                // Get habit owner and check achievements
                const habit = data.habits.find(h => h.id === habitId);
                if (habit) {
                    const owners = habit.owner === 'shared' ? ['A', 'B'] : [habit.owner];
                    owners.forEach(userId => {
                        checkTimeBasedAchievements(userId);
                        checkAchievements(userId);
                        checkLevelUp(userId);
                    });
                }
            }
            updateProgressBars();
        }

        // ============ HABIT DETAIL MODAL ============
        let detailMonth = new Date();
        
        function showHabitDetail(habitId) {
            const habit = data.habits.find(h => h.id === habitId);
            if (!habit) return;
            
            const overlay = document.getElementById('habitDetailOverlay');
            document.getElementById('habitDetailTitle').textContent = habit.name;
            
            // Calculate stats
            const stats = calculateHabitStats(habit);
            renderHabitStats(stats, habit);
            
            // Render calendar for this habit
            detailMonth = new Date();
            renderHabitDetailCalendar(habit);
            
            overlay.classList.add('active');
            overlay.dataset.habitId = habitId;
        }
        
        function calculateHabitStats(habit) {
            const now = new Date();
            let completedDays = 0;
            let totalDays = 0;
            let currentStreak = 0;
            let maxStreak = 0;
            let tempStreak = 0;
            
            // Go through last 90 days
            for (let i = 89; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = formatDate(date);
                
                const entry = data.entries[dateStr]?.[habit.id];
                let isDayCompleted = false;
                
                if (habit.type === 'binary') {
                    isDayCompleted = entry === true;
                } else {
                    const goalType = habit.goalType || 'daily';
                    if (goalType === 'daily' && habit.goal) {
                        isDayCompleted = (entry || 0) >= habit.goal;
                    } else {
                        isDayCompleted = (entry || 0) > 0;
                    }
                }
                
                totalDays++;
                if (isDayCompleted) {
                    completedDays++;
                    tempStreak++;
                    if (tempStreak > maxStreak) maxStreak = tempStreak;
                } else {
                    tempStreak = 0;
                }
                
                // Current streak (from today backwards)
                if (i === 0 || (i > 0 && currentStreak > 0)) {
                    if (isDayCompleted) {
                        if (i === 0 || currentStreak > 0) currentStreak++;
                    } else if (i > 0) {
                        // Don't break streak for today if not completed yet
                    }
                }
            }
            
            // Recalculate current streak from today backwards
            currentStreak = 0;
            for (let i = 0; i <= 89; i++) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = formatDate(date);
                
                const entry = data.entries[dateStr]?.[habit.id];
                let isDayCompleted = false;
                
                if (habit.type === 'binary') {
                    isDayCompleted = entry === true;
                } else {
                    const goalType = habit.goalType || 'daily';
                    if (goalType === 'daily' && habit.goal) {
                        isDayCompleted = (entry || 0) >= habit.goal;
                    } else {
                        isDayCompleted = (entry || 0) > 0;
                    }
                }
                
                if (isDayCompleted) {
                    currentStreak++;
                } else if (i > 0) {
                    break;
                }
            }
            
            return { completedDays, totalDays, currentStreak, maxStreak };
        }
        
        function renderHabitStats(stats, habit) {
            const container = document.getElementById('habitDetailStats');
            const totalCount = countTotalCompletions(habit);
            
            let targetHtml = '';
            if (habit.target) {
                const targetProgress = Math.min((totalCount / habit.target) * 100, 100);
                targetHtml = `
                    <div class="habit-stat" style="grid-column: span 3; margin-bottom: 8px;">
                        <div class="habit-stat-value">${totalCount} / ${habit.target}</div>
                        <div class="habit-stat-label">Ð¾Ð±Ñ‰Ð°Ñ Ñ†ÐµÐ»ÑŒ</div>
                        <div style="margin-top: 8px;">
                            <div class="progress-bar" style="height: 8px;">
                                <div class="progress-fill" style="width: ${targetProgress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = `
                ${targetHtml}
                <div class="habit-stat">
                    <div class="habit-stat-value">${stats.completedDays}</div>
                    <div class="habit-stat-label">Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾ Ð´Ð½ÐµÐ¹</div>
                </div>
                <div class="habit-stat">
                    <div class="habit-stat-value">${stats.currentStreak}</div>
                    <div class="habit-stat-label">Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ ÑÐµÑ€Ð¸Ñ</div>
                </div>
                <div class="habit-stat">
                    <div class="habit-stat-value">${stats.maxStreak}</div>
                    <div class="habit-stat-label">Ð»ÑƒÑ‡ÑˆÐ°Ñ ÑÐµÑ€Ð¸Ñ</div>
                </div>
            `;
        }
        
        function renderHabitDetailCalendar(habit) {
            const grid = document.getElementById('habitDetailCalendarGrid');
            const title = document.getElementById('habitDetailCalendarTitle');
            const now = new Date();
            
            title.textContent = `${monthNames[detailMonth.getMonth()]} ${detailMonth.getFullYear()}`;
            
            let html = weekDays.map(day => `<div class="calendar-weekday" style="font-size: 0.65rem;">${day}</div>`).join('');
            
            const firstDay = new Date(detailMonth.getFullYear(), detailMonth.getMonth(), 1);
            const lastDay = new Date(detailMonth.getFullYear(), detailMonth.getMonth() + 1, 0);
            
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;
            
            for (let i = 0; i < startDay; i++) {
                html += '<div class="habit-calendar-day" style="background: transparent;"></div>';
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(detailMonth.getFullYear(), detailMonth.getMonth(), day);
                const dateStr = formatDate(date);
                const isFuture = date > now;
                const isTodayDate = isToday(date);
                
                const entry = data.entries[dateStr]?.[habit.id];
                let isDayCompleted = false;
                
                if (habit.type === 'binary') {
                    isDayCompleted = entry === true;
                } else {
                    const goalType = habit.goalType || 'daily';
                    if (goalType === 'daily' && habit.goal) {
                        isDayCompleted = (entry || 0) >= habit.goal;
                    } else {
                        isDayCompleted = (entry || 0) > 0;
                    }
                }
                
                let classes = ['habit-calendar-day'];
                if (isFuture) {
                    classes.push('future');
                } else if (isDayCompleted) {
                    classes.push('completed');
                } else {
                    classes.push('missed');
                }
                if (isTodayDate) classes.push('today');
                
                html += `<div class="${classes.join(' ')}">${day}</div>`;
            }
            
            grid.innerHTML = html;
        }
        
        // Close modal
        document.getElementById('habitDetailClose').addEventListener('click', () => {
            document.getElementById('habitDetailOverlay').classList.remove('active');
        });
        
        document.getElementById('habitDetailOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'habitDetailOverlay') {
                document.getElementById('habitDetailOverlay').classList.remove('active');
            }
        });
        
        // Detail calendar navigation
        document.getElementById('habitDetailPrevMonth').addEventListener('click', () => {
            const overlay = document.getElementById('habitDetailOverlay');
            const habitId = overlay.dataset.habitId;
            const habit = data.habits.find(h => h.id === habitId);
            if (habit) {
                detailMonth.setMonth(detailMonth.getMonth() - 1);
                renderHabitDetailCalendar(habit);
            }
        });
        
        document.getElementById('habitDetailNextMonth').addEventListener('click', () => {
            const overlay = document.getElementById('habitDetailOverlay');
            const habitId = overlay.dataset.habitId;
            const habit = data.habits.find(h => h.id === habitId);
            if (habit) {
                detailMonth.setMonth(detailMonth.getMonth() + 1);
                renderHabitDetailCalendar(habit);
            }
        });

        // ============ PROGRESS CALCULATION ============
        function calculateHabitProgress(habit) {
            const now = new Date();
            let startDate, endDate;
            
            switch (habit.period) {
                case 'week':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay() + 1); // Monday
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'all':
                    // Count all entries
                    startDate = new Date(2020, 0, 1);
                    endDate = now;
                    break;
            }
            
            let completed = 0;
            let total = 0;
            
            if (habit.type === 'binary') {
                // For binary: count days completed / total days
                const current = new Date(startDate);
                while (current <= endDate && current <= now) {
                    const dateStr = formatDate(current);
                    total++;
                    if (data.entries[dateStr] && data.entries[dateStr][habit.id] === true) {
                        completed++;
                    }
                    current.setDate(current.getDate() + 1);
                }
            } else {
                // For numeric: depends on goalType
                const goalType = habit.goalType || 'daily';
                const current = new Date(startDate);
                let daysCount = 0;
                
                while (current <= endDate && current <= now) {
                    const dateStr = formatDate(current);
                    if (data.entries[dateStr] && typeof data.entries[dateStr][habit.id] === 'number') {
                        completed += data.entries[dateStr][habit.id];
                    }
                    daysCount++;
                    current.setDate(current.getDate() + 1);
                }
                
                if (goalType === 'daily') {
                    // Daily goal: each day should meet the goal
                    total = daysCount * (habit.goal || 1);
                } else {
                    // Total goal: sum should meet the goal for the period
                    total = habit.goal || daysCount;
                }
            }
            
            return total > 0 ? Math.min((completed / total) * 100, 100) : 0;
        }

        function updateProgressBars() {
            // Calculate per-user progress
            const userAHabits = data.habits.filter(h => h.owner === 'A' || h.owner === 'shared');
            const userBHabits = data.habits.filter(h => h.owner === 'B' || h.owner === 'shared');
            
            const userAProgress = userAHabits.length > 0 
                ? userAHabits.reduce((sum, h) => sum + calculateHabitProgress(h), 0) / userAHabits.length 
                : 0;
            
            const userBProgress = userBHabits.length > 0 
                ? userBHabits.reduce((sum, h) => sum + calculateHabitProgress(h), 0) / userBHabits.length 
                : 0;
            
            document.getElementById('userAProgress').style.width = `${userAProgress}%`;
            document.getElementById('userAProgressText').textContent = `${Math.round(userAProgress)}%`;
            
            document.getElementById('userBProgress').style.width = `${userBProgress}%`;
            document.getElementById('userBProgressText').textContent = `${Math.round(userBProgress)}%`;
            
            // Global progress (average of both users)
            const globalProgress = (userAProgress + userBProgress) / 2;
            document.getElementById('globalProgressFill').style.width = `${globalProgress}%`;
            document.getElementById('globalProgressText').textContent = `${Math.round(globalProgress)}%`;
            
            // Update user cards with XP and levels
            updateUserCards();
        }

        // ============ ADD/EDIT HABIT FORM ============
        const addHabitBtn = document.getElementById('addHabitBtn');
        const addHabitForm = document.getElementById('addHabitForm');
        const habitTypeSelect = document.getElementById('habitType');
        const goalGroup = document.getElementById('goalGroup');
        const goalTypeGroup = document.getElementById('goalTypeGroup');
        const cancelHabitBtn = document.getElementById('cancelHabit');
        const saveHabitBtn = document.getElementById('saveHabit');
        
        let editingHabitId = null; // null = creating new, string = editing existing

        addHabitBtn.addEventListener('click', () => {
            editingHabitId = null;
            addHabitForm.classList.add('active');
            addHabitBtn.style.display = 'none';
        });

        cancelHabitBtn.addEventListener('click', () => {
            addHabitForm.classList.remove('active');
            addHabitBtn.style.display = 'block';
            clearForm();
        });

        const customPeriodGroup = document.getElementById('customPeriodGroup');
        const goalTypeSelect = document.getElementById('habitGoalType');

        habitTypeSelect.addEventListener('change', () => {
            const isNumeric = habitTypeSelect.value === 'numeric';
            goalGroup.style.display = isNumeric ? 'block' : 'none';
            goalTypeGroup.style.display = isNumeric ? 'block' : 'none';
            if (!isNumeric) {
                customPeriodGroup.style.display = 'none';
            }
        });

        goalTypeSelect.addEventListener('change', () => {
            customPeriodGroup.style.display = goalTypeSelect.value === 'custom' ? 'block' : 'none';
        });

        saveHabitBtn.addEventListener('click', () => {
            const name = document.getElementById('habitName').value.trim();
            const type = document.getElementById('habitType').value;
            const period = document.getElementById('habitPeriod').value;
            const owner = document.getElementById('habitOwner').value;
            const goal = parseInt(document.getElementById('habitGoal').value) || null;
            const goalType = document.getElementById('habitGoalType').value;
            const customPeriod = parseInt(document.getElementById('habitCustomPeriod').value) || null;
            const target = parseInt(document.getElementById('habitTarget').value) || null;
            const category = document.getElementById('habitCategory').value.trim() || null;
            
            if (!name) {
                alert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ¸');
                return;
            }
            
            if (editingHabitId) {
                // Edit existing habit
                const habitIndex = data.habits.findIndex(h => h.id === editingHabitId);
                if (habitIndex !== -1) {
                    data.habits[habitIndex] = {
                        ...data.habits[habitIndex],
                        name,
                        type,
                        period,
                        owner,
                        goal: type === 'numeric' ? goal : null,
                        goalType: type === 'numeric' ? goalType : null,
                        customPeriod: type === 'numeric' && goalType === 'custom' ? customPeriod : null,
                        target,
                        category
                    };
                }
            } else {
                // Create new habit
                const habit = {
                    id: generateId(),
                    name,
                    type,
                    period,
                    owner,
                    goal: type === 'numeric' ? goal : null,
                    goalType: type === 'numeric' ? goalType : null,
                    customPeriod: type === 'numeric' && goalType === 'custom' ? customPeriod : null,
                    target,
                    category
                };
                data.habits.push(habit);
            }
            
            saveData(data);
            
            addHabitForm.classList.remove('active');
            addHabitBtn.style.display = 'block';
            clearForm();
            
            renderHabits();
            renderCategoryFilter();
            updateCategoryDatalist();
            updateProgressBars();
        });

        function editHabit(habitId) {
            const habit = data.habits.find(h => h.id === habitId);
            if (!habit) return;
            
            editingHabitId = habitId;
            
            document.getElementById('habitName').value = habit.name;
            document.getElementById('habitType').value = habit.type;
            document.getElementById('habitPeriod').value = habit.period;
            document.getElementById('habitOwner').value = habit.owner;
            document.getElementById('habitGoal').value = habit.goal || '';
            document.getElementById('habitGoalType').value = habit.goalType || 'daily';
            document.getElementById('habitCustomPeriod').value = habit.customPeriod || '';
            document.getElementById('habitTarget').value = habit.target || '';
            document.getElementById('habitCategory').value = habit.category || '';
            
            const isNumeric = habit.type === 'numeric';
            goalGroup.style.display = isNumeric ? 'block' : 'none';
            goalTypeGroup.style.display = isNumeric ? 'block' : 'none';
            customPeriodGroup.style.display = isNumeric && habit.goalType === 'custom' ? 'block' : 'none';
            
            addHabitForm.classList.add('active');
            addHabitBtn.style.display = 'none';
        }

        function deleteHabit(habitId) {
            if (!confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÑƒ?')) return;
            
            data.habits = data.habits.filter(h => h.id !== habitId);
            
            // Also clean up entries for this habit
            Object.keys(data.entries).forEach(dateStr => {
                if (data.entries[dateStr][habitId] !== undefined) {
                    delete data.entries[dateStr][habitId];
                }
            });
            
            saveData(data);
            renderHabits();
            renderCalendar();
            updateProgressBars();
        }

        function clearForm() {
            editingHabitId = null;
            document.getElementById('habitName').value = '';
            document.getElementById('habitType').value = 'binary';
            document.getElementById('habitPeriod').value = 'week';
            document.getElementById('habitOwner').value = 'shared';
            document.getElementById('habitGoal').value = '';
            document.getElementById('habitGoalType').value = 'daily';
            document.getElementById('habitCustomPeriod').value = '';
            document.getElementById('habitTarget').value = '';
            document.getElementById('habitCategory').value = '';
            goalGroup.style.display = 'none';
            goalTypeGroup.style.display = 'none';
            customPeriodGroup.style.display = 'none';
        }

        // ============ USER VIEW SWITCHING ============
        function switchUserView(userId) {
            userFilter = userId;
            
            // Update UI states
            document.getElementById('userCardA').classList.remove('active');
            document.getElementById('userCardB').classList.remove('active');
            document.getElementById('globalProgressCard').classList.remove('active');
            
            const viewName = document.getElementById('currentViewName');
            viewName.classList.remove('user-b', 'all');
            
            if (userId === 'A') {
                document.getElementById('userCardA').classList.add('active');
                viewName.textContent = profiles.A.name + ' ðŸ¦Š';
                viewName.classList.remove('user-b', 'all');
            } else if (userId === 'B') {
                document.getElementById('userCardB').classList.add('active');
                viewName.textContent = profiles.B.name + ' ðŸ¦‹';
                viewName.classList.add('user-b');
            } else {
                document.getElementById('globalProgressCard').classList.add('active');
                viewName.textContent = 'Ð’ÑÐµ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ¸';
                viewName.classList.add('all');
            }
            
            renderHabits();
            renderCategoryFilter();
        }

        function updateViewIndicator() {
            const viewName = document.getElementById('currentViewName');
            viewName.classList.remove('user-b', 'all');
            
            if (userFilter === 'A') {
                viewName.textContent = profiles.A.name + ' ðŸ¦Š';
            } else if (userFilter === 'B') {
                viewName.textContent = profiles.B.name + ' ðŸ¦‹';
                viewName.classList.add('user-b');
            } else {
                viewName.textContent = 'Ð’ÑÐµ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ¸';
                viewName.classList.add('all');
            }
        }

        // ============ CALENDAR NAVIGATION ============
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        });

        // ============ MOTIVATIONAL QUOTES ============
        const quotes = [
            'Ð›ÑƒÑ‡ÑˆÐµ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾, Ñ‡ÐµÐ¼ Ð¸Ð´ÐµÐ°Ð»ÑŒÐ½Ð¾. ÐšÐ°Ð¶Ð´Ñ‹Ð¹ ÑˆÐ°Ð³ â€” ÑÑ‚Ð¾ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ.',
            'ÐœÐ°Ð»ÐµÐ½ÑŒÐºÐ¸Ðµ ÑˆÐ°Ð³Ð¸ Ð²ÐµÐ´ÑƒÑ‚ Ðº Ð±Ð¾Ð»ÑŒÑˆÐ¸Ð¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð°Ð¼.',
            'Ð¢Ñ‹ ÑƒÐ¶Ðµ Ð¼Ð¾Ð»Ð¾Ð´ÐµÑ†, Ñ‡Ñ‚Ð¾ Ð¾Ñ‚ÐºÑ€Ñ‹Ð» ÑÑ‚Ñƒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ.',
            'ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ, Ð° Ð½Ðµ ÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½ÑÑ‚Ð²Ð¾.',
            'ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ â€” Ð½Ð¾Ð²Ð°Ñ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ.',
            'ÐŸÑ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ¸ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÑŽÑ‚ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€.',
            'Ð”ÐµÐ»Ð°Ð¹ Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑˆÑŒ, Ñ Ñ‚ÐµÐ¼, Ñ‡Ñ‚Ð¾ ÐµÑÑ‚ÑŒ.',
            'Ð’Ð°Ð¶Ð½Ð¾ Ð½Ðµ ÑƒÐ¿Ð°ÑÑ‚ÑŒ, Ð° Ð¿Ð¾Ð´Ð½ÑÑ‚ÑŒÑÑ.',
            'ÐšÐ°Ð¶Ð´Ð¾Ðµ ÑƒÑÐ¸Ð»Ð¸Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ.',
            'Ð¢Ñ‹ ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÑˆÑŒÑÑ Ð»ÑƒÑ‡ÑˆÐµ, Ñ‡ÐµÐ¼ Ð´ÑƒÐ¼Ð°ÐµÑˆÑŒ.',
        ];

        function updateMotivation() {
            const el = document.getElementById('motivation');
            el.textContent = quotes[Math.floor(Math.random() * quotes.length)];
        }

        // ============ THEME ============
        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('themeToggle').textContent = 'â˜€ï¸';
            } else {
                document.body.classList.remove('light-theme');
                document.getElementById('themeToggle').textContent = 'ðŸŒ™';
            }
            // Update meta theme-color
            document.querySelector('meta[name="theme-color"]').content = theme === 'light' ? '#f8fafc' : '#0f0f1a';
        }

        function toggleTheme() {
            settings.theme = settings.theme === 'dark' ? 'light' : 'dark';
            saveSettings(settings);
            applyTheme(settings.theme);
            updateThemeToggleUI();
        }

        function updateThemeToggleUI() {
            const toggle = document.getElementById('themeToggleSettings');
            if (settings.theme === 'light') {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        document.getElementById('themeToggleSettings').addEventListener('click', toggleTheme);

        // ============ PAUSE MODE ============
        function updatePauseModeUI() {
            const banner = document.getElementById('pauseBanner');
            const toggle = document.getElementById('pauseToggle');
            
            if (settings.pauseMode) {
                banner.classList.add('active');
                toggle.classList.add('active');
            } else {
                banner.classList.remove('active');
                toggle.classList.remove('active');
            }
        }

        function togglePauseMode() {
            settings.pauseMode = !settings.pauseMode;
            if (settings.pauseMode) {
                settings.pauseStartDate = formatDate(new Date());
            } else {
                // Mark paused days
                if (settings.pauseStartDate) {
                    const start = new Date(settings.pauseStartDate);
                    const end = new Date();
                    const current = new Date(start);
                    
                    if (!data.pausedDays) data.pausedDays = [];
                    
                    while (current <= end) {
                        const dateStr = formatDate(current);
                        if (!data.pausedDays.includes(dateStr)) {
                            data.pausedDays.push(dateStr);
                        }
                        current.setDate(current.getDate() + 1);
                    }
                    saveData(data);
                }
                settings.pauseStartDate = null;
            }
            saveSettings(settings);
            updatePauseModeUI();
        }

        document.getElementById('pauseToggle').addEventListener('click', togglePauseMode);
        document.getElementById('endPauseBtn').addEventListener('click', togglePauseMode);

        // ============ SETTINGS MODAL ============
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settingsOverlay').classList.add('active');
            updateThemeToggleUI();
            updatePauseModeUI();
        });

        document.getElementById('settingsClose').addEventListener('click', () => {
            document.getElementById('settingsOverlay').classList.remove('active');
        });

        document.getElementById('settingsOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'settingsOverlay') {
                document.getElementById('settingsOverlay').classList.remove('active');
            }
        });

        // ============ EXPORT / IMPORT ============
        document.getElementById('exportDataBtn').addEventListener('click', () => {
            const exportData = {
                habits: data.habits,
                entries: data.entries,
                pausedDays: data.pausedDays || [],
                settings: settings,
                profiles: profiles,
                exportDate: new Date().toISOString(),
                version: '2.1'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habit-tracker-backup-${formatDate(new Date())}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById('importDataBtn').addEventListener('click', () => {
            document.getElementById('importFileInput').click();
        });

        document.getElementById('importFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    if (importedData.habits && importedData.entries) {
                        if (confirm('Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ? Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð±ÑƒÐ´ÑƒÑ‚ Ð·Ð°Ð¼ÐµÐ½ÐµÐ½Ñ‹.')) {
                            data.habits = importedData.habits || [];
                            data.entries = importedData.entries || {};
                            data.pausedDays = importedData.pausedDays || [];
                            saveData(data);
                            
                            if (importedData.settings) {
                                settings = { ...defaultSettings, ...importedData.settings };
                                saveSettings(settings);
                                applyTheme(settings.theme);
                            }
                            
                            if (importedData.profiles) {
                                profiles = {
                                    A: { ...defaultProfiles.A, ...importedData.profiles.A },
                                    B: { ...defaultProfiles.B, ...importedData.profiles.B }
                                };
                                saveProfiles(profiles);
                            }
                            
                            renderCalendar();
                            renderHabits();
                            renderCategoryFilter();
                            updateProgressBars();
                            updatePauseModeUI();
                            updateUserCards();
                            
                            alert('Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹!');
                        }
                    } else {
                        alert('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ„Ð°Ð¹Ð»Ð°');
                    }
                } catch (err) {
                    alert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ñ‡Ñ‚ÐµÐ½Ð¸Ð¸ Ñ„Ð°Ð¹Ð»Ð°: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // Reset input
        });

        // ============ DANGER ZONE ============
        document.getElementById('resetProgressBtn').addEventListener('click', () => {
            if (confirm('Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð²ÐµÑÑŒ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ? ÐŸÑ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ¸ Ð¾ÑÑ‚Ð°Ð½ÑƒÑ‚ÑÑ, Ð½Ð¾ Ð²ÑÐµ Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐ¸ Ð±ÑƒÐ´ÑƒÑ‚ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹.')) {
                data.entries = {};
                data.pausedDays = [];
                saveData(data);
                renderCalendar();
                renderHabits();
                updateProgressBars();
                alert('ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½');
            }
        });

        document.getElementById('deleteAllBtn').addEventListener('click', () => {
            if (confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð’Ð¡Ð• Ð´Ð°Ð½Ð½Ñ‹Ðµ? Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ»ÑŒÐ·Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ!')) {
                if (confirm('Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹? Ð’ÑÐµ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ¸ Ð¸ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ Ð±ÑƒÐ´ÑƒÑ‚ Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ñ‹ Ð½Ð°Ð²ÑÐµÐ³Ð´Ð°.')) {
                    data = { ...defaultData };
                    saveData(data);
                    renderCalendar();
                    renderHabits();
                    renderCategoryFilter();
                    updateProgressBars();
                    alert('Ð’ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹');
                }
            }
        });

        // ============ ANALYTICS ============
        document.getElementById('analyticsBtn').addEventListener('click', () => {
            document.getElementById('analyticsOverlay').classList.add('active');
            renderAnalytics();
        });

        document.getElementById('analyticsClose').addEventListener('click', () => {
            document.getElementById('analyticsOverlay').classList.remove('active');
        });

        document.getElementById('analyticsOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'analyticsOverlay') {
                document.getElementById('analyticsOverlay').classList.remove('active');
            }
        });

        document.querySelectorAll('.analytics-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.analytics-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentAnalyticsTab = tab.dataset.tab;
                renderAnalyticsContent();
            });
        });

        function renderAnalytics() {
            renderAnalyticsStats();
            renderAnalyticsContent();
        }

        function renderAnalyticsStats() {
            const container = document.getElementById('analyticsStats');
            const now = new Date();
            
            // Calculate overall stats
            let totalCompletions = 0;
            let totalDays = 0;
            let activeDays = new Set();
            let longestStreak = 0;
            let currentStreak = 0;
            
            // Count total completions across all habits
            Object.keys(data.entries).forEach(dateStr => {
                const dayData = data.entries[dateStr];
                let dayHasActivity = false;
                Object.keys(dayData).forEach(habitId => {
                    const value = dayData[habitId];
                    if (value === true || (typeof value === 'number' && value > 0)) {
                        totalCompletions++;
                        dayHasActivity = true;
                    }
                });
                if (dayHasActivity) {
                    activeDays.add(dateStr);
                }
            });
            
            // Calculate current streak (days in a row with at least one completion)
            for (let i = 0; i <= 365; i++) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = formatDate(date);
                
                if (activeDays.has(dateStr)) {
                    currentStreak++;
                } else if (i > 0) {
                    break;
                }
            }
            
            // Calculate longest streak
            const sortedDates = Array.from(activeDays).sort();
            let tempStreak = 0;
            let prevDate = null;
            
            sortedDates.forEach(dateStr => {
                const date = new Date(dateStr);
                if (prevDate) {
                    const diff = (date - prevDate) / (1000 * 60 * 60 * 24);
                    if (diff === 1) {
                        tempStreak++;
                    } else {
                        tempStreak = 1;
                    }
                } else {
                    tempStreak = 1;
                }
                if (tempStreak > longestStreak) longestStreak = tempStreak;
                prevDate = date;
            });
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-card-value">${data.habits.length}</div>
                    <div class="stat-card-label">Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐµÐº</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value">${totalCompletions}</div>
                    <div class="stat-card-label">Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value">${activeDays.size}</div>
                    <div class="stat-card-label">Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð´Ð½ÐµÐ¹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value">${currentStreak}</div>
                    <div class="stat-card-label">Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ ÑÐµÑ€Ð¸Ñ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value">${longestStreak}</div>
                    <div class="stat-card-label">Ð»ÑƒÑ‡ÑˆÐ°Ñ ÑÐµÑ€Ð¸Ñ</div>
                </div>
            `;
        }

        function renderAnalyticsContent() {
            const container = document.getElementById('analyticsContent');
            
            switch (currentAnalyticsTab) {
                case 'weekly':
                    renderWeeklyChart(container);
                    break;
                case 'monthly':
                    renderMonthlyChart(container);
                    break;
                case 'heatmap':
                    renderHeatmap(container);
                    break;
            }
        }

        function renderWeeklyChart(container) {
            const now = new Date();
            const weekDaysShort = ['ÐŸÐ½', 'Ð’Ñ‚', 'Ð¡Ñ€', 'Ð§Ñ‚', 'ÐŸÑ‚', 'Ð¡Ð±', 'Ð’Ñ'];
            
            // Get data for last 7 days
            const weekData = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = formatDate(date);
                
                let completions = 0;
                if (data.entries[dateStr]) {
                    Object.values(data.entries[dateStr]).forEach(value => {
                        if (value === true || (typeof value === 'number' && value > 0)) {
                            completions++;
                        }
                    });
                }
                
                const dayOfWeek = date.getDay();
                const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                
                weekData.push({
                    label: weekDaysShort[adjustedDay],
                    value: completions,
                    date: dateStr
                });
            }
            
            const maxValue = Math.max(...weekData.map(d => d.value), 1);
            
            container.innerHTML = `
                <div class="chart-container">
                    <div class="chart-title">Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 7 Ð´Ð½ÐµÐ¹</div>
                    <div class="bar-chart">
                        ${weekData.map(d => `
                            <div class="bar-item">
                                <div class="bar" style="height: ${(d.value / maxValue) * 120}px"></div>
                                <div class="bar-label">${d.label}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð¿Ð¾ Ð´Ð½ÑÐ¼</div>
                    ${weekData.map(d => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <span style="color: #94a3b8;">${d.label} (${d.date.split('-').slice(1).join('.')})</span>
                            <span style="color: #f472b6; font-weight: 600;">${d.value} Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¹</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderMonthlyChart(container) {
            const now = new Date();
            
            // Get data for last 4 weeks
            const weekData = [];
            for (let week = 3; week >= 0; week--) {
                let weekTotal = 0;
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - (week * 7 + 6));
                const weekEnd = new Date(now);
                weekEnd.setDate(now.getDate() - (week * 7));
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    const dateStr = formatDate(date);
                    
                    if (data.entries[dateStr]) {
                        Object.values(data.entries[dateStr]).forEach(value => {
                            if (value === true || (typeof value === 'number' && value > 0)) {
                                weekTotal++;
                            }
                        });
                    }
                }
                
                weekData.push({
                    label: `ÐÐµÐ´ÐµÐ»Ñ ${4 - week}`,
                    value: weekTotal,
                    range: `${weekStart.getDate()}.${weekStart.getMonth()+1} - ${weekEnd.getDate()}.${weekEnd.getMonth()+1}`
                });
            }
            
            const maxValue = Math.max(...weekData.map(d => d.value), 1);
            
            container.innerHTML = `
                <div class="chart-container">
                    <div class="chart-title">Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 4 Ð½ÐµÐ´ÐµÐ»Ð¸</div>
                    <div class="bar-chart">
                        ${weekData.map(d => `
                            <div class="bar-item">
                                <div class="bar" style="height: ${(d.value / maxValue) * 120}px"></div>
                                <div class="bar-label">${d.label}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ÐŸÐ¾ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡ÐºÐ°Ð¼ (Ð·Ð° Ð¼ÐµÑÑÑ†)</div>
                    ${data.habits.map(habit => {
                        let count = 0;
                        for (let i = 0; i < 30; i++) {
                            const date = new Date(now);
                            date.setDate(now.getDate() - i);
                            const dateStr = formatDate(date);
                            const entry = data.entries[dateStr]?.[habit.id];
                            if (entry === true || (typeof entry === 'number' && entry > 0)) {
                                count++;
                            }
                        }
                        const percentage = Math.round((count / 30) * 100);
                        return `
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="color: #e2e8f0;">${habit.name}</span>
                                    <span style="color: #94a3b8;">${count}/30 Ð´Ð½ÐµÐ¹ (${percentage}%)</span>
                                </div>
                                <div class="progress-bar" style="height: 6px;">
                                    <div class="progress-fill" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderHeatmap(container) {
            const now = new Date();
            const weeks = 12; // 12 weeks of data
            
            // Generate heatmap data
            const heatmapData = [];
            for (let i = weeks * 7 - 1; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = formatDate(date);
                
                let completions = 0;
                if (data.entries[dateStr]) {
                    Object.values(data.entries[dateStr]).forEach(value => {
                        if (value === true || (typeof value === 'number' && value > 0)) {
                            completions++;
                        }
                    });
                }
                
                heatmapData.push({
                    date: dateStr,
                    value: completions
                });
            }
            
            const maxValue = Math.max(...heatmapData.map(d => d.value), 1);
            
            function getLevel(value) {
                if (value === 0) return 0;
                const ratio = value / maxValue;
                if (ratio <= 0.2) return 1;
                if (ratio <= 0.4) return 2;
                if (ratio <= 0.6) return 3;
                if (ratio <= 0.8) return 4;
                return 5;
            }
            
            container.innerHTML = `
                <div class="chart-container">
                    <div class="chart-title">ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ ${weeks} Ð½ÐµÐ´ÐµÐ»ÑŒ</div>
                    <div class="heatmap">
                        ${heatmapData.map(d => `
                            <div class="heatmap-cell level-${getLevel(d.value)}" title="${d.date}: ${d.value} Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¹"></div>
                        `).join('')}
                    </div>
                    <div class="heatmap-legend">
                        <span>ÐœÐµÐ½ÑŒÑˆÐµ</span>
                        <div class="heatmap-legend-cell" style="background: rgba(255,255,255,0.05);"></div>
                        <div class="heatmap-legend-cell level-1" style="background: rgba(236, 72, 153, 0.2);"></div>
                        <div class="heatmap-legend-cell level-2" style="background: rgba(236, 72, 153, 0.4);"></div>
                        <div class="heatmap-legend-cell level-3" style="background: rgba(236, 72, 153, 0.6);"></div>
                        <div class="heatmap-legend-cell level-4" style="background: rgba(236, 72, 153, 0.8);"></div>
                        <div class="heatmap-legend-cell level-5" style="background: #ec4899;"></div>
                        <span>Ð‘Ð¾Ð»ÑŒÑˆÐµ</span>
                    </div>
                </div>
            `;
        }

        // ============ CHARACTER PROFILES ============
        const avatarEmojis = [
            'ðŸ¦Š', 'ðŸ¦‹', 'ðŸ±', 'ðŸ¶', 'ðŸ¼', 'ðŸ¨', 'ðŸ¦', 'ðŸ¯', 'ðŸ»', 'ðŸ°',
            'ðŸ¦„', 'ðŸ²', 'ðŸ¦…', 'ðŸ¦‰', 'ðŸº', 'ðŸ¦ˆ', 'ðŸ¬', 'ðŸ¦©', 'ðŸ¦š', 'ðŸ¢',
            'ðŸ§™â€â™‚ï¸', 'ðŸ§™â€â™€ï¸', 'ðŸ¦¸â€â™‚ï¸', 'ðŸ¦¸â€â™€ï¸', 'ðŸ§šâ€â™€ï¸', 'ðŸ§œâ€â™€ï¸', 'ðŸ§â€â™€ï¸', 'ðŸ§›â€â™‚ï¸', 'ðŸ¥·', 'ðŸ‘¸',
            'ðŸ¤´', 'ðŸŽ…', 'ðŸ§‘â€ðŸš€', 'ðŸ§‘â€ðŸŽ¨', 'ðŸ§‘â€ðŸ”¬', 'ðŸ§‘â€ðŸ’»', 'ðŸ§‘â€ðŸŽ¤', 'ðŸ§‘â€ðŸ³', 'ðŸ§‘â€ðŸŒ¾', 'ðŸ§‘â€âš•ï¸',
            'ðŸ˜Ž', 'ðŸ¤“', 'ðŸ¥³', 'ðŸ˜‡', 'ðŸ¤©', 'ðŸ¥°', 'ðŸ˜Š', 'ðŸŒŸ', 'â­', 'ðŸ’«',
            'ðŸŒˆ', 'ðŸ”¥', 'ðŸ’Ž', 'ðŸŽ¯', 'ðŸ†', 'ðŸŽª', 'ðŸŽ­', 'ðŸŽ¨', 'ðŸŽ¬', 'ðŸŽ®'
        ];

        function calculateUserXP(userId) {
            let totalXP = 0;
            const userHabits = data.habits.filter(h => h.owner === userId || h.owner === 'shared');
            
            Object.keys(data.entries).forEach(dateStr => {
                const dayData = data.entries[dateStr];
                userHabits.forEach(habit => {
                    const value = dayData[habit.id];
                    if (habit.type === 'binary' && value === true) {
                        totalXP += 10; // 10 XP per completed binary habit
                    } else if (habit.type === 'numeric' && typeof value === 'number' && value > 0) {
                        totalXP += Math.min(value, 20); // Up to 20 XP for numeric
                    }
                });
            });
            
            return totalXP;
        }

        function calculateLevel(xp) {
            // Level formula: each level requires level * 100 XP
            // Level 1: 0-99, Level 2: 100-299, Level 3: 300-599, etc.
            let level = 1;
            let xpRequired = 100;
            let totalRequired = 0;
            
            while (xp >= totalRequired + xpRequired) {
                totalRequired += xpRequired;
                level++;
                xpRequired = level * 100;
            }
            
            const xpInCurrentLevel = xp - totalRequired;
            const xpForNextLevel = xpRequired;
            
            return { level, xpInCurrentLevel, xpForNextLevel, totalXP: xp };
        }

        function updateUserCards() {
            ['A', 'B'].forEach(userId => {
                const profile = profiles[userId];
                const xp = calculateUserXP(userId);
                const levelInfo = calculateLevel(xp);
                const stats = calculateUserStats(userId);
                const streakBadge = getStreakBadge(stats.streak);
                
                // Update profile data
                profiles[userId].xp = xp;
                profiles[userId].level = levelInfo.level;
                
                // Update card UI
                document.getElementById(`user${userId}Avatar`).textContent = profile.avatar;
                document.getElementById(`user${userId}Name`).textContent = profile.name;
                
                // Level with streak badge
                let levelHtml = `Ð£Ñ€. ${levelInfo.level}`;
                if (streakBadge) {
                    levelHtml += ` <span class="streak-badge ${streakBadge.class}">${streakBadge.icon}${streakBadge.text}</span>`;
                }
                document.getElementById(`user${userId}Level`).innerHTML = levelHtml;
                
                document.getElementById(`user${userId}XpText`).textContent = 
                    `${levelInfo.xpInCurrentLevel} / ${levelInfo.xpForNextLevel} XP`;
            });
            
            saveProfiles(profiles);
        }

        function calculateUserStats(userId) {
            const userHabits = data.habits.filter(h => h.owner === userId || h.owner === 'shared');
            const now = new Date();
            
            let totalCompletions = 0;
            let activeDays = new Set();
            let currentStreak = 0;
            
            // Count completions
            Object.keys(data.entries).forEach(dateStr => {
                const dayData = data.entries[dateStr];
                let dayHasActivity = false;
                
                userHabits.forEach(habit => {
                    const value = dayData[habit.id];
                    if (value === true || (typeof value === 'number' && value > 0)) {
                        totalCompletions++;
                        dayHasActivity = true;
                    }
                });
                
                if (dayHasActivity) {
                    activeDays.add(dateStr);
                }
            });
            
            // Calculate current streak
            for (let i = 0; i <= 365; i++) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = formatDate(date);
                
                if (activeDays.has(dateStr)) {
                    currentStreak++;
                } else if (i > 0) {
                    break;
                }
            }
            
            return {
                completions: totalCompletions,
                activeDays: activeDays.size,
                streak: currentStreak
            };
        }

        function showProfile(userId) {
            currentProfileUser = userId;
            const profile = profiles[userId];
            const stats = calculateUserStats(userId);
            const levelInfo = calculateLevel(profiles[userId].xp);
            
            // Update header
            const header = document.getElementById('profileHeader');
            const levelBadge = document.getElementById('profileLevelBadge');
            const avatar = document.getElementById('profileAvatar');
            
            if (userId === 'B') {
                header.classList.add('user-b');
                levelBadge.classList.add('user-b');
                avatar.classList.add('user-b');
            } else {
                header.classList.remove('user-b');
                levelBadge.classList.remove('user-b');
                avatar.classList.remove('user-b');
            }
            
            // Update profile data
            document.getElementById('profileAvatar').textContent = profile.avatar;
            document.getElementById('profileName').textContent = profile.name;
            document.getElementById('profileTitle').textContent = profile.title;
            document.getElementById('profileLevelBadge').textContent = `Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ ${levelInfo.level}`;
            
            // XP bar
            document.getElementById('profileXpValue').textContent = 
                `${levelInfo.xpInCurrentLevel} / ${levelInfo.xpForNextLevel} XP`;
            document.getElementById('profileXpFill').style.width = 
                `${(levelInfo.xpInCurrentLevel / levelInfo.xpForNextLevel) * 100}%`;
            
            // Stats
            document.getElementById('profileStreak').textContent = stats.streak;
            document.getElementById('profileCompleted').textContent = stats.completions;
            document.getElementById('profileDays').textContent = stats.activeDays;
            
            // Superpower (single line)
            const superpowerText = document.getElementById('superpowerText');
            if (superpowerText) {
                superpowerText.textContent = profile.superpower || 'ÐÐ°Ð¶Ð¼Ð¸ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ';
            }
            
            // Traits (5 slots grid)
            renderTraits(userId);
            
            // Bio
            document.getElementById('profileBio').textContent = profile.bio;
            
            // Render achievements
            renderAchievements(userId);
            
            // Show modal
            document.getElementById('profileOverlay').classList.add('active');
        }

        // Note: toggleProfileEdit and saveProfile replaced by inline editing functions

        function openEmojiPicker() {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = avatarEmojis.map(emoji => 
                `<button class="emoji-option" onclick="selectAvatar('${emoji}')">${emoji}</button>`
            ).join('');
            
            document.getElementById('emojiPickerOverlay').classList.add('active');
        }

        function selectAvatar(emoji) {
            profiles[currentProfileUser].avatar = emoji;
            saveProfiles(profiles);
            
            document.getElementById('profileAvatar').textContent = emoji;
            document.getElementById(`user${currentProfileUser}Avatar`).textContent = emoji;
            
            document.getElementById('emojiPickerOverlay').classList.remove('active');
        }

        // Close profile modal
        document.getElementById('profileClose').addEventListener('click', () => {
            document.getElementById('profileOverlay').classList.remove('active');
        });

        document.getElementById('profileOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'profileOverlay') {
                document.getElementById('profileOverlay').classList.remove('active');
            }
        });

        // Close emoji picker
        document.getElementById('emojiPickerOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'emojiPickerOverlay') {
                document.getElementById('emojiPickerOverlay').classList.remove('active');
            }
        });

        // ============ PWA / SERVICE WORKER ============
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => {
                    console.log('ServiceWorker registration failed (optional):', err);
                });
            });
        }

        // ============ INIT ============
        function init() {
            // Apply saved theme
            applyTheme(settings.theme);
            updatePauseModeUI();
            updateUserCards();
            
            // Set initial view to "all" and mark it active
            userFilter = 'all';
            document.getElementById('globalProgressCard').classList.add('active');
            updateViewIndicator();
            
            renderCalendar();
            renderHabits();
            renderCategoryFilter();
            updateCategoryDatalist();
            updateProgressBars();
            updateMotivation();
            updateSelectedDateText();
            
            // Initialize new features
            renderChallenges();
            updateSoundToggleUI();
            
            // Check achievements for both users on startup (silently, without popups)
            // Just ensure data is ready
            
            // Store current levels to detect level-ups
            previousLevels = { 
                A: calculateLevel(calculateUserXP('A')).level, 
                B: calculateLevel(calculateUserXP('B')).level 
            };
        }

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f0f1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Habit Tracker">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.svg">
    <link rel="icon" type="image/svg+xml" href="icon-192.svg">
    <title>Habit Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e2e8f0;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(135deg, #f472b6 0%, #c084fc 50%, #818cf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-tabs {
            display: flex;
            gap: 8px;
        }

        .user-tab {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-tab:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(244, 114, 182, 0.3);
        }

        .user-tab.active {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }

        .user-tab[data-user="B"].active {
            background: linear-gradient(135deg, #a855f7 0%, #c084fc 100%);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
        }

        /* Global Progress Bar */
        .global-progress {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .global-progress h3 {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, #ec4899 0%, #f472b6 50%, #c084fc 100%);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.5);
        }

        .progress-text {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-top: 8px;
            text-align: right;
        }

        /* Main Layout */
        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Calendar */
        .calendar-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-nav button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calendar-nav button:hover {
            background: rgba(244, 114, 182, 0.2);
            border-color: rgba(244, 114, 182, 0.3);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-weekday {
            text-align: center;
            font-size: 0.75rem;
            color: #64748b;
            padding: 8px 0;
            font-weight: 500;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            color: #cbd5e1;
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .calendar-day.empty {
            cursor: default;
        }

        .calendar-day.empty:hover {
            background: transparent;
        }

        .calendar-day.today {
            font-weight: 600;
            border: 2px solid #f472b6;
            color: #f472b6;
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }

        .calendar-day.has-activity {
            background: rgba(244, 114, 182, 0.2);
        }

        .calendar-day.has-activity.selected {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        }

        /* Habits Section */
        .habits-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .habits-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .habits-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .selected-date {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .habits-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .habit-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .habit-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(244, 114, 182, 0.2);
        }

        .habit-item:hover .habit-actions {
            opacity: 1;
        }

        .habit-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .habit-action-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 0.8rem;
        }

        .habit-action-btn:hover {
            background: rgba(244, 114, 182, 0.2);
            color: #f472b6;
        }

        .habit-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .habit-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #475569;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .habit-checkbox.checked {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            border-color: #f472b6;
            color: white;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.4);
        }

        .habit-checkbox svg {
            width: 14px;
            height: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .habit-checkbox.checked svg {
            opacity: 1;
        }

        .habit-info {
            flex: 1;
            min-width: 0;
        }

        .habit-name {
            font-weight: 500;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e2e8f0;
        }

        .habit-owner {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .habit-owner.owner-A {
            background: rgba(236, 72, 153, 0.2);
            color: #f472b6;
        }

        .habit-owner.owner-B {
            background: rgba(168, 85, 247, 0.2);
            color: #c084fc;
        }

        .habit-owner.owner-shared {
            background: rgba(129, 140, 248, 0.2);
            color: #a5b4fc;
        }

        .habit-progress {
            margin-top: 6px;
        }

        .habit-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .habit-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
            background: linear-gradient(90deg, #ec4899 0%, #f472b6 100%);
        }

        .habit-progress-text {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 4px;
        }

        /* Numeric Input */
        .numeric-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .numeric-input {
            width: 60px;
            padding: 6px 8px;
            border: 2px solid #475569;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: center;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            -moz-appearance: textfield;
        }

        .numeric-input::-webkit-outer-spin-button,
        .numeric-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .numeric-input:focus {
            outline: none;
            border-color: #f472b6;
            box-shadow: 0 0 10px rgba(244, 114, 182, 0.3);
        }

        .numeric-input.completed {
            border-color: #f472b6;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2) 0%, rgba(244, 114, 182, 0.2) 100%);
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.4);
            color: #f9a8d4;
        }

        .numeric-input.incomplete {
            border-color: #f87171;
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.15) 0%, rgba(239, 68, 68, 0.15) 100%);
            box-shadow: 0 0 10px rgba(248, 113, 113, 0.3);
            color: #fca5a5;
        }

        .numeric-goal {
            font-size: 0.8rem;
            color: #64748b;
        }

        /* Target Progress Badge */
        .target-progress {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 8px;
            background: rgba(244, 114, 182, 0.15);
            border-radius: 12px;
            font-size: 0.7rem;
            color: #f472b6;
            margin-left: 8px;
        }

        .target-progress-bar {
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .target-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ec4899 0%, #f472b6 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Habit Detail Modal */
        .habit-detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .habit-detail-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .habit-detail-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .habit-detail-overlay.active .habit-detail-modal {
            transform: scale(1);
        }

        .habit-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .habit-detail-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .habit-detail-close {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .habit-detail-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .habit-detail-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .habit-stat {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .habit-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #f472b6 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .habit-stat-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 4px;
        }

        .habit-detail-calendar {
            margin-bottom: 16px;
        }

        .habit-detail-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .habit-detail-calendar-header h4 {
            font-size: 0.9rem;
            color: #94a3b8;
            margin: 0;
        }

        .habit-detail-nav {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .habit-detail-nav:hover {
            background: rgba(244, 114, 182, 0.2);
            color: #f472b6;
        }

        .habit-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .habit-calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #64748b;
            background: rgba(255, 255, 255, 0.03);
        }

        .habit-calendar-day.completed {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(236, 72, 153, 0.3);
        }

        .habit-calendar-day.missed {
            background: rgba(255, 255, 255, 0.05);
            color: #475569;
        }

        .habit-calendar-day.future {
            opacity: 0.3;
        }

        .habit-calendar-day.today {
            border: 2px solid #f472b6;
        }

        .habit-detail-legend {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 12px;
            font-size: 0.75rem;
            color: #64748b;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        .legend-dot.completed {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        }

        .legend-dot.missed {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Add Habit Form */
        .add-habit-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed #475569;
            border-radius: 12px;
            background: transparent;
            color: #94a3b8;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-habit-btn:hover {
            border-color: #f472b6;
            color: #f472b6;
            background: rgba(244, 114, 182, 0.1);
        }

        .add-habit-form {
            display: none;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-top: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .add-habit-form.active {
            display: flex;
        }

        .form-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 120px;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 4px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #475569;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #f472b6;
            box-shadow: 0 0 10px rgba(244, 114, 182, 0.3);
        }

        .form-group select option {
            background: #1a1a2e;
            color: #e2e8f0;
        }

        .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* User Progress */
        .user-progress {
            margin-top: 24px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .user-progress {
                grid-template-columns: 1fr;
            }
        }

        .user-progress-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-progress-card h3 {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-progress-card h3 .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .user-progress-card h3 .dot.user-a {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            box-shadow: 0 0 10px rgba(236, 72, 153, 0.5);
        }

        .user-progress-card h3 .dot.user-b {
            background: linear-gradient(135deg, #a855f7 0%, #c084fc 100%);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state p {
            margin-bottom: 8px;
        }

        /* Motivational text */
        .motivation {
            text-align: center;
            padding: 16px;
            font-size: 0.9rem;
            color: #64748b;
            font-style: italic;
        }

        /* Glow effects */
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.3); }
            50% { box-shadow: 0 0 30px rgba(236, 72, 153, 0.5); }
        }

        .global-progress .progress-fill {
            animation: glow 3s ease-in-out infinite;
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 1.2rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .icon-btn:hover {
            background: rgba(244, 114, 182, 0.2);
            color: #f472b6;
            border-color: rgba(244, 114, 182, 0.3);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: relative;
        }

        /* Settings Panel */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .settings-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .settings-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .settings-overlay.active .settings-modal {
            transform: scale(1);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .settings-section {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .settings-section h4 {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .settings-row label {
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .settings-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        /* Pause Mode Banner */
        .pause-banner {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 12px;
        }

        .pause-banner.active {
            display: flex;
        }

        .pause-banner-icon {
            font-size: 1.5rem;
        }

        .pause-banner-text {
            flex: 1;
        }

        .pause-banner-text h4 {
            color: #fbbf24;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .pause-banner-text p {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .pause-banner-end {
            padding: 6px 12px;
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 8px;
            color: #fbbf24;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pause-banner-end:hover {
            background: rgba(251, 191, 36, 0.3);
        }

        /* Categories */
        .category-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(129, 140, 248, 0.2);
            color: #a5b4fc;
            margin-left: 6px;
        }

        .category-filter {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .category-chip {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .category-chip:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .category-chip.active {
            background: rgba(129, 140, 248, 0.2);
            color: #a5b4fc;
            border-color: rgba(129, 140, 248, 0.3);
        }

        /* Drag and Drop */
        .habit-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
        }

        .habit-item.drag-over {
            border-color: #f472b6;
            background: rgba(244, 114, 182, 0.1);
        }

        .habit-drag-handle {
            cursor: grab;
            color: #475569;
            padding: 4px;
            margin-right: 8px;
            font-size: 1rem;
            transition: color 0.2s;
        }

        .habit-drag-handle:hover {
            color: #94a3b8;
        }

        .habit-drag-handle:active {
            cursor: grabbing;
        }

        /* Analytics Modal */
        .analytics-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .analytics-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .analytics-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 24px;
            max-width: 700px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .analytics-overlay.active .analytics-modal {
            transform: scale(1);
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .analytics-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .analytics-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .analytics-tab {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .analytics-tab:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .analytics-tab.active {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
        }

        .analytics-content {
            min-height: 300px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 16px;
        }

        /* Bar Chart */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 150px;
            gap: 8px;
            padding-top: 20px;
        }

        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .bar {
            width: 100%;
            max-width: 40px;
            background: linear-gradient(180deg, #ec4899 0%, #f472b6 100%);
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
            min-height: 4px;
        }

        .bar-label {
            font-size: 0.7rem;
            color: #64748b;
        }

        .bar-value {
            font-size: 0.75rem;
            color: #94a3b8;
            position: absolute;
            top: -20px;
        }

        /* Heatmap */
        .heatmap {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }

        .heatmap-cell.level-1 { background: rgba(236, 72, 153, 0.2); }
        .heatmap-cell.level-2 { background: rgba(236, 72, 153, 0.4); }
        .heatmap-cell.level-3 { background: rgba(236, 72, 153, 0.6); }
        .heatmap-cell.level-4 { background: rgba(236, 72, 153, 0.8); }
        .heatmap-cell.level-5 { background: #ec4899; }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
            margin-top: 12px;
            font-size: 0.7rem;
            color: #64748b;
        }

        .heatmap-legend-cell {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-card-value {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #f472b6 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 4px;
        }

        /* Light Theme */
        body.light-theme {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
            color: #1e293b;
        }

        body.light-theme h1 {
            background: linear-gradient(135deg, #db2777 0%, #9333ea 50%, #6366f1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        body.light-theme .user-tab {
            background: rgba(0, 0, 0, 0.05);
            color: #64748b;
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .user-tab:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .user-tab.active {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
        }

        body.light-theme .global-progress,
        body.light-theme .calendar-section,
        body.light-theme .habits-section,
        body.light-theme .user-progress-card {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .global-progress h3,
        body.light-theme .progress-text {
            color: #64748b;
        }

        body.light-theme .calendar-header h2,
        body.light-theme .habits-header h2 {
            color: #1e293b;
        }

        body.light-theme .calendar-nav button {
            background: rgba(0, 0, 0, 0.05);
            color: #1e293b;
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .calendar-nav button:hover {
            background: rgba(236, 72, 153, 0.1);
        }

        body.light-theme .calendar-day {
            color: #475569;
        }

        body.light-theme .calendar-day:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        body.light-theme .calendar-day.has-activity {
            background: rgba(236, 72, 153, 0.15);
        }

        body.light-theme .habit-item {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.05);
        }

        body.light-theme .habit-item:hover {
            background: rgba(0, 0, 0, 0.06);
            border-color: rgba(236, 72, 153, 0.2);
        }

        body.light-theme .habit-name {
            color: #1e293b;
        }

        body.light-theme .habit-checkbox {
            border-color: #94a3b8;
        }

        body.light-theme .numeric-input {
            background: rgba(255, 255, 255, 0.8);
            border-color: #94a3b8;
            color: #1e293b;
        }

        body.light-theme .add-habit-btn {
            border-color: #94a3b8;
            color: #64748b;
        }

        body.light-theme .add-habit-btn:hover {
            border-color: #ec4899;
            color: #ec4899;
            background: rgba(236, 72, 153, 0.1);
        }

        body.light-theme .add-habit-form {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .form-group input,
        body.light-theme .form-group select {
            background: rgba(255, 255, 255, 0.8);
            border-color: #94a3b8;
            color: #1e293b;
        }

        body.light-theme .form-group select option {
            background: white;
            color: #1e293b;
        }

        body.light-theme .motivation {
            color: #64748b;
        }

        body.light-theme .icon-btn {
            background: rgba(0, 0, 0, 0.05);
            color: #64748b;
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .icon-btn:hover {
            background: rgba(236, 72, 153, 0.1);
            color: #ec4899;
        }

        body.light-theme .settings-modal,
        body.light-theme .analytics-modal,
        body.light-theme .habit-detail-modal {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        body.light-theme .settings-section,
        body.light-theme .chart-container,
        body.light-theme .stat-card,
        body.light-theme .habit-stat {
            background: rgba(0, 0, 0, 0.03);
        }

        body.light-theme .settings-title,
        body.light-theme .analytics-title,
        body.light-theme .habit-detail-title {
            color: #1e293b;
        }

        body.light-theme .settings-row label {
            color: #1e293b;
        }

        body.light-theme .toggle-switch {
            background: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .analytics-tab {
            background: rgba(0, 0, 0, 0.05);
            color: #64748b;
        }

        body.light-theme .analytics-tab:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        body.light-theme .pause-banner {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.15) 100%);
        }

        body.light-theme .habit-calendar-day {
            background: rgba(0, 0, 0, 0.03);
            color: #64748b;
        }

        body.light-theme .habit-calendar-day.missed {
            background: rgba(0, 0, 0, 0.05);
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Habit Tracker</h1>
            <div class="user-tabs">
                <button class="user-tab active" data-user="all">–í—Å–µ</button>
                <button class="user-tab" data-user="A">–î–∏–º–æ—á–∫–∞ ü¶ä</button>
                <button class="user-tab" data-user="B">–î–∞—à–µ–Ω—å–∫–∞ ü¶ã</button>
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="analyticsBtn" title="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞">üìä</button>
                <button class="icon-btn" id="themeToggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåô</button>
                <button class="icon-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
            </div>
        </header>

        <!-- Pause Mode Banner -->
        <div class="pause-banner" id="pauseBanner">
            <div class="pause-banner-icon">üèñÔ∏è</div>
            <div class="pause-banner-text">
                <h4>–†–µ–∂–∏–º –æ—Ç–ø—É—Å–∫–∞</h4>
                <p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–µ–∫ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –û—Ç–¥—ã—Ö–∞–π!</p>
            </div>
            <button class="pause-banner-end" id="endPauseBtn">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>

        <div class="global-progress">
            <h3>–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="globalProgressFill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="globalProgressText">0%</div>
        </div>

        <div class="main-content">
            <div class="calendar-section">
                <div class="calendar-header">
                    <h2 id="calendarTitle">–Ø–Ω–≤–∞—Ä—å 2026</h2>
                    <div class="calendar-nav">
                        <button id="prevMonth">‚Üê</button>
                        <button id="nextMonth">‚Üí</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>

            <div class="habits-section">
                <div class="habits-header">
                    <h2>–ü—Ä–∏–≤—ã—á–∫–∏</h2>
                    <span class="selected-date" id="selectedDateText">–°–µ–≥–æ–¥–Ω—è</span>
                </div>
                
                <div class="category-filter" id="categoryFilter"></div>
                
                <div class="habits-list" id="habitsList"></div>
                
                <button class="add-habit-btn" id="addHabitBtn">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</button>
                
                <div class="add-habit-form" id="addHabitForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" id="habitName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–µ–¥–∏—Ç–∞—Ü–∏—è">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>–¢–∏–ø</label>
                            <select id="habitType">
                                <option value="binary">–î–∞/–ù–µ—Ç</option>
                                <option value="numeric">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>
                            </select>
                        </div>
                        <div class="form-group" id="goalGroup" style="display: none;">
                            <label>–¶–µ–ª—å</label>
                            <input type="number" id="habitGoal" placeholder="10" min="1">
                        </div>
                        <div class="form-group" id="goalTypeGroup" style="display: none;">
                            <label>–ü–µ—Ä–∏–æ–¥ —Ü–µ–ª–∏</label>
                            <select id="habitGoalType">
                                <option value="daily">–í –¥–µ–Ω—å</option>
                                <option value="week">–í –Ω–µ–¥–µ–ª—é</option>
                                <option value="month">–í –º–µ—Å—è—Ü</option>
                                <option value="quarter">–í –∫–≤–∞—Ä—Ç–∞–ª</option>
                                <option value="year">–í –≥–æ–¥</option>
                                <option value="custom">–°–≤–æ–π –ø–µ—Ä–∏–æ–¥</option>
                            </select>
                        </div>
                        <div class="form-group" id="customPeriodGroup" style="display: none;">
                            <label>–î–Ω–µ–π –≤ –ø–µ—Ä–∏–æ–¥–µ</label>
                            <input type="number" id="habitCustomPeriod" placeholder="50" min="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>–ü–µ—Ä–∏–æ–¥</label>
                            <select id="habitPeriod">
                                <option value="week">–ù–µ–¥–µ–ª—è</option>
                                <option value="month">–ú–µ—Å—è—Ü</option>
                                <option value="all">–í—Å—ë –≤—Ä–µ–º—è</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>–í–ª–∞–¥–µ–ª–µ—Ü</label>
                            <select id="habitOwner">
                                <option value="shared">–û–±—â–∞—è</option>
                                <option value="A">–î–∏–º–æ—á–∫–∞ ü¶ä</option>
                                <option value="B">–î–∞—à–µ–Ω—å–∫–∞ ü¶ã</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>–û–±—â–∞—è —Ü–µ–ª—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <input type="number" id="habitTarget" placeholder="100 –º–µ–¥–∏—Ç–∞—Ü–∏–π –∑–∞ –≥–æ–¥" min="1">
                        </div>
                        <div class="form-group">
                            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <input type="text" id="habitCategory" placeholder="–ó–¥–æ—Ä–æ–≤—å–µ, –°–ø–æ—Ä—Ç..." list="categoryList">
                            <datalist id="categoryList"></datalist>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" id="cancelHabit">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" id="saveHabit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="user-progress">
            <div class="user-progress-card">
                <h3><span class="dot user-a"></span>–î–∏–º–æ—á–∫–∞ ü¶ä</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="userAProgress" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="userAProgressText">0%</div>
            </div>
            <div class="user-progress-card">
                <h3><span class="dot user-b"></span>–î–∞—à–µ–Ω—å–∫–∞ ü¶ã</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="userBProgress" style="width: 0%; background: linear-gradient(90deg, #a855f7 0%, #c084fc 100%);"></div>
                </div>
                <div class="progress-text" id="userBProgressText">0%</div>
            </div>
        </div>

        <div class="motivation" id="motivation">
            –õ—É—á—à–µ –Ω–µ–º–Ω–æ–≥–æ, —á–µ–º –∏–¥–µ–∞–ª—å–Ω–æ. –ö–∞–∂–¥—ã–π —à–∞–≥ ‚Äî —ç—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å.
        </div>
    </div>

    <!-- Habit Detail Modal -->
    <div class="habit-detail-overlay" id="habitDetailOverlay">
        <div class="habit-detail-modal">
            <div class="habit-detail-header">
                <div class="habit-detail-title" id="habitDetailTitle">–ü—Ä–∏–≤—ã—á–∫–∞</div>
                <button class="habit-detail-close" id="habitDetailClose">√ó</button>
            </div>
            <div class="habit-detail-stats" id="habitDetailStats"></div>
            <div class="habit-detail-calendar">
                <div class="habit-detail-calendar-header">
                    <button class="habit-detail-nav" id="habitDetailPrevMonth">‚Üê</button>
                    <h4 id="habitDetailCalendarTitle">–Ø–Ω–≤–∞—Ä—å 2026</h4>
                    <button class="habit-detail-nav" id="habitDetailNextMonth">‚Üí</button>
                </div>
                <div class="habit-calendar-grid" id="habitDetailCalendarGrid"></div>
                <div class="habit-detail-legend">
                    <div class="legend-item"><div class="legend-dot completed"></div> –í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                    <div class="legend-item"><div class="legend-dot missed"></div> –ü—Ä–æ–ø—É—â–µ–Ω–æ</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-modal">
            <div class="settings-header">
                <div class="settings-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <button class="habit-detail-close" id="settingsClose">√ó</button>
            </div>
            
            <div class="settings-section">
                <h4>üèñÔ∏è –†–µ–∂–∏–º –ø–∞—É–∑—ã</h4>
                <div class="settings-row">
                    <label>–í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –æ—Ç–ø—É—Å–∫–∞</label>
                    <div class="toggle-switch" id="pauseToggle"></div>
                </div>
                <p style="font-size: 0.8rem; color: #64748b; margin-top: 8px;">
                    –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –¥–Ω–∏ –≤ —Ä–µ–∂–∏–º–µ –ø–∞—É–∑—ã –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è –ø—Ä–æ–≤–∞–ª–æ–º
                </p>
            </div>
            
            <div class="settings-section">
                <h4>üíæ –î–∞–Ω–Ω—ã–µ</h4>
                <div class="settings-buttons">
                    <button class="btn btn-secondary" id="exportDataBtn">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
                    <button class="btn btn-secondary" id="importDataBtn">üì• –ò–º–ø–æ—Ä—Ç</button>
                    <input type="file" id="importFileInput" accept=".json" style="display: none;">
                </div>
                <p style="font-size: 0.8rem; color: #64748b; margin-top: 8px;">
                    –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                </p>
            </div>
            
            <div class="settings-section">
                <h4>üé® –í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h4>
                <div class="settings-row">
                    <label>–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</label>
                    <div class="toggle-switch" id="themeToggleSettings"></div>
                </div>
            </div>
            
            <div class="settings-section">
                <h4>üóëÔ∏è –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h4>
                <div class="settings-buttons">
                    <button class="btn btn-secondary" id="resetProgressBtn" style="color: #f87171;">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
                    <button class="btn btn-secondary" id="deleteAllBtn" style="color: #f87171;">–£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div class="analytics-overlay" id="analyticsOverlay">
        <div class="analytics-modal">
            <div class="analytics-header">
                <div class="analytics-title">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
                <button class="habit-detail-close" id="analyticsClose">√ó</button>
            </div>
            
            <div class="stats-grid" id="analyticsStats"></div>
            
            <div class="analytics-tabs">
                <button class="analytics-tab active" data-tab="weekly">–ù–µ–¥–µ–ª—è</button>
                <button class="analytics-tab" data-tab="monthly">–ú–µ—Å—è—Ü</button>
                <button class="analytics-tab" data-tab="heatmap">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞</button>
            </div>
            
            <div class="analytics-content" id="analyticsContent"></div>
        </div>
    </div>

    <script>
        // ============ DATA LAYER ============
        const STORAGE_KEY = 'habit_tracker_data';
        const SETTINGS_KEY = 'habit_tracker_settings';
        
        const defaultData = {
            habits: [],
            entries: {},
            globalXP: 0,
            pausedDays: [] // Array of date strings when pause mode was active
        };

        const defaultSettings = {
            theme: 'dark',
            pauseMode: false,
            pauseStartDate: null
        };

        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    return { ...defaultData, ...parsed };
                } catch (e) {
                    console.error('Error parsing data:', e);
                }
            }
            return { ...defaultData };
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadSettings() {
            const stored = localStorage.getItem(SETTINGS_KEY);
            if (stored) {
                try {
                    return { ...defaultSettings, ...JSON.parse(stored) };
                } catch (e) {
                    console.error('Error parsing settings:', e);
                }
            }
            return { ...defaultSettings };
        }

        function saveSettings(settings) {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // ============ STATE ============
        let data = loadData();
        let settings = loadSettings();
        let selectedDate = new Date();
        let currentMonth = new Date();
        let userFilter = 'all';
        let categoryFilter = 'all';
        let currentAnalyticsTab = 'weekly';

        // ============ UTILS ============
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDisplayDate(date) {
            const options = { day: 'numeric', month: 'long' };
            return date.toLocaleDateString('ru-RU', options);
        }

        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        function isSameDay(d1, d2) {
            return d1.getDate() === d2.getDate() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getFullYear() === d2.getFullYear();
        }

        const monthNames = [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ];

        const weekDays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];

        // ============ CALENDAR ============
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarTitle');
            
            title.textContent = `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
            
            let html = weekDays.map(day => `<div class="calendar-weekday">${day}</div>`).join('');
            
            const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            
            // Adjust for Monday start (0 = Monday, 6 = Sunday)
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;
            
            // Empty cells before first day
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            // Days of the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
                const dateStr = formatDate(date);
                const hasActivity = data.entries[dateStr] && Object.keys(data.entries[dateStr]).length > 0;
                
                let classes = ['calendar-day'];
                if (isToday(date)) classes.push('today');
                if (isSameDay(date, selectedDate)) classes.push('selected');
                if (hasActivity) classes.push('has-activity');
                
                html += `<div class="${classes.join(' ')}" data-date="${dateStr}">${day}</div>`;
            }
            
            grid.innerHTML = html;
            
            // Add click listeners
            grid.querySelectorAll('.calendar-day:not(.empty)').forEach(el => {
                el.addEventListener('click', () => {
                    const dateStr = el.dataset.date;
                    const [year, month, day] = dateStr.split('-').map(Number);
                    selectedDate = new Date(year, month - 1, day);
                    renderCalendar();
                    renderHabits();
                    updateSelectedDateText();
                });
            });
        }

        function updateSelectedDateText() {
            const el = document.getElementById('selectedDateText');
            if (isToday(selectedDate)) {
                el.textContent = '–°–µ–≥–æ–¥–Ω—è';
            } else {
                el.textContent = formatDisplayDate(selectedDate);
            }
        }

        // ============ CATEGORIES ============
        function getCategories() {
            const cats = new Set();
            data.habits.forEach(h => {
                if (h.category) cats.add(h.category);
            });
            return Array.from(cats).sort();
        }

        function renderCategoryFilter() {
            const container = document.getElementById('categoryFilter');
            const categories = getCategories();
            
            if (categories.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = `<div class="category-chip ${categoryFilter === 'all' ? 'active' : ''}" data-category="all">–í—Å–µ</div>`;
            categories.forEach(cat => {
                html += `<div class="category-chip ${categoryFilter === cat ? 'active' : ''}" data-category="${cat}">${cat}</div>`;
            });
            
            container.innerHTML = html;
            
            container.querySelectorAll('.category-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    categoryFilter = chip.dataset.category;
                    renderCategoryFilter();
                    renderHabits();
                });
            });
        }

        function updateCategoryDatalist() {
            const datalist = document.getElementById('categoryList');
            const categories = getCategories();
            datalist.innerHTML = categories.map(c => `<option value="${c}">`).join('');
        }

        // ============ HABITS ============
        function renderHabits() {
            const list = document.getElementById('habitsList');
            const dateStr = formatDate(selectedDate);
            const dayEntries = data.entries[dateStr] || {};
            
            // Filter habits by user
            let habits = data.habits;
            if (userFilter !== 'all') {
                habits = habits.filter(h => h.owner === userFilter || h.owner === 'shared');
            }
            
            // Filter by category
            if (categoryFilter !== 'all') {
                habits = habits.filter(h => h.category === categoryFilter);
            }
            
            if (habits.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <p>–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫</p>
                        <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É!</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = habits.map(habit => {
                const value = dayEntries[habit.id];
                const progress = calculateHabitProgress(habit);
                const ownerClass = `owner-${habit.owner}`;
                const ownerNames = { A: '–î–∏–º–æ—á–∫–∞ ü¶ä', B: '–î–∞—à–µ–Ω—å–∫–∞ ü¶ã', shared: '–û–±—â–∞—è üíï' };
                const ownerLabel = ownerNames[habit.owner] || habit.owner;
                const categoryHtml = habit.category ? `<span class="category-badge">${habit.category}</span>` : '';
                
                const actionsHtml = `
                    <div class="habit-actions">
                        <button class="habit-action-btn" onclick="editHabit('${habit.id}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
                        <button class="habit-action-btn delete" onclick="deleteHabit('${habit.id}')" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                    </div>
                `;

                if (habit.type === 'binary') {
                    const checked = value === true;
                    const totalCount = countTotalCompletions(habit);
                    const targetHtml = habit.target ? `
                        <div class="target-progress">
                            <span>${totalCount}/${habit.target}</span>
                            <div class="target-progress-bar">
                                <div class="target-progress-fill" style="width: ${Math.min((totalCount / habit.target) * 100, 100)}%"></div>
                            </div>
                        </div>
                    ` : '';
                    return `
                        <div class="habit-item" data-habit-id="${habit.id}" draggable="true">
                            <div class="habit-drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏">‚ãÆ‚ãÆ</div>
                            <div class="habit-checkbox ${checked ? 'checked' : ''}" onclick="toggleBinaryHabit('${habit.id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                            <div class="habit-info" onclick="showHabitDetail('${habit.id}')" style="cursor: pointer;">
                                <div class="habit-name">
                                    ${habit.name}
                                    <span class="habit-owner ${ownerClass}">${ownerLabel}</span>
                                    ${categoryHtml}
                                    ${targetHtml}
                                </div>
                                <div class="habit-progress">
                                    <div class="habit-progress-bar">
                                        <div class="habit-progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="habit-progress-text">${Math.round(progress)}% –∑–∞ ${getPeriodLabel(habit.period)}</div>
                                </div>
                            </div>
                            ${actionsHtml}
                        </div>
                    `;
                } else {
                    const numValue = typeof value === 'number' ? value : 0;
                    const goalStatus = checkNumericGoalCompleted(habit, numValue);
                    const inputClass = goalStatus.completed ? 'completed' : (goalStatus.incomplete ? 'incomplete' : '');
                    const goalPeriodLabel = getGoalPeriodLabel(habit.goalType, habit.customPeriod);
                    const goalLabel = habit.goal ? `/ ${habit.goal} ${goalPeriodLabel}` : '';
                    return `
                        <div class="habit-item" data-habit-id="${habit.id}" draggable="true">
                            <div class="habit-drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏">‚ãÆ‚ãÆ</div>
                            <input type="number" class="numeric-input ${inputClass}" value="${numValue}" min="0" 
                                   onchange="updateNumericHabit('${habit.id}', this.value)">
                            <div class="habit-info" onclick="showHabitDetail('${habit.id}')" style="cursor: pointer;">
                                <div class="habit-name">
                                    ${habit.name}
                                    ${goalLabel ? `<span class="numeric-goal">${goalLabel}</span>` : ''}
                                    <span class="habit-owner ${ownerClass}">${ownerLabel}</span>
                                    ${categoryHtml}
                                </div>
                                <div class="habit-progress">
                                    <div class="habit-progress-bar">
                                        <div class="habit-progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="habit-progress-text">${Math.round(progress)}% –∑–∞ ${getPeriodLabel(habit.period)}</div>
                                </div>
                            </div>
                            ${actionsHtml}
                        </div>
                    `;
                }
            }).join('');
            
            // Setup drag and drop
            setupDragAndDrop();
        }
        
        // ============ DRAG AND DROP ============
        let draggedHabit = null;
        
        function setupDragAndDrop() {
            const items = document.querySelectorAll('.habit-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedHabit = item;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    document.querySelectorAll('.habit-item').forEach(i => i.classList.remove('drag-over'));
                    draggedHabit = null;
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedHabit && draggedHabit !== item) {
                        item.classList.add('drag-over');
                    }
                });
                
                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over');
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    
                    if (draggedHabit && draggedHabit !== item) {
                        const draggedId = draggedHabit.dataset.habitId;
                        const targetId = item.dataset.habitId;
                        
                        const draggedIndex = data.habits.findIndex(h => h.id === draggedId);
                        const targetIndex = data.habits.findIndex(h => h.id === targetId);
                        
                        if (draggedIndex !== -1 && targetIndex !== -1) {
                            const [removed] = data.habits.splice(draggedIndex, 1);
                            data.habits.splice(targetIndex, 0, removed);
                            saveData(data);
                            renderHabits();
                        }
                    }
                });
            });
        }

        function getPeriodLabel(period) {
            switch (period) {
                case 'week': return '–Ω–µ–¥–µ–ª—é';
                case 'month': return '–º–µ—Å—è—Ü';
                case 'all': return '–≤—Å—ë –≤—Ä–µ–º—è';
                default: return period;
            }
        }

        function getGoalPeriodLabel(goalType, customPeriod) {
            switch (goalType) {
                case 'daily': return '–≤ –¥–µ–Ω—å';
                case 'week': return '–≤ –Ω–µ–¥–µ–ª—é';
                case 'month': return '–≤ –º–µ—Å—è—Ü';
                case 'quarter': return '–≤ –∫–≤–∞—Ä—Ç–∞–ª';
                case 'year': return '–≤ –≥–æ–¥';
                case 'custom': return customPeriod ? `–∑–∞ ${customPeriod} –¥–Ω.` : '';
                default: return '';
            }
        }

        function getGoalPeriodDays(goalType, customPeriod) {
            switch (goalType) {
                case 'daily': return 1;
                case 'week': return 7;
                case 'month': return 30;
                case 'quarter': return 90;
                case 'year': return 365;
                case 'custom': return customPeriod || 1;
                default: return 1;
            }
        }

        function checkNumericGoalCompleted(habit, numValue) {
            const goalType = habit.goalType || 'daily';
            const goal = habit.goal || 0;
            if (!goal) return { completed: false, incomplete: false };
            
            const periodDays = getGoalPeriodDays(goalType, habit.customPeriod);
            
            if (periodDays === 1) {
                // Daily goal - check today's value
                return {
                    completed: numValue >= goal,
                    incomplete: numValue > 0 && numValue < goal
                };
            } else {
                // Period goal - check sum over the period
                const now = new Date();
                let sum = 0;
                for (let i = 0; i < periodDays; i++) {
                    const date = new Date(now);
                    date.setDate(now.getDate() - i);
                    const dateStr = formatDate(date);
                    const entry = data.entries[dateStr]?.[habit.id];
                    if (typeof entry === 'number') sum += entry;
                }
                return {
                    completed: sum >= goal,
                    incomplete: sum > 0 && sum < goal
                };
            }
        }

        function countTotalCompletions(habit) {
            let count = 0;
            Object.keys(data.entries).forEach(dateStr => {
                const entry = data.entries[dateStr][habit.id];
                if (habit.type === 'binary') {
                    if (entry === true) count++;
                } else {
                    if (typeof entry === 'number') count += entry;
                }
            });
            return count;
        }

        function toggleBinaryHabit(habitId) {
            const dateStr = formatDate(selectedDate);
            if (!data.entries[dateStr]) {
                data.entries[dateStr] = {};
            }
            
            const current = data.entries[dateStr][habitId];
            data.entries[dateStr][habitId] = !current;
            
            saveData(data);
            renderHabits();
            renderCalendar();
            updateProgressBars();
        }

        function updateNumericHabit(habitId, value) {
            const dateStr = formatDate(selectedDate);
            if (!data.entries[dateStr]) {
                data.entries[dateStr] = {};
            }
            
            const numValue = parseInt(value) || 0;
            if (numValue > 0) {
                data.entries[dateStr][habitId] = numValue;
            } else {
                delete data.entries[dateStr][habitId];
            }
            
            saveData(data);
            renderCalendar();
            renderHabits();
            updateProgressBars();
        }

        // ============ HABIT DETAIL MODAL ============
        let detailMonth = new Date();
        
        function showHabitDetail(habitId) {
            const habit = data.habits.find(h => h.id === habitId);
            if (!habit) return;
            
            const overlay = document.getElementById('habitDetailOverlay');
            document.getElementById('habitDetailTitle').textContent = habit.name;
            
            // Calculate stats
            const stats = calculateHabitStats(habit);
            renderHabitStats(stats, habit);
            
            // Render calendar for this habit
            detailMonth = new Date();
            renderHabitDetailCalendar(habit);
            
            overlay.classList.add('active');
            overlay.dataset.habitId = habitId;
        }
        
        function calculateHabitStats(habit) {
            const now = new Date();
            let completedDays = 0;
            let totalDays = 0;
            let currentStreak = 0;
            let maxStreak = 0;
            let tempStreak = 0;
            
            // Go through last 90 days
            for (let i = 89; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = formatDate(date);
                
                const entry = data.entries[dateStr]?.[habit.id];
                let isDayCompleted = false;
                
                if (habit.type === 'binary') {
                    isDayCompleted = entry === true;
                } else {
                    const goalType = habit.goalType || 'daily';
                    if (goalType === 'daily' && habit.goal) {
                        isDayCompleted = (entry || 0) >= habit.goal;
                    } else {
                        isDayCompleted = (entry || 0) > 0;
                    }
                }
                
                totalDays++;
                if (isDayCompleted) {
                    completedDays++;
                    tempStreak++;
                    if (tempStreak > maxStreak) maxStreak = tempStreak;
                } else {
                    tempStreak = 0;
                }
                
                // Current streak (from today backwards)
                if (i === 0 || (i > 0 && currentStreak > 0)) {
                    if (isDayCompleted) {
                        if (i === 0 || currentStreak > 0) currentStreak++;
                    } else if (i > 0) {
                        // Don't break streak for today if not completed yet
                    }
                }
            }
            
            // Recalculate current streak from today backwards
            currentStreak = 0;
            for (let i = 0; i <= 89; i++) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = formatDate(date);
                
                const entry = data.entries[dateStr]?.[habit.id];
                let isDayCompleted = false;
                
                if (habit.type === 'binary') {
                    isDayCompleted = entry === true;
                } else {
                    const goalType = habit.goalType || 'daily';
                    if (goalType === 'daily' && habit.goal) {
                        isDayCompleted = (entry || 0) >= habit.goal;
                    } else {
                        isDayCompleted = (entry || 0) > 0;
                    }
                }
                
                if (isDayCompleted) {
                    currentStreak++;
                } else if (i > 0) {
                    break;
                }
            }
            
            return { completedDays, totalDays, currentStreak, maxStreak };
        }
        
        function renderHabitStats(stats, habit) {
            const container = document.getElementById('habitDetailStats');
            const totalCount = countTotalCompletions(habit);
            
            let targetHtml = '';
            if (habit.target) {
                const targetProgress = Math.min((totalCount / habit.target) * 100, 100);
                targetHtml = `
                    <div class="habit-stat" style="grid-column: span 3; margin-bottom: 8px;">
                        <div class="habit-stat-value">${totalCount} / ${habit.target}</div>
                        <div class="habit-stat-label">–æ–±—â–∞—è —Ü–µ–ª—å</div>
                        <div style="margin-top: 8px;">
                            <div class="progress-bar" style="height: 8px;">
                                <div class="progress-fill" style="width: ${targetProgress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = `
                ${targetHtml}
                <div class="habit-stat">
                    <div class="habit-stat-value">${stats.completedDays}</div>
                    <div class="habit-stat-label">–≤—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–Ω–µ–π</div>
                </div>
                <div class="habit-stat">
                    <div class="habit-stat-value">${stats.currentStreak}</div>
                    <div class="habit-stat-label">—Ç–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è</div>
                </div>
                <div class="habit-stat">
                    <div class="habit-stat-value">${stats.maxStreak}</div>
                    <div class="habit-stat-label">–ª—É—á—à–∞—è —Å–µ—Ä–∏—è</div>
                </div>
            `;
        }
        
        function renderHabitDetailCalendar(habit) {
            const grid = document.getElementById('habitDetailCalendarGrid');
            const title = document.getElementById('habitDetailCalendarTitle');
            const now = new Date();
            
            title.textContent = `${monthNames[detailMonth.getMonth()]} ${detailMonth.getFullYear()}`;
            
            let html = weekDays.map(day => `<div class="calendar-weekday" style="font-size: 0.65rem;">${day}</div>`).join('');
            
            const firstDay = new Date(detailMonth.getFullYear(), detailMonth.getMonth(), 1);
            const lastDay = new Date(detailMonth.getFullYear(), detailMonth.getMonth() + 1, 0);
            
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;
            
            for (let i = 0; i < startDay; i++) {
                html += '<div class="habit-calendar-day" style="background: transparent;"></div>';
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(detailMonth.getFullYear(), detailMonth.getMonth(), day);
                const dateStr = formatDate(date);
                const isFuture = date > now;
                const isTodayDate = isToday(date);
                
                const entry = data.entries[dateStr]?.[habit.id];
                let isDayCompleted = false;
                
                if (habit.type === 'binary') {
                    isDayCompleted = entry === true;
                } else {
                    const goalType = habit.goalType || 'daily';
                    if (goalType === 'daily' && habit.goal) {
                        isDayCompleted = (entry || 0) >= habit.goal;
                    } else {
                        isDayCompleted = (entry || 0) > 0;
                    }
                }
                
                let classes = ['habit-calendar-day'];
                if (isFuture) {
                    classes.push('future');
                } else if (isDayCompleted) {
                    classes.push('completed');
                } else {
                    classes.push('missed');
                }
                if (isTodayDate) classes.push('today');
                
                html += `<div class="${classes.join(' ')}">${day}</div>`;
            }
            
            grid.innerHTML = html;
        }
        
        // Close modal
        document.getElementById('habitDetailClose').addEventListener('click', () => {
            document.getElementById('habitDetailOverlay').classList.remove('active');
        });
        
        document.getElementById('habitDetailOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'habitDetailOverlay') {
                document.getElementById('habitDetailOverlay').classList.remove('active');
            }
        });
        
        // Detail calendar navigation
        document.getElementById('habitDetailPrevMonth').addEventListener('click', () => {
            const overlay = document.getElementById('habitDetailOverlay');
            const habitId = overlay.dataset.habitId;
            const habit = data.habits.find(h => h.id === habitId);
            if (habit) {
                detailMonth.setMonth(detailMonth.getMonth() - 1);
                renderHabitDetailCalendar(habit);
            }
        });
        
        document.getElementById('habitDetailNextMonth').addEventListener('click', () => {
            const overlay = document.getElementById('habitDetailOverlay');
            const habitId = overlay.dataset.habitId;
            const habit = data.habits.find(h => h.id === habitId);
            if (habit) {
                detailMonth.setMonth(detailMonth.getMonth() + 1);
                renderHabitDetailCalendar(habit);
            }
        });

        // ============ PROGRESS CALCULATION ============
        function calculateHabitProgress(habit) {
            const now = new Date();
            let startDate, endDate;
            
            switch (habit.period) {
                case 'week':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay() + 1); // Monday
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'all':
                    // Count all entries
                    startDate = new Date(2020, 0, 1);
                    endDate = now;
                    break;
            }
            
            let completed = 0;
            let total = 0;
            
            if (habit.type === 'binary') {
                // For binary: count days completed / total days
                const current = new Date(startDate);
                while (current <= endDate && current <= now) {
                    const dateStr = formatDate(current);
                    total++;
                    if (data.entries[dateStr] && data.entries[dateStr][habit.id] === true) {
                        completed++;
                    }
                    current.setDate(current.getDate() + 1);
                }
            } else {
                // For numeric: depends on goalType
                const goalType = habit.goalType || 'daily';
                const current = new Date(startDate);
                let daysCount = 0;
                
                while (current <= endDate && current <= now) {
                    const dateStr = formatDate(current);
                    if (data.entries[dateStr] && typeof data.entries[dateStr][habit.id] === 'number') {
                        completed += data.entries[dateStr][habit.id];
                    }
                    daysCount++;
                    current.setDate(current.getDate() + 1);
                }
                
                if (goalType === 'daily') {
                    // Daily goal: each day should meet the goal
                    total = daysCount * (habit.goal || 1);
                } else {
                    // Total goal: sum should meet the goal for the period
                    total = habit.goal || daysCount;
                }
            }
            
            return total > 0 ? Math.min((completed / total) * 100, 100) : 0;
        }

        function updateProgressBars() {
            // Calculate per-user progress
            const userAHabits = data.habits.filter(h => h.owner === 'A' || h.owner === 'shared');
            const userBHabits = data.habits.filter(h => h.owner === 'B' || h.owner === 'shared');
            
            const userAProgress = userAHabits.length > 0 
                ? userAHabits.reduce((sum, h) => sum + calculateHabitProgress(h), 0) / userAHabits.length 
                : 0;
            
            const userBProgress = userBHabits.length > 0 
                ? userBHabits.reduce((sum, h) => sum + calculateHabitProgress(h), 0) / userBHabits.length 
                : 0;
            
            document.getElementById('userAProgress').style.width = `${userAProgress}%`;
            document.getElementById('userAProgressText').textContent = `${Math.round(userAProgress)}%`;
            
            document.getElementById('userBProgress').style.width = `${userBProgress}%`;
            document.getElementById('userBProgressText').textContent = `${Math.round(userBProgress)}%`;
            
            // Global progress (average of both users)
            const globalProgress = (userAProgress + userBProgress) / 2;
            document.getElementById('globalProgressFill').style.width = `${globalProgress}%`;
            document.getElementById('globalProgressText').textContent = `${Math.round(globalProgress)}%`;
        }

        // ============ ADD/EDIT HABIT FORM ============
        const addHabitBtn = document.getElementById('addHabitBtn');
        const addHabitForm = document.getElementById('addHabitForm');
        const habitTypeSelect = document.getElementById('habitType');
        const goalGroup = document.getElementById('goalGroup');
        const goalTypeGroup = document.getElementById('goalTypeGroup');
        const cancelHabitBtn = document.getElementById('cancelHabit');
        const saveHabitBtn = document.getElementById('saveHabit');
        
        let editingHabitId = null; // null = creating new, string = editing existing

        addHabitBtn.addEventListener('click', () => {
            editingHabitId = null;
            addHabitForm.classList.add('active');
            addHabitBtn.style.display = 'none';
        });

        cancelHabitBtn.addEventListener('click', () => {
            addHabitForm.classList.remove('active');
            addHabitBtn.style.display = 'block';
            clearForm();
        });

        const customPeriodGroup = document.getElementById('customPeriodGroup');
        const goalTypeSelect = document.getElementById('habitGoalType');

        habitTypeSelect.addEventListener('change', () => {
            const isNumeric = habitTypeSelect.value === 'numeric';
            goalGroup.style.display = isNumeric ? 'block' : 'none';
            goalTypeGroup.style.display = isNumeric ? 'block' : 'none';
            if (!isNumeric) {
                customPeriodGroup.style.display = 'none';
            }
        });

        goalTypeSelect.addEventListener('change', () => {
            customPeriodGroup.style.display = goalTypeSelect.value === 'custom' ? 'block' : 'none';
        });

        saveHabitBtn.addEventListener('click', () => {
            const name = document.getElementById('habitName').value.trim();
            const type = document.getElementById('habitType').value;
            const period = document.getElementById('habitPeriod').value;
            const owner = document.getElementById('habitOwner').value;
            const goal = parseInt(document.getElementById('habitGoal').value) || null;
            const goalType = document.getElementById('habitGoalType').value;
            const customPeriod = parseInt(document.getElementById('habitCustomPeriod').value) || null;
            const target = parseInt(document.getElementById('habitTarget').value) || null;
            const category = document.getElementById('habitCategory').value.trim() || null;
            
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏');
                return;
            }
            
            if (editingHabitId) {
                // Edit existing habit
                const habitIndex = data.habits.findIndex(h => h.id === editingHabitId);
                if (habitIndex !== -1) {
                    data.habits[habitIndex] = {
                        ...data.habits[habitIndex],
                        name,
                        type,
                        period,
                        owner,
                        goal: type === 'numeric' ? goal : null,
                        goalType: type === 'numeric' ? goalType : null,
                        customPeriod: type === 'numeric' && goalType === 'custom' ? customPeriod : null,
                        target,
                        category
                    };
                }
            } else {
                // Create new habit
                const habit = {
                    id: generateId(),
                    name,
                    type,
                    period,
                    owner,
                    goal: type === 'numeric' ? goal : null,
                    goalType: type === 'numeric' ? goalType : null,
                    customPeriod: type === 'numeric' && goalType === 'custom' ? customPeriod : null,
                    target,
                    category
                };
                data.habits.push(habit);
            }
            
            saveData(data);
            
            addHabitForm.classList.remove('active');
            addHabitBtn.style.display = 'block';
            clearForm();
            
            renderHabits();
            renderCategoryFilter();
            updateCategoryDatalist();
            updateProgressBars();
        });

        function editHabit(habitId) {
            const habit = data.habits.find(h => h.id === habitId);
            if (!habit) return;
            
            editingHabitId = habitId;
            
            document.getElementById('habitName').value = habit.name;
            document.getElementById('habitType').value = habit.type;
            document.getElementById('habitPeriod').value = habit.period;
            document.getElementById('habitOwner').value = habit.owner;
            document.getElementById('habitGoal').value = habit.goal || '';
            document.getElementById('habitGoalType').value = habit.goalType || 'daily';
            document.getElementById('habitCustomPeriod').value = habit.customPeriod || '';
            document.getElementById('habitTarget').value = habit.target || '';
            document.getElementById('habitCategory').value = habit.category || '';
            
            const isNumeric = habit.type === 'numeric';
            goalGroup.style.display = isNumeric ? 'block' : 'none';
            goalTypeGroup.style.display = isNumeric ? 'block' : 'none';
            customPeriodGroup.style.display = isNumeric && habit.goalType === 'custom' ? 'block' : 'none';
            
            addHabitForm.classList.add('active');
            addHabitBtn.style.display = 'none';
        }

        function deleteHabit(habitId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É?')) return;
            
            data.habits = data.habits.filter(h => h.id !== habitId);
            
            // Also clean up entries for this habit
            Object.keys(data.entries).forEach(dateStr => {
                if (data.entries[dateStr][habitId] !== undefined) {
                    delete data.entries[dateStr][habitId];
                }
            });
            
            saveData(data);
            renderHabits();
            renderCalendar();
            updateProgressBars();
        }

        function clearForm() {
            editingHabitId = null;
            document.getElementById('habitName').value = '';
            document.getElementById('habitType').value = 'binary';
            document.getElementById('habitPeriod').value = 'week';
            document.getElementById('habitOwner').value = 'shared';
            document.getElementById('habitGoal').value = '';
            document.getElementById('habitGoalType').value = 'daily';
            document.getElementById('habitCustomPeriod').value = '';
            document.getElementById('habitTarget').value = '';
            document.getElementById('habitCategory').value = '';
            goalGroup.style.display = 'none';
            goalTypeGroup.style.display = 'none';
            customPeriodGroup.style.display = 'none';
        }

        // ============ USER FILTER ============
        document.querySelectorAll('.user-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.user-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                userFilter = tab.dataset.user;
                renderHabits();
            });
        });

        // ============ CALENDAR NAVIGATION ============
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        });

        // ============ MOTIVATIONAL QUOTES ============
        const quotes = [
            '–õ—É—á—à–µ –Ω–µ–º–Ω–æ–≥–æ, —á–µ–º –∏–¥–µ–∞–ª—å–Ω–æ. –ö–∞–∂–¥—ã–π —à–∞–≥ ‚Äî —ç—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å.',
            '–ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –≤–µ–¥—É—Ç –∫ –±–æ–ª—å—à–∏–º –ø–µ—Ä–µ–º–µ–Ω–∞–º.',
            '–¢—ã —É–∂–µ –º–æ–ª–æ–¥–µ—Ü, —á—Ç–æ –æ—Ç–∫—Ä—ã–ª —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É.',
            '–ü—Ä–æ–≥—Ä–µ—Å—Å, –∞ –Ω–µ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ.',
            '–ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî –Ω–æ–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å.',
            '–ü—Ä–∏–≤—ã—á–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä.',
            '–î–µ–ª–∞–π —Ç–æ, —á—Ç–æ –º–æ–∂–µ—à—å, —Å —Ç–µ–º, —á—Ç–æ –µ—Å—Ç—å.',
            '–í–∞–∂–Ω–æ –Ω–µ —É–ø–∞—Å—Ç—å, –∞ –ø–æ–¥–Ω—è—Ç—å—Å—è.',
            '–ö–∞–∂–¥–æ–µ —É—Å–∏–ª–∏–µ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ.',
            '–¢—ã —Å–ø—Ä–∞–≤–ª—è–µ—à—å—Å—è –ª—É—á—à–µ, —á–µ–º –¥—É–º–∞–µ—à—å.',
        ];

        function updateMotivation() {
            const el = document.getElementById('motivation');
            el.textContent = quotes[Math.floor(Math.random() * quotes.length)];
        }

        // ============ THEME ============
        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('light-theme');
                document.getElementById('themeToggle').textContent = 'üåô';
            }
            // Update meta theme-color
            document.querySelector('meta[name="theme-color"]').content = theme === 'light' ? '#f8fafc' : '#0f0f1a';
        }

        function toggleTheme() {
            settings.theme = settings.theme === 'dark' ? 'light' : 'dark';
            saveSettings(settings);
            applyTheme(settings.theme);
            updateThemeToggleUI();
        }

        function updateThemeToggleUI() {
            const toggle = document.getElementById('themeToggleSettings');
            if (settings.theme === 'light') {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        document.getElementById('themeToggleSettings').addEventListener('click', toggleTheme);

        // ============ PAUSE MODE ============
        function updatePauseModeUI() {
            const banner = document.getElementById('pauseBanner');
            const toggle = document.getElementById('pauseToggle');
            
            if (settings.pauseMode) {
                banner.classList.add('active');
                toggle.classList.add('active');
            } else {
                banner.classList.remove('active');
                toggle.classList.remove('active');
            }
        }

        function togglePauseMode() {
            settings.pauseMode = !settings.pauseMode;
            if (settings.pauseMode) {
                settings.pauseStartDate = formatDate(new Date());
            } else {
                // Mark paused days
                if (settings.pauseStartDate) {
                    const start = new Date(settings.pauseStartDate);
                    const end = new Date();
                    const current = new Date(start);
                    
                    if (!data.pausedDays) data.pausedDays = [];
                    
                    while (current <= end) {
                        const dateStr = formatDate(current);
                        if (!data.pausedDays.includes(dateStr)) {
                            data.pausedDays.push(dateStr);
                        }
                        current.setDate(current.getDate() + 1);
                    }
                    saveData(data);
                }
                settings.pauseStartDate = null;
            }
            saveSettings(settings);
            updatePauseModeUI();
        }

        document.getElementById('pauseToggle').addEventListener('click', togglePauseMode);
        document.getElementById('endPauseBtn').addEventListener('click', togglePauseMode);

        // ============ SETTINGS MODAL ============
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settingsOverlay').classList.add('active');
            updateThemeToggleUI();
            updatePauseModeUI();
        });

        document.getElementById('settingsClose').addEventListener('click', () => {
            document.getElementById('settingsOverlay').classList.remove('active');
        });

        document.getElementById('settingsOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'settingsOverlay') {
                document.getElementById('settingsOverlay').classList.remove('active');
            }
        });

        // ============ EXPORT / IMPORT ============
        document.getElementById('exportDataBtn').addEventListener('click', () => {
            const exportData = {
                habits: data.habits,
                entries: data.entries,
                pausedDays: data.pausedDays || [],
                settings: settings,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habit-tracker-backup-${formatDate(new Date())}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById('importDataBtn').addEventListener('click', () => {
            document.getElementById('importFileInput').click();
        });

        document.getElementById('importFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    if (importedData.habits && importedData.entries) {
                        if (confirm('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.')) {
                            data.habits = importedData.habits || [];
                            data.entries = importedData.entries || {};
                            data.pausedDays = importedData.pausedDays || [];
                            saveData(data);
                            
                            if (importedData.settings) {
                                settings = { ...defaultSettings, ...importedData.settings };
                                saveSettings(settings);
                                applyTheme(settings.theme);
                            }
                            
                            renderCalendar();
                            renderHabits();
                            renderCategoryFilter();
                            updateProgressBars();
                            updatePauseModeUI();
                            
                            alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
                        }
                    } else {
                        alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    }
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // Reset input
        });

        // ============ DANGER ZONE ============
        document.getElementById('resetProgressBtn').addEventListener('click', () => {
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å? –ü—Ä–∏–≤—ã—á–∫–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è, –Ω–æ –≤—Å–µ –æ—Ç–º–µ—Ç–∫–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
                data.entries = {};
                data.pausedDays = [];
                saveData(data);
                renderCalendar();
                renderHabits();
                updateProgressBars();
                alert('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω');
            }
        });

        document.getElementById('deleteAllBtn').addEventListener('click', () => {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –ø—Ä–∏–≤—ã—á–∫–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞.')) {
                    data = { ...defaultData };
                    saveData(data);
                    renderCalendar();
                    renderHabits();
                    renderCategoryFilter();
                    updateProgressBars();
                    alert('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');
                }
            }
        });

        // ============ ANALYTICS ============
        document.getElementById('analyticsBtn').addEventListener('click', () => {
            document.getElementById('analyticsOverlay').classList.add('active');
            renderAnalytics();
        });

        document.getElementById('analyticsClose').addEventListener('click', () => {
            document.getElementById('analyticsOverlay').classList.remove('active');
        });

        document.getElementById('analyticsOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'analyticsOverlay') {
                document.getElementById('analyticsOverlay').classList.remove('active');
            }
        });

        document.querySelectorAll('.analytics-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.analytics-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentAnalyticsTab = tab.dataset.tab;
                renderAnalyticsContent();
            });
        });

        function renderAnalytics() {
            renderAnalyticsStats();
            renderAnalyticsContent();
        }

        function renderAnalyticsStats() {
            const container = document.getElementById('analyticsStats');
            const now = new Date();
            
            // Calculate overall stats
            let totalCompletions = 0;
            let totalDays = 0;
            let activeDays = new Set();
            let longestStreak = 0;
            let currentStreak = 0;
            
            // Count total completions across all habits
            Object.keys(data.entries).forEach(dateStr => {
                const dayData = data.entries[dateStr];
                let dayHasActivity = false;
                Object.keys(dayData).forEach(habitId => {
                    const value = dayData[habitId];
                    if (value === true || (typeof value === 'number' && value > 0)) {
                        totalCompletions++;
                        dayHasActivity = true;
                    }
                });
                if (dayHasActivity) {
                    activeDays.add(dateStr);
                }
            });
            
            // Calculate current streak (days in a row with at least one completion)
            for (let i = 0; i <= 365; i++) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = formatDate(date);
                
                if (activeDays.has(dateStr)) {
                    currentStreak++;
                } else if (i > 0) {
                    break;
                }
            }
            
            // Calculate longest streak
            const sortedDates = Array.from(activeDays).sort();
            let tempStreak = 0;
            let prevDate = null;
            
            sortedDates.forEach(dateStr => {
                const date = new Date(dateStr);
                if (prevDate) {
                    const diff = (date - prevDate) / (1000 * 60 * 60 * 24);
                    if (diff === 1) {
                        tempStreak++;
                    } else {
                        tempStreak = 1;
                    }
                } else {
                    tempStreak = 1;
                }
                if (tempStreak > longestStreak) longestStreak = tempStreak;
                prevDate = date;
            });
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-card-value">${data.habits.length}</div>
                    <div class="stat-card-label">–ø—Ä–∏–≤—ã—á–µ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value">${totalCompletions}</div>
                    <div class="stat-card-label">–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value">${activeDays.size}</div>
                    <div class="stat-card-label">–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value">${currentStreak}</div>
                    <div class="stat-card-label">—Ç–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value">${longestStreak}</div>
                    <div class="stat-card-label">–ª—É—á—à–∞—è —Å–µ—Ä–∏—è</div>
                </div>
            `;
        }

        function renderAnalyticsContent() {
            const container = document.getElementById('analyticsContent');
            
            switch (currentAnalyticsTab) {
                case 'weekly':
                    renderWeeklyChart(container);
                    break;
                case 'monthly':
                    renderMonthlyChart(container);
                    break;
                case 'heatmap':
                    renderHeatmap(container);
                    break;
            }
        }

        function renderWeeklyChart(container) {
            const now = new Date();
            const weekDaysShort = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            
            // Get data for last 7 days
            const weekData = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = formatDate(date);
                
                let completions = 0;
                if (data.entries[dateStr]) {
                    Object.values(data.entries[dateStr]).forEach(value => {
                        if (value === true || (typeof value === 'number' && value > 0)) {
                            completions++;
                        }
                    });
                }
                
                const dayOfWeek = date.getDay();
                const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                
                weekData.push({
                    label: weekDaysShort[adjustedDay],
                    value: completions,
                    date: dateStr
                });
            }
            
            const maxValue = Math.max(...weekData.map(d => d.value), 1);
            
            container.innerHTML = `
                <div class="chart-container">
                    <div class="chart-title">–í—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>
                    <div class="bar-chart">
                        ${weekData.map(d => `
                            <div class="bar-item">
                                <div class="bar" style="height: ${(d.value / maxValue) * 120}px"></div>
                                <div class="bar-label">${d.label}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">–î–µ—Ç–∞–ª–∏ –ø–æ –¥–Ω—è–º</div>
                    ${weekData.map(d => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <span style="color: #94a3b8;">${d.label} (${d.date.split('-').slice(1).join('.')})</span>
                            <span style="color: #f472b6; font-weight: 600;">${d.value} –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderMonthlyChart(container) {
            const now = new Date();
            
            // Get data for last 4 weeks
            const weekData = [];
            for (let week = 3; week >= 0; week--) {
                let weekTotal = 0;
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - (week * 7 + 6));
                const weekEnd = new Date(now);
                weekEnd.setDate(now.getDate() - (week * 7));
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    const dateStr = formatDate(date);
                    
                    if (data.entries[dateStr]) {
                        Object.values(data.entries[dateStr]).forEach(value => {
                            if (value === true || (typeof value === 'number' && value > 0)) {
                                weekTotal++;
                            }
                        });
                    }
                }
                
                weekData.push({
                    label: `–ù–µ–¥–µ–ª—è ${4 - week}`,
                    value: weekTotal,
                    range: `${weekStart.getDate()}.${weekStart.getMonth()+1} - ${weekEnd.getDate()}.${weekEnd.getMonth()+1}`
                });
            }
            
            const maxValue = Math.max(...weekData.map(d => d.value), 1);
            
            container.innerHTML = `
                <div class="chart-container">
                    <div class="chart-title">–í—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 –Ω–µ–¥–µ–ª–∏</div>
                    <div class="bar-chart">
                        ${weekData.map(d => `
                            <div class="bar-item">
                                <div class="bar" style="height: ${(d.value / maxValue) * 120}px"></div>
                                <div class="bar-label">${d.label}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">–ü–æ –ø—Ä–∏–≤—ã—á–∫–∞–º (–∑–∞ –º–µ—Å—è—Ü)</div>
                    ${data.habits.map(habit => {
                        let count = 0;
                        for (let i = 0; i < 30; i++) {
                            const date = new Date(now);
                            date.setDate(now.getDate() - i);
                            const dateStr = formatDate(date);
                            const entry = data.entries[dateStr]?.[habit.id];
                            if (entry === true || (typeof entry === 'number' && entry > 0)) {
                                count++;
                            }
                        }
                        const percentage = Math.round((count / 30) * 100);
                        return `
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="color: #e2e8f0;">${habit.name}</span>
                                    <span style="color: #94a3b8;">${count}/30 –¥–Ω–µ–π (${percentage}%)</span>
                                </div>
                                <div class="progress-bar" style="height: 6px;">
                                    <div class="progress-fill" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderHeatmap(container) {
            const now = new Date();
            const weeks = 12; // 12 weeks of data
            
            // Generate heatmap data
            const heatmapData = [];
            for (let i = weeks * 7 - 1; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = formatDate(date);
                
                let completions = 0;
                if (data.entries[dateStr]) {
                    Object.values(data.entries[dateStr]).forEach(value => {
                        if (value === true || (typeof value === 'number' && value > 0)) {
                            completions++;
                        }
                    });
                }
                
                heatmapData.push({
                    date: dateStr,
                    value: completions
                });
            }
            
            const maxValue = Math.max(...heatmapData.map(d => d.value), 1);
            
            function getLevel(value) {
                if (value === 0) return 0;
                const ratio = value / maxValue;
                if (ratio <= 0.2) return 1;
                if (ratio <= 0.4) return 2;
                if (ratio <= 0.6) return 3;
                if (ratio <= 0.8) return 4;
                return 5;
            }
            
            container.innerHTML = `
                <div class="chart-container">
                    <div class="chart-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ ${weeks} –Ω–µ–¥–µ–ª—å</div>
                    <div class="heatmap">
                        ${heatmapData.map(d => `
                            <div class="heatmap-cell level-${getLevel(d.value)}" title="${d.date}: ${d.value} –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π"></div>
                        `).join('')}
                    </div>
                    <div class="heatmap-legend">
                        <span>–ú–µ–Ω—å—à–µ</span>
                        <div class="heatmap-legend-cell" style="background: rgba(255,255,255,0.05);"></div>
                        <div class="heatmap-legend-cell level-1" style="background: rgba(236, 72, 153, 0.2);"></div>
                        <div class="heatmap-legend-cell level-2" style="background: rgba(236, 72, 153, 0.4);"></div>
                        <div class="heatmap-legend-cell level-3" style="background: rgba(236, 72, 153, 0.6);"></div>
                        <div class="heatmap-legend-cell level-4" style="background: rgba(236, 72, 153, 0.8);"></div>
                        <div class="heatmap-legend-cell level-5" style="background: #ec4899;"></div>
                        <span>–ë–æ–ª—å—à–µ</span>
                    </div>
                </div>
            `;
        }

        // ============ PWA / SERVICE WORKER ============
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => {
                    console.log('ServiceWorker registration failed (optional):', err);
                });
            });
        }

        // ============ INIT ============
        function init() {
            // Apply saved theme
            applyTheme(settings.theme);
            updatePauseModeUI();
            
            renderCalendar();
            renderHabits();
            renderCategoryFilter();
            updateCategoryDatalist();
            updateProgressBars();
            updateMotivation();
            updateSelectedDateText();
        }

        init();
    </script>
</body>
</html>
